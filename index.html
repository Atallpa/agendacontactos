<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8" />
  <title>Agenda de contactos</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: system-ui, sans-serif;
      max-width: 1000px;
      margin: 24px auto;
      padding: 0 12px;
    }

    h1 {
      margin-bottom: 8px;
    }

    fieldset {
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 12px;
      margin: 12px 0;
    }

    fieldset .contactsTbody {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 8px;
    }

    label {
      display: block;
      font-size: .9rem;
      margin: 6px 0 4px;
      font-weight: 600;
    }

    /* Inputs/selects */
    input {
      padding: 5px;
      font-size: 1rem;
      width: 200px;
    }

    select {
      padding: 5px;
      font-size: 1rem;
      width: 213px;
    }

    input,
    select {
      border: none;
      border-bottom: 2px solid #333;
      background: transparent;
      padding: 5px 0;
      font-size: 1rem;
      outline: none;
    }

    input,
    select {
      border-bottom: 1px solid #ccc;
    }

    input:focus,
    select:focus {
      border-bottom: 2px solid #007bff;
    }

    button {
      padding: 8px;
      font-size: 1rem;
      cursor: pointer;
      margin-right: 3px;
    }

    input::placeholder,
    select::placeholder {
      color: #999;
      opacity: 0.7;
    }

    #btnLogin {
      margin-top: 15px;
      background: #c3d8f1;
      border: 1px solid #00c3ff;
      padding: 9px;
      border-radius: 2px;
    }

    #btnLogout {
      background: #c3cff1;
      border: 1px solid #007bff;
      padding: 9px;
      border-radius: 2px;
    }

    #btnExport {
      background: #ebecdd;
      border: 1px solid #979779;
      padding: 9px;
      border-radius: 2px;
    }

    #btnImport {
      background: #f1dbc3;
      border: 1px solid #ffae00;
      padding: 9px;
      border-radius: 2px;
    }

    #btnOpenRemForm {
      background: #ecc3f1;
      border: 1px solid #ea00ff;
      padding: 9px;
      border-radius: 2px;
    }

    #btnSave {
      background: #c3f1d6;
      border: 1px solid #00ff15;
      padding: 9px;
      border-radius: 2px;
    }

    [id^="btn-edit-"] {
      background: #c3e2f1;
      border: 1px solid #00e1ff;
      padding: 9px;
      border-radius: 2px;
    }

    [id^="btn-delete-"] {
      background: #f1c3c3;
      border: 1px solid #f3623d;
      padding: 9px;
      border-radius: 2px;
    }

    #loginBox {
      position: absolute;
      /* lo sacamos del flujo normal */
      top: 50%;
      /* 50% desde arriba */
      left: 50%;
      /* 50% desde la izquierda */
      transform: translate(-50%, -50%);
      /* lo centra exactamente */

      width: 300px;
      height: auto;
      padding: 20px;
      border-radius: 8px;
      border: 1px solid #ddd;
      display: flex;
      flex-direction: column;
      gap: 10px;
      align-items: flex-start;
      /* mantiene alineados los elementos a la izquierda */
    }

    .actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      justify-content: flex-start;
      /* üëà alinea acciones a la izquierda */
    }

    #loginBox label {
      display: flex;
      align-items: center;
      justify-content: flex-start;
      /* üëà asegura que quede a la izquierda */
      gap: 6px;
      /* espacio entre checkbox y texto */
    }

    #loginBox input[type="checkbox"] {
      width: auto;
      height: auto;
      border: none;
      padding: 0;
      margin-right: 6px;
      /* espacio entre checkbox y texto */
    }

    #loginBox label {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-weight: normal;
    }

    #keepSession {
      margin-right: 6px;
      /* espacio entre el checkbox y el texto */
    }


    #registerBox {
      width: 300px;
      height: 280px;
      margin: 0 auto;
      margin-top: 110px;
      padding: 20px;
      border-radius: 8px;
      border: 1px solid #ddd;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    #btnRegister {
      background: #c3f1d6;
      border: 1px solid #00ff15;
      margin-top: 15px;
      padding: 9px;
      border-radius: 2px;
    }

    #btnBackToLogin {
      background: #c3cff1;
      border: 1px solid #007bff;
      margin-top: 15px;
      padding: 9px;
      border-radius: 2px;
    }

    .row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 8px;
    }

    .actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 8px;
    }

    th,
    td {
      border-bottom: 1px solid #eee;
      text-align: left;
      padding: 8px;
    }

    tr:hover {
      background: #fafafa;
    }

    .muted {
      color: #777;
      margin-top: 20px;
    }

    #linkGoRegister {
      display: block;
      width: fit-content;
      margin: 10px auto 0;
      text-align: center;
    }

    /* Overlay / Popup */
    .overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, .45);
      align-items: center;
      justify-content: center;
      z-index: 999;
    }

    .overlay .box {
      position: relative;
      background: #fff;
      color: #111;
      border-radius: 14px;
      padding: 16px;
      width: min(92vw, 720px);
      box-shadow: 0 20px 60px rgba(0, 0, 0, .35);
    }

    .modal-head {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 10px;
    }

    .modal-title {
      font-size: 1.4rem;
      font-weight: 700;
    }

    .modal-close {
      border: none;
      background: #ef4444;
      color: #fff;
      width: 28px;
      height: 28px;
      border-radius: 8px;
      display: grid;
      place-items: center;
      font-weight: 700;
      line-height: 1;
    }

    /* Tabs */
    .tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 10px;
    }

    .tabs button {
      border: 1px solid #ddd;
      background: #f5f5f5;
      border-radius: 10px;
      padding: 8px 12px;
      font-weight: 600;
    }

    .tabs button.active {
      background: #e7f0ff;
      border-color: #7aa7ff;
      color: #1f3b8f;
    }

    .tabview {
      display: none;
    }

    .tabview.active {
      display: block;
    }

    /* Form popup */
    .rem-form-grid {
      display: grid;
      grid-template-columns: repeat(3, minmax(160px, 1fr));
      gap: 16px 18px;
      align-items: end;
    }

    .rem-checks {
      margin-top: 6px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .rem-checks label {
      font-weight: 500;
      margin: 0;
    }

    .rem-footer {
      display: flex;
      justify-content: center;
      margin-top: 12px;
    }

    /* Acorde√≥n (filtros) */
    .accordion {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      user-select: none;
      padding: 8px 10px;
      border: 1px solid #ddd;
      border-radius: 8px;
      background: #fafafa;
    }

    .chevron {
      transition: transform .2s ease;
      font-size: 1.1rem;
      line-height: 1;
    }

    .chevron.up {
      transform: rotate(180deg);
    }

    .accordion-content {
      overflow: hidden;
      transition: max-height .25s ease;
      max-height: 0;
    }

    #accordionFilterContent .row {
      gap: 4px;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
    }

    #accordionFilterContent label {
      margin-top: 4px;
    }

    #accordionFilterContent {
      padding-top: 6px;
    }

    /* Campos inv√°lidos */
    .invalid {
      border-color: #dc2626 !important;
      outline-color: #dc2626 !important;
    }

    .hint {
      font-size: .8rem;
      color: #dc2626;
      display: none;
    }

    .hint.show {
      display: block;
    }

    /* Toast */
    #toast {
      position: fixed;
      left: 50%;
      bottom: 24px;
      transform: translateX(-50%);
      background: #111;
      color: #fff;
      padding: 10px 14px;
      border-radius: 8px;
      opacity: 0;
      pointer-events: none;
      transition: opacity .25s;
      z-index: 1000;
    }

    #toast.show {
      opacity: .95;
    }

    @media (max-width: 560px) {
      .rem-form-grid {
        grid-template-columns: 1fr 1fr;
      }
    }

    /* Layouts */
    .form-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 12px;
      align-items: start;
    }

    .form-grid .field {
      display: flex;
      flex-direction: column;
    }

    .form-grid input {
      width: 99%;
    }

    .form-grid select {
      width: 99%;
    }

    .auth-stack {
      display: grid;
      grid-template-columns: 1fr;
      gap: 10px;
      max-width: 360px;
    }

    .auth-stack input {
      width: 100%;
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 35px;
    }

    .header img {
      max-width: 90px;
      height: auto;
    }

    .contact-card {
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 12px;
      overflow: hidden;
      margin-bottom: 16px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    .contact-main {
      padding: 12px;
    }

    .contact-title {
      font-size: 1.2rem;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .contact-line {
      font-size: 0.9rem;
      margin-bottom: 4px;
    }

    .contact-line a {
      color: #007bff;
      text-decoration: none;
    }

    .contact-line a:hover {
      text-decoration: underline;
    }

    .contact-meta {
      margin-top: 8px;
      font-size: 0.85rem;
      color: #555;
    }

    .contact-actions {
      display: flex;
      gap: 8px;
      padding: 8px 12px;
      background: #f9f9f9;
      border-top: 1px solid #ddd;
    }

    .icon-btn {
      background: transparent;
      border: none;
      cursor: pointer;
      padding: 0;
      font-size: 1.2rem;
      color: #007bff;
      transition: color 0.2s;
    }

    .icon-btn:hover {
      color: #0056b3;
    }

    card.dataset.readonly=String( ! !c.readonly);

    /* oculta acciones cuando la tarjeta es de solo lectura */
    .contact-card[data-readonly="true"] .contact-actions {
      display: none !important;
    }

    .contact-card[data-readonly="true"] .icon-btn {
      display: none !important;
    }

    .focus-flash {
      box-shadow: 0 0 0 3px rgba(0, 123, 255, .25);
      transition: box-shadow .2s ease;
    }
  </style>
</head>

<body>
  <div class="header">
    <h1>Agenda de contactos</h1>
    <img src="https://res.cloudinary.com/dcjp6t6w9/image/upload/v1744806494/LOGO_POLIFANI_CUADRADO_qllmnj.jpg"
      alt="Logo-Polifani" />
  </div>

  <div id="content"></div>
  <div id="toast"></div>

  <!-- Popup bienvenida -->
  <div id="welcomePopup" class="overlay">
    <div class="box" style="text-align:center;">
      <h2 class="modal-title" style="margin:0 0 8px;">¬°Bienvenido!</h2>
      <p>Puedes empezar a gestionar tus contactos.</p>
      <div class="actions" style="justify-content:center; margin-top:12px;">
        <button id="btnStartWelcome">Comenzar</button>
      </div>
    </div>
  </div>

  <!-- Popup registro correcto -->
  <div id="registerPopup" class="overlay">
    <div class="box" style="text-align:center;">
      <div class="modal-head">
        <span class="modal-title">Registro completado</span>
        <button id="btnCloseRegisterPopup" class="modal-close">‚úï</button>
      </div>
      <p>Usuario creado. Ahora puedes iniciar sesi√≥n.</p>
    </div>
  </div>

  <!-- Popup recordatorio (disparo) -->
  <div id="reminderPopup" class="overlay">
    <div class="box" style="text-align:center;">
      <div class="modal-head">
        <span class="modal-title">Recordatorio</span>
        <button id="btnCloseReminder" class="modal-close">‚úï</button>
      </div>
      <p id="reminderText" style="margin-top:6px;"></p>
      <div class="actions" style="justify-content:center; margin-top:8px;">
        <button id="btnStopRepeat" style="display:none;">Detener repetici√≥n</button>
      </div>
    </div>
  </div>

  <!-- Popup formulario/lista de recordatorios -->
  <div id="reminderFormPopup" class="overlay">
    <div class="box">
      <div class="modal-head">
        <span class="modal-title">Recordatorios</span>
        <button id="btnCancelRemForm" style="margin-top:0px" class="modal-close" title="Cerrar">‚úï</button>
      </div>

      <div class="tabs">
        <button id="tabFormBtn" class="active">Programar</button>
        <button id="tabListBtn">Mis recordatorios</button>
      </div>

      <div id="tabForm" class="tabview active">
        <div class="rem-form-grid">
          <div>
            <label for="remDate">Fecha</label>
            <input type="date" id="remDate" />
          </div>
          <div>
            <label for="remTime">Hora</label>
            <input type="time" id="remTime" />
          </div>
          <div>
            <label for="remMsg">Mensaje</label>
            <input id="remMsg" placeholder="Texto del recordatorio" />
          </div>
          <div class="rem-checks" style="grid-column: 1 / -1;">
            <label><input type="checkbox" id="notifToggle" /> Permitir notificaciones</label>
            <label><input type="checkbox" id="remRepeat" /> Repetir cada 10 minutos</label>
          </div>
        </div>
        <div class="rem-footer">
          <button id="btnScheduleRem">Programar</button>
        </div>
        <p class="muted" id="reminderStatus" style="min-height:18px; text-align:center;"></p>
      </div>

      <div id="tabList" class="tabview">
        <div style="overflow:auto; max-height:45vh;">
          <table>
            <thead>
              <tr>
                <th>Fecha y hora</th>
                <th>Mensaje</th>
                <th>Repite</th>
                <th>Estado</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody id="remindersTbody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>


























  <!-- Inicio de sesi√≥n -->
  <fieldset id="loginBox">
    <legend>Inicio de sesi√≥n</legend>
    <form id="loginForm" autocomplete="on">


      <div class="auth-stack">
        <div class="field">
          <label for="username">Usuario</label>
          <input id="username" name="username" type="email" autocomplete="username" placeholder="Usuario" />
        </div>

        <div class="field">
          <label for="password">Contrase√±a</label>
          <input id="password" name="password" type="password" autocomplete="current-password"
            placeholder="Contrase√±a" />
        </div>

      </div>

      <div class="actions" style="margin-top:8px; align-items:center;">
        <button id="btnLogin" type="submit">Iniciar sesi√≥n</button>
      </div>

      <a id="linkGoRegister" href="#" class="muted" style="margin-left:8px;">Registrarse</a>
      <br>

    </form>

    <div style="margin-top:6px;">
      <a id="linkForgot" href="#" class="muted">¬øOlvidaste tu contrase√±a?</a>
    </div>
  </fieldset>

  <!-- Registro -->
  <fieldset id="registerBox" style="display:none;">
    <legend>Registro</legend>
    <form id="registerForm" autocomplete="on">
      <div class="auth-stack">
        <div class="field">
          <label for="regUsername">Usuario</label>
          <input id="regUsername" name="username" type="email" autocomplete="username" placeholder="Usuario" />
          <small id="userHintReg" class="hint">Ese usuario ya existe.</small>
        </div>
        <div class="field">
          <label for="regPassword">Contrase√±a</label>
          <input id="regPassword" name="new-password" type="password" autocomplete="new-password"
            placeholder="Contrase√±a" />
        </div>
      </div>
      <div class="actions" style="margin-top:8px; flex-wrap:wrap; gap:8px;">
        <button id="btnRegister" type="submit">Registrarse</button>
        <button id="btnBackToLogin" type="button">Volver</button>
      </div>
    </form>
  </fieldset>

  <!-- App -->
  <div id="app" style="display:none;">
    <p style="display:flex; align-items:center; justify-content:space-between; gap:8px;">
      <span>Bienvenido, <strong id="userName"></strong></span>
      <span>
        <button id="btnExport" title="Exportar a JSON">Exportar</button>
        <button id="btnImport" title="Importar desde JSON">Importar</button>
        <input id="importFile" type="file" accept="application/json" hidden>
        <button id="btnOpenRemForm" title="Nuevo recordatorio">Nuevo recordatorio</button>
        <button id="btnLogout" title="Cerrar sesi√≥n">Cerrar sesi√≥n</button>
      </span>
    </p>

    <fieldset>
      <legend id="formLegend">Agregar contacto</legend>
      <div class="form-grid">
        <div class="field">
          <label for="contactName">Nombre *</label>
          <input id="contactName" placeholder="Nombre" />
          <small id="nameHint" class="hint">El nombre es obligatorio.</small>
        </div>
        <div class="field">
          <label for="contactPhone">Tel√©fono</label>
          <input id="contactPhone" placeholder="Tel√©fono" />
          <small id="phoneHint" class="hint">Introduce un tel√©fono v√°lido.</small>
        </div>
        <div class="field">
          <label for="contactEmail">Email</label>
          <input id="contactEmail" placeholder="Email" />
          <small id="emailHint" class="hint">Introduce un email v√°lido.</small>
        </div>
        <div class="field">
          <label for="contactCategory">Categor√≠a *</label>
          <select id="contactCategory"></select>
          <small id="catHint" class="hint">Selecciona una categor√≠a.</small>
        </div>
        <div class="field">
          <label for="contactCodigo">C√≥digo Mediador</label>
          <input id="contactCodigo" placeholder="C√≥digo Mediador" />
        </div>
      </div>
      <div class="actions" style="margin-top:8px;">
        <button id="btnSave" title="Guardar contacto">Guardar</button>
        <button id="btnClear" title="Limpiar campos" type="button">Limpiar</button>
        <span class="muted" id="editHint" style="display:none;">Editando contacto existente‚Ä¶</span>
      </div>
    </fieldset>

    <fieldset>
      <legend>Buscar y filtrar</legend>
      <div id="accordionFilterBtn" class="accordion" aria-expanded="false">
        <span id="chevronFilter" class="chevron">‚ñº</span>
        <strong>Mostrar filtros</strong>
      </div>
      <div id="accordionFilterContent" class="accordion-content">
        <div>
          <div class="row">
            <div>
              <label for="filterName">Nombre</label>
              <input id="filterName" placeholder="Nombre" />
            </div>
            <div>
              <label for="filterPhone">Tel√©fono</label>
              <input id="filterPhone" placeholder="Tel√©fono" />
            </div>
            <div>
              <label for="filterEmail">Email</label>
              <input id="filterEmail" placeholder="Email" />
            </div>
            <div>
              <label for="filterCategory">Categor√≠a</label>
              <select id="filterCategory">
                <option value="all">Todas</option>
              </select>
            </div>
          </div>
        </div>
      </div>
    </fieldset>

    <fieldset>
      <legend>Contactos</legend>
      <div id="contactsCards" aria-live="polite"></div>
    </fieldset>
  </div>
  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    const SUPABASE_URL = "https://euejoapezqbflobpdklk.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV1ZWpvYXBlenFiZmxvYnBka2xrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc0MTU0MTMsImV4cCI6MjA3Mjk5MTQxM30.BwK_NSGHOFjjitsjdJy0cCo9TQSwd49UjL5FoEOoaB4";

    /* =========================
       Supabase: Singleton (solo sessionStorage)
       ========================= */
    const SB_NS = "guia-tel";
    const SS_KEY = `${SB_NS}:ss`; // storageKey fijo para sessionStorage

    function makeClient() {
      return createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
        auth: {
          persistSession: true,
          autoRefreshToken: true,
          storage: sessionStorage,
          storageKey: SS_KEY
        }
      });
    }

    // √önica instancia global
    let sb = window.__SB_SINGLETON__ || makeClient();
    window.__SB_SINGLETON__ = sb;
    window.supabase = sb;

    /* =========================
       Utils UI / Estado
       ========================= */
    let currentUser = null;
    let currentEditId = null;
    const DEFAULT_CATEGORIES = ["Siniestros", "Gr√∫as", "Asistencia", "Salud", "Administraciones", "Contactos", "Otros"];
    const reminderTimers = new Map(); let currentPopupReminderId = null;

    const $ = (id) => document.getElementById(id);
    const toast = (msg, ms = 1200) => { const t = $('toast'); if (!t) return; t.textContent = msg; t.classList.add('show'); setTimeout(() => t.classList.remove('show'), ms); };
    const showOverlay = (id, show = true) => { const el = $(id); if (el) el.style.display = show ? 'flex' : 'none'; };
    const setInvalid = (el, hint, inv) => { if (!el) return; el.classList.toggle('invalid', !!inv); if (hint) hint.classList.toggle('show', !!inv); };
    const isValidEmail = (v) => !v || /^[^\s@]+@[^\s@]+\.[^\s@]{2,}$/.test(v.trim());
    const isValidPhone = (v) => !v || /^[0-9+\s\-()]{6,20}$/.test(v.trim());
    const normalize = (s) => (s || "").toString().toLowerCase();

    function requireUser() { if (!currentUser) throw new Error("No hay usuario autenticado"); return currentUser; }
    function showLogin() { $('loginBox').style.display = "block"; $('registerBox').style.display = "none"; }
    function showRegister() { $('loginBox').style.display = "none"; $('registerBox').style.display = "block"; $('regUsername')?.classList.remove("invalid"); $('userHintReg')?.classList.remove("show"); }

    /* =========================
       Auth
       ========================= */
    const normUser = (u) => (u || "").trim().toLowerCase();

    async function register() {
      try {
        const emailEl = $("regUsername");
        const passEl = $("regPassword");

        if (!emailEl || !passEl) {
          throw new Error("No se encontraron los campos del formulario de registro.");
        }

        const email = normUser(emailEl.value);
        const password = passEl.value;

        if (!email || !password) {
          alert("Completa usuario (email) y contrase√±a.");
          return;
        }

        const { error } = await sb.auth.signUp({ email, password });

        if (error) {
          console.error("Error al registrar usuario:", error);
          alert("Error al registrar: " + error.message);
          return;
        }

        showOverlay('registerPopup', true);
        showLogin();
        toast("Registro exitoso. Verifica tu correo para confirmar la cuenta.");

      } catch (err) {
        console.error("Excepci√≥n en register():", err);
        alert("Ocurri√≥ un problema durante el registro. Intenta nuevamente m√°s tarde.");
      }
    }


    // (Opcional) Si tienes una RPC user_exists(email_input text); si no existe no pasa nada
    async function checkUserExists(email) {
      try {
        const { data, error } = await sb.rpc('user_exists', { email_input: email });
        if (error) return null;
        return !!data;
      } catch { return null; }
    }

    // Suscripci√≥n al estado de auth (recreable)
    let authSubscription = null;
    function bindAuthListener() {
      try { authSubscription?.unsubscribe(); } catch { }
      const { data: { subscription } } = sb.auth.onAuthStateChange(async (event, session) => {
        switch (event) {
          case 'SIGNED_IN':
          case 'TOKEN_REFRESHED':
          case 'USER_UPDATED':
            currentUser = session?.user ?? null;
            await afterAuth();
            break;
          case 'PASSWORD_RECOVERY': {
            const newPassword = prompt("Introduce tu nueva contrase√±a:");
            if (!newPassword) return;
            const { error } = await sb.auth.updateUser({ password: newPassword });
            if (error) { alert("No se pudo actualizar la contrase√±a: " + error.message); return; }
            alert("Contrase√±a actualizada. Ya puedes iniciar sesi√≥n.");
            break;
          }
          case 'SIGNED_OUT':
            currentUser = null;
            clearAllReminderTimers(); // <- aqu√≠
            showLogin();
            $('app').style.display = 'none';
            break;

        }
        authSubscription = subscription;
      });
    }
    bindAuthListener();

    async function login() {
      const email = normUser(document.getElementById("username").value);
      const password = document.getElementById("password").value;

      if (!email || !password) { alert("Completa usuario y contrase√±a."); return; }

      // (opcional) comprobar existencia v√≠a RPC sin bloquear
      try {
        const exists = await checkUserExists(email);
        if (exists === false) { alert("El usuario no existe. Por favor, reg√≠strate."); return; }
      } catch { }

      const { data, error } = await sb.auth.signInWithPassword({ email, password });
      if (error) {
        alert(error.message?.toLowerCase().includes("invalid")
          ? "El usuario no existe o la contrase√±a es incorrecta."
          : ("No se pudo iniciar sesi√≥n: " + error.message));
        return;
      }
      await afterAuth();
    }

    async function sendResetLink() {
      try {
        const email = normUser($("username").value);
        if (!email) {
          alert("Escribe tu email en 'Usuario' y vuelve a pulsar '¬øOlvidaste tu contrase√±a?'");
          return;
        }

        const redirectTo = `${window.location.origin}/#/recuperar`;

        const { error } = await sb.auth.resetPasswordForEmail(email, { redirectTo });

        if (error) {
          console.error("Error al enviar enlace de restablecimiento:", error);
          alert("No se pudo enviar el correo: " + error.message);
          return;
        }

        alert("Te hemos enviado un email con el enlace para restablecer tu contrase√±a.");
      } catch (err) {
        console.error("Excepci√≥n en sendResetLink():", err);
        alert("Ocurri√≥ un error al intentar enviar el correo. Revisa tu conexi√≥n e int√©ntalo de nuevo.");
      }
    }


    async function logout() {
      try {
        clearAllReminderTimers(); // <- limpiar recordatorios en memoria
        await sb.auth.signOut();
      } catch (e) {
        alert('No se pudo cerrar sesi√≥n: ' + (e?.message || e));
      }
    }


    async function afterAuth() {
      try {
        // Limpia recordatorios anteriores antes de cargar todo
        clearAllReminderTimers();

        // Obtener usuario actual
        const { data, error } = await sb.auth.getUser();
        if (error) throw new Error("No se pudo obtener el usuario: " + error.message);

        currentUser = data?.user || null;
        if (!currentUser) {
          console.warn("afterAuth(): no hay usuario autenticado.");
          showLogin();
          return;
        }

        // Mostrar interfaz principal
        $('loginBox').style.display = "none";
        $('registerBox').style.display = "none";
        $('app').style.display = "block";
        $('userName').textContent = currentUser.email || "";

        // Inicializar la UI
        resetForm();

        // Cargar datos de Supabase
        await ensureCategoryOptions();
        await refreshList();
        await refreshRemindersTable();

        // Reiniciar recordatorios (evita duplicados)
        clearAllReminderTimers();
        await loadAndScheduleReminders();

        // Mostrar popup de bienvenida
        showOverlay('welcomePopup', true);

      } catch (err) {
        console.error("Error en afterAuth():", err);
        alert("Ocurri√≥ un problema al cargar tus datos. Intenta volver a iniciar sesi√≥n.");

        // En caso de error grave, forzar vista de login
        try {
          showLogin();
          $('app').style.display = 'none';
        } catch { }
      }
    }


    window.addEventListener('beforeunload', () => { try { authSubscription?.unsubscribe(); } catch { } });

    /* =========================
       Contactos
       ========================= */
    function resetForm() {
      currentEditId = null;
      ['contactName', 'contactPhone', 'contactEmail', 'contactCodigo'].forEach(id => $(id).value = '');
      $('contactCategory').selectedIndex = 0;
      ['contactName', 'contactEmail', 'contactPhone', 'contactCategory'].forEach(id => setInvalid($(id), null, false));
      ['nameHint', 'emailHint', 'phoneHint', 'catHint'].forEach(id => $(id).classList.remove('show'));
      $("formLegend").textContent = "Agregar contacto"; $("editHint").style.display = "none"; $("btnSave").textContent = "Guardar";
    }

    async function ensureCategoryOptions() {
      const formSel = $("contactCategory"), filterSel = $("filterCategory");
      const prevForm = formSel.value, prevFilter = filterSel.value;
      formSel.innerHTML = "";
      for (const cat of ["", ...DEFAULT_CATEGORIES]) { const o = document.createElement("option"); o.value = cat; o.textContent = cat ? cat : "‚Äî Selecciona ‚Äî"; formSel.appendChild(o); }
      filterSel.innerHTML = ""; const a = document.createElement("option"); a.value = "all"; a.textContent = "Todas"; filterSel.appendChild(a);
      for (const cat of DEFAULT_CATEGORIES) { const o = document.createElement("option"); o.value = cat; o.textContent = cat; filterSel.appendChild(o); }
      if ([...formSel.options].some(o => o.value === prevForm)) formSel.value = prevForm;
      if ([...filterSel.options].some(o => o.value === prevFilter)) filterSel.value = prevFilter;
    }

    function validateContactForm() {
      const n = $("contactName"), e = $("contactEmail"), t = $("contactPhone"), c = $("contactCategory"); let ok = true;
      if (!n.value.trim()) { setInvalid(n, $("nameHint"), true); ok = false; } else setInvalid(n, $("nameHint"), false);
      if (!isValidEmail(e.value)) { setInvalid(e, $("emailHint"), true); ok = false; } else setInvalid(e, $("emailHint"), false);
      if (!isValidPhone(t.value)) { setInvalid(t, $("phoneHint"), true); ok = false; } else setInvalid(t, $("phoneHint"), false);
      if (!c.value) { setInvalid(c, $("catHint"), true); ok = false; } else setInvalid(c, $("catHint"), false);
      return ok;
    }

    async function saveContact() {
      try {
        // Validar el formulario antes de continuar
        if (!validateContactForm()) return;

        const user = requireUser();

        const obj = {
          user_id: user.id,
          name: $("contactName").value.trim(),
          phone: $("contactPhone").value.trim(),
          email: $("contactEmail").value.trim(),
          category: $("contactCategory").value.trim(),
          codigo: $("contactCodigo").value.trim()
        };

        let error = null;

        // Insertar o actualizar seg√∫n corresponda
        if (currentEditId == null) {
          const res = await sb.from('contacts').insert(obj);
          error = res.error;
        } else {
          const res = await sb
            .from('contacts')
            .update(obj)
            .eq('id', Number(currentEditId))
            .eq('user_id', user.id);
          error = res.error;
        }

        if (error) {
          console.error("Error guardando contacto:", error);
          alert("No se pudo guardar el contacto: " + error.message);
          return;
        }

        // Si todo sale bien
        resetForm();
        await refreshList();
        toast("Contacto guardado correctamente.");
      } catch (err) {
        console.error("Excepci√≥n en saveContact():", err);
        alert("Ocurri√≥ un problema al guardar el contacto. Revisa tu conexi√≥n e int√©ntalo de nuevo.");
      }
    }

    async function getContactsForList() {
      try {
        // Verificar que Supabase est√© listo
        if (!sb) throw new Error("Cliente Supabase no inicializado.");

        // Obtener valores de filtros (defensivo en caso de elementos nulos)
        const fName = normalize($("filterName")?.value);
        const fEmail = normalize($("filterEmail")?.value);
        const fPhone = normalize($("filterPhone")?.value);
        const fCatVal = $("filterCategory")?.value;

        // Construir consulta
        let q = sb.from('contacts').select('*');

        if (fName) q = q.ilike('name', `%${fName}%`);
        if (fEmail) q = q.ilike('email', `%${fEmail}%`);
        if (fPhone) q = q.ilike('phone', `%${fPhone}%`);
        if (fCatVal && fCatVal !== 'all') q = q.eq('category', fCatVal);

        // Ejecutar consulta
        const { data, error } = await q.order('name', { ascending: true });

        if (error) {
          console.error("Error listando contactos:", error);
          alert("Error listando contactos: " + error.message);
          return [];
        }

        // Validar datos y devolver resultado limpio
        if (!Array.isArray(data)) {
          console.warn("Respuesta inesperada en getContactsForList:", data);
          return [];
        }

        return data.map(c => ({
          ...c,
          readonly: c.is_global === true
        }));

      } catch (err) {
        console.error("Excepci√≥n en getContactsForList():", err);
        alert("No se pudieron obtener los contactos. Revisa tu conexi√≥n e int√©ntalo nuevamente.");
        return [];
      }
    }


    async function editContact(id) {
      const user = requireUser();
      const { data, error } = await sb.from('contacts')
        .select('*')
        .eq('id', Number(id))
        .eq('user_id', user.id)
        .single();

      if (error) { alert("No se pudo cargar: " + error.message); return; }

      const c = data;
      currentEditId = c.id;

      $("contactName").value = c.name || "";
      $("contactPhone").value = c.phone || "";
      $("contactEmail").value = c.email || "";
      $("contactCodigo").value = c.codigo || "";
      $("contactCategory").value = (c.category || "");

      $("formLegend").textContent = "Modificar contacto";
      $("editHint").style.display = "inline";
      $("btnSave").textContent = "Guardar cambios";

      // üëá Scroll arriba + foco en el nombre
      try {
        // Desplaza suavemente al inicio
        window.scrollTo({ top: 0, behavior: 'smooth' });

        const nameInput = $("contactName");
        if (nameInput) {
          // Foco inmediato (por si el navegador bloquea durante la animaci√≥n)
          nameInput.focus();
          nameInput.select?.();

          // Refuerzo del foco tras la animaci√≥n de scroll
          setTimeout(() => {
            nameInput.focus();
            nameInput.select?.();
          }, 350);

          // (Opcional) peque√±o ‚Äúflash‚Äù de realce
          nameInput.classList.add("focus-flash");
          setTimeout(() => nameInput.classList.remove("focus-flash"), 600);
        }
      } catch { }
      alert("Contacto guardado correctamente.");
    }


    async function deleteContact(id) {
      try {
        const user = requireUser();

        if (!confirm("¬øBorrar el contacto seleccionado?")) return;

        const { error } = await sb
          .from('contacts')
          .delete()
          .eq('id', Number(id))
          .eq('user_id', user.id);

        if (error) {
          console.error("Error al borrar contacto:", error);
          alert("No se pudo borrar el contacto: " + error.message);
          return;
        }

        // Si el contacto borrado estaba en edici√≥n, limpiar el formulario
        if (currentEditId === Number(id)) {
          resetForm();
        }

        await refreshList();
        toast("Contacto eliminado correctamente.");

      } catch (err) {
        console.error("Excepci√≥n en deleteContact():", err);
        alert("Ocurri√≥ un problema al intentar borrar el contacto. Revisa tu conexi√≥n e int√©ntalo de nuevo.");
      }
    }


    async function refreshList() {
      try {
        await ensureCategoryOptions();
        const container = document.getElementById("contactsCards");
        if (!container) throw new Error("No se encontr√≥ el contenedor de contactos.");

        container.innerHTML = "";

        const rows = await getContactsForList();
        if (!Array.isArray(rows)) throw new Error("Los datos de contactos no son v√°lidos.");

        if (rows.length === 0) {
          const p = document.createElement("p");
          p.className = "muted";
          p.textContent = "No hay contactos que coincidan.";
          container.appendChild(p);
          return;
        }

        for (const c of rows) {
          const card = document.createElement("article");
          card.className = "contact-card";
          card.dataset.readonly = String(!!c.is_global);

          const main = document.createElement("div");
          main.className = "contact-main";

          const title = document.createElement("div");
          title.className = "contact-title";
          title.textContent = c.name || "‚Äî";
          title.title = c.name || "";
          main.appendChild(title);

          const phoneLine = document.createElement("div");
          phoneLine.className = "contact-line";
          if (c.phone) {
            const a = document.createElement("a");
            a.href = "tel:" + (c.phone || "").replace(/[^0-9+]/g, "");
            a.textContent = c.phone;
            a.title = c.phone;
            phoneLine.appendChild(a);
          } else {
            phoneLine.textContent = "Tel√©fono";
            phoneLine.classList.add("muted");
          }
          main.appendChild(phoneLine);

          const emailLine = document.createElement("div");
          emailLine.className = "contact-line";
          if (c.email) {
            const a = document.createElement("a");
            a.href = `mailto:${c.email}`;
            a.textContent = c.email;
            a.title = c.email;
            emailLine.appendChild(a);
          } else {
            emailLine.textContent = "Email";
            emailLine.classList.add("muted");
          }
          main.appendChild(emailLine);

          const meta = document.createElement("div");
          meta.className = "contact-meta";
          const cat = document.createElement("small");
          cat.textContent = c.category || "";
          meta.appendChild(cat);

          const codigo = (c.codigo || "").trim();
          if (codigo) {
            const cod = document.createElement("small");
            cod.textContent = `C√≥digo de mediador: ${codigo}`;
            meta.appendChild(cod);
          }
          main.appendChild(meta);

          const actions = document.createElement("div");
          actions.className = "contact-actions";

          const btnEdit = document.createElement("button");
          btnEdit.id = `btn-edit-${c.id}`;
          btnEdit.className = "icon-btn";
          btnEdit.innerHTML = '<span aria-hidden="true">‚úèÔ∏è</span>';
          btnEdit.title = "Modificar";
          btnEdit.disabled = c.readonly;
          btnEdit.onclick = () => editContact(c.id);

          const btnDelete = document.createElement("button");
          btnDelete.id = `btn-delete-${c.id}`;
          btnDelete.className = "icon-btn";
          btnDelete.innerHTML = '<span aria-hidden="true">üóëÔ∏è</span>';
          btnDelete.title = "Borrar";
          btnDelete.disabled = c.readonly;
          btnDelete.onclick = () => deleteContact(c.id);

          actions.appendChild(btnEdit);
          actions.appendChild(btnDelete);

          card.appendChild(main);
          card.appendChild(actions);
          container.appendChild(card);
        }
      } catch (err) {
        console.error("Error en refreshList():", err);
        alert("No se pudieron cargar los contactos. Revisa tu conexi√≥n o vuelve a intentar.");
      }
    }


    /* =========================
       Recordatorios
       ========================= */
    async function sbUser() {
      const { data: { user }, error } = await sb.auth.getUser();
      if (error) throw error;
      if (!user) throw new Error("No hay usuario autenticado.");
      return user;
    }

    async function addReminder({ message, whenTs, repeat }) {
      try {
        const user = await sbUser();

        const whenIso = new Date(whenTs).toISOString();
        if (isNaN(new Date(whenTs).getTime())) {
          throw new Error("Fecha/hora de recordatorio no v√°lida.");
        }

        const { data, error } = await sb
          .from("reminders")
          .insert({
            user_id: user.id,
            message,
            when_ts: whenIso,
            repeat: !!repeat,
            active: true
          })
          .select("id")
          .single();

        if (error) {
          console.error("Error insertando recordatorio:", error);
          alert("No se pudo guardar el recordatorio: " + error.message);
          return null; // devuelve null en lugar de lanzar excepci√≥n
        }

        return data?.id || null;

      } catch (err) {
        console.error("Excepci√≥n en addReminder():", err);
        alert("Ocurri√≥ un problema al guardar el recordatorio. Revisa tu conexi√≥n e int√©ntalo de nuevo.");
        return null;
      }
    }

    async function getMyReminders() {
      try {
        const user = await sbUser();
        if (!user?.id) {
          console.warn("No hay usuario autenticado al intentar obtener recordatorios.");
          return [];
        }

        const { data, error } = await sb
          .from("reminders")
          .select("id, message, when_ts, repeat, active")
          .eq("user_id", user.id)
          .order("when_ts", { ascending: true });

        if (error) {
          console.error("Error al cargar recordatorios:", error);
          alert("Error cargando recordatorios: " + error.message);
          return [];
        }

        // Validar que data sea un array antes de mapear
        if (!Array.isArray(data)) {
          console.warn("Respuesta inesperada de Supabase en getMyReminders:", data);
          return [];
        }

        return data.map(r => ({
          id: r.id,
          message: r.message,
          repeat: r.repeat,
          active: r.active,
          whenTs: new Date(r.when_ts).getTime()
        }));

      } catch (err) {
        console.error("Excepci√≥n en getMyReminders():", err);
        alert("Ocurri√≥ un problema al obtener los recordatorios. Intenta de nuevo.");
        return [];
      }
    }

    async function updateReminder(rem) {
      try {
        const user = await sbUser();

        if (!rem || !rem.id) {
          throw new Error("Datos de recordatorio inv√°lidos.");
        }

        // Validar fecha
        const date = new Date(rem.whenTs);
        if (isNaN(date.getTime())) {
          throw new Error("Fecha/hora del recordatorio no v√°lida.");
        }

        const payload = {
          message: rem.message,
          when_ts: date.toISOString(),
          repeat: !!rem.repeat,
          active: !!rem.active
        };

        const { error } = await sb
          .from("reminders")
          .update(payload)
          .eq("id", rem.id)
          .eq("user_id", user.id);

        if (error) {
          console.error("Error al actualizar recordatorio:", error);
          alert("No se pudo actualizar el recordatorio: " + error.message);
          return false;
        }

        return true;

      } catch (err) {
        console.error("Excepci√≥n en updateReminder():", err);
        alert("Ocurri√≥ un problema al actualizar el recordatorio. Int√©ntalo de nuevo.");
        return false;
      }
    }

    async function deleteReminder(id) {
      try {
        if (!id || isNaN(Number(id))) {
          throw new Error("ID de recordatorio inv√°lido.");
        }

        const user = await sbUser();

        const { error } = await sb
          .from("reminders")
          .delete()
          .eq("id", Number(id))
          .eq("user_id", user.id);

        if (error) {
          console.error("Error al borrar recordatorio:", error);
          alert("No se pudo borrar el recordatorio: " + error.message);
          return false;
        }

        toast("Recordatorio eliminado");
        return true;

      } catch (err) {
        console.error("Excepci√≥n en deleteReminder():", err);
        alert("Ocurri√≥ un problema al eliminar el recordatorio. Intenta de nuevo.");
        return false;
      }
    }

    async function refreshRemindersTable() {
      try {
        const tbody = $("remindersTbody");
        if (!tbody) throw new Error("No se encontr√≥ el contenedor de recordatorios.");

        tbody.innerHTML = "";

        const list = await getMyReminders();
        if (!Array.isArray(list)) throw new Error("Datos de recordatorios inv√°lidos.");

        // Ordenar por fecha
        list.sort((a, b) => a.whenTs - b.whenTs);

        if (list.length === 0) {
          const tr = document.createElement("tr");
          const td = document.createElement("td");
          td.colSpan = 5;
          td.className = "muted";
          td.textContent = "No hay recordatorios.";
          tr.appendChild(td);
          tbody.appendChild(tr);
          return;
        }

        for (const r of list) {
          const tr = document.createElement("tr");
          const when = new Date(r.whenTs);

          const td = (t) => {
            const x = document.createElement("td");
            x.textContent = t;
            return x;
          };

          tr.appendChild(td(when.toLocaleString()));
          tr.appendChild(td(r.message));
          tr.appendChild(td(r.repeat ? "Cada 10 min" : "No"));

          const tdAct = document.createElement("td");
          tdAct.innerHTML = r.active
            ? '<span style="color:#065f46;font-weight:600">Activo</span>'
            : '<span style="color:#7c2d12;font-weight:600">Inactivo</span>';
          tr.appendChild(tdAct);

          const tdActions = document.createElement("td");

          // Bot√≥n activar/desactivar
          const tgl = document.createElement("button");
          tgl.textContent = r.active ? "Desactivar" : "Activar";
          tgl.onclick = async () => {
            try {
              await toggleReminderActive(r.id, !r.active);
            } catch (err) {
              console.error("Error al alternar recordatorio:", err);
              alert("No se pudo cambiar el estado del recordatorio.");
            }
          };

          // Bot√≥n borrar
          const del = document.createElement("button");
          del.textContent = "Borrar";
          del.style.marginLeft = "6px";
          del.onclick = async () => {
            try {
              const e = reminderTimers.get(r.id);
              if (e) {
                if (e.timeoutId) clearTimeout(e.timeoutId);
                if (e.intervalId) clearInterval(e.intervalId);
              }
              reminderTimers.delete(r.id);
              await deleteReminder(r.id);
              await refreshRemindersTable();
            } catch (err) {
              console.error("Error al borrar recordatorio:", err);
              alert("No se pudo eliminar el recordatorio.");
            }
          };

          tdActions.appendChild(tgl);
          tdActions.appendChild(del);
          tr.appendChild(tdActions);
          tbody.appendChild(tr);
        }

      } catch (err) {
        console.error("Excepci√≥n en refreshRemindersTable():", err);
        alert("No se pudieron cargar los recordatorios. Intenta nuevamente m√°s tarde.");
      }
    }

    function sendSystemNotification(message) { try { if ('Notification' in window && Notification.permission === 'granted') { const n = new Notification('Recordatorio', { body: message }); n.onclick = () => { window.focus(); $('reminderPopup').style.display = 'none'; }; } } catch { } }
    function scheduleReminderInMemory(rem) {
      try {
        if (!rem || !rem.id) {
          console.warn("Recordatorio inv√°lido al intentar programar:", rem);
          return;
        }

        // Limpiar cualquier temporizador previo del mismo ID
        const ex = reminderTimers.get(rem.id);
        if (ex) {
          try {
            if (ex.timeoutId) clearTimeout(ex.timeoutId);
            if (ex.intervalId) clearInterval(ex.intervalId);
          } catch (cleanErr) {
            console.warn("Error limpiando timers previos:", cleanErr);
          }
        }
        reminderTimers.delete(rem.id);

        if (!rem.active) {
          console.info(`Recordatorio ${rem.id} est√° inactivo, no se programar√°.`);
          return;
        }

        const entry = { timeoutId: null, intervalId: null };

        const trigger = () => {
          try {
            currentPopupReminderId = rem.id;
            sendSystemNotification(rem.message);
            showReminderPopup(rem.message, rem.repeat);

            // Si est√° configurado para repetirse
            if (rem.repeat && rem.active) {
              entry.intervalId = setInterval(() => {
                try {
                  currentPopupReminderId = rem.id;
                  sendSystemNotification(rem.message);
                  showReminderPopup(rem.message, true);
                } catch (innerErr) {
                  console.error("Error dentro del recordatorio repetido:", innerErr);
                }
              }, 10 * 60 * 1000);

              reminderTimers.set(rem.id, entry);
            }

          } catch (err) {
            console.error("Error al ejecutar recordatorio:", err);
          }
        };

        // Calcular cu√°ndo debe dispararse
        const diff = rem.whenTs - Date.now();
        if (isNaN(diff)) {
          console.warn("Recordatorio con fecha inv√°lida:", rem);
          return;
        }

        if (diff <= 0) {
          trigger(); // si ya venci√≥, dispara de inmediato
        } else {
          entry.timeoutId = setTimeout(trigger, diff);
          reminderTimers.set(rem.id, entry);
        }

      } catch (err) {
        console.error("Excepci√≥n en scheduleReminderInMemory():", err);
      }
    }

    async function loadAndScheduleReminders() {
      try {
        const list = await getMyReminders();

        if (!Array.isArray(list)) {
          console.warn("Respuesta inesperada en loadAndScheduleReminders():", list);
          return;
        }

        console.info(`Cargando ${list.length} recordatorio(s) en memoria...`);

        for (const r of list) {
          try {
            scheduleReminderInMemory(r);
          } catch (innerErr) {
            console.error("Error al programar recordatorio individual:", r, innerErr);
          }
        }

        console.info("‚úÖ Recordatorios cargados y programados correctamente.");

      } catch (err) {
        console.error("Excepci√≥n en loadAndScheduleReminders():", err);
        alert("No se pudieron cargar los recordatorios. Int√©ntalo de nuevo m√°s tarde.");
      }
    }

    async function toggleReminderActive(id, makeActive) {
      try {
        if (!id) throw new Error("ID de recordatorio inv√°lido en toggleReminderActive().");

        // üîπ 1. Limpiar timers existentes para este recordatorio
        const e = reminderTimers.get(id);
        if (e) {
          try {
            if (e.timeoutId) clearTimeout(e.timeoutId);
            if (e.intervalId) clearInterval(e.intervalId);
          } catch (cleanErr) {
            console.warn("Error al limpiar timers en toggleReminderActive():", cleanErr);
          }
        }
        reminderTimers.delete(id);

        // üîπ 2. Obtener lista actualizada
        const list = await getMyReminders();
        if (!Array.isArray(list)) throw new Error("Error al recuperar lista de recordatorios.");

        // üîπ 3. Buscar el recordatorio
        const rem = list.find(x => x.id === id);
        if (!rem) {
          console.warn(`No se encontr√≥ el recordatorio con ID ${id}.`);
          return;
        }

        // üîπ 4. Actualizar estado
        rem.active = makeActive;

        const ok = await updateReminder(rem);
        if (ok === false) {
          console.warn(`No se pudo actualizar el estado del recordatorio ${id}.`);
          return;
        }

        // üîπ 5. Si se activa, reprogramar
        if (makeActive) {
          scheduleReminderInMemory(rem);
        }

        // üîπ 6. Refrescar vista
        await refreshRemindersTable();

        toast(makeActive ? "Recordatorio activado" : "Recordatorio desactivado");

      } catch (err) {
        console.error("Excepci√≥n en toggleReminderActive():", err);
        alert("No se pudo cambiar el estado del recordatorio. Int√©ntalo de nuevo.");
      }
    }

    async function scheduleReminder() {
      try {
        // 1Ô∏è‚É£ Leer y validar entradas
        const dateEl = $('remDate');
        const timeEl = $('remTime');
        const msgEl = $('remMsg');
        const repeatEl = $('remRepeat');

        if (!dateEl || !timeEl || !msgEl || !repeatEl) {
          throw new Error("No se encontraron elementos del formulario de recordatorio.");
        }

        const date = dateEl.value;
        const time = timeEl.value;
        const msg = msgEl.value.trim();
        const repeat = repeatEl.checked;

        if (!date || !time || !msg) {
          alert('Completa fecha, hora y mensaje.');
          return;
        }

        const target = new Date(`${date}T${time}`);
        if (isNaN(target.getTime())) {
          alert('Fecha u hora no v√°lidas.');
          return;
        }
        if (target.getTime() <= Date.now()) {
          alert('La fecha y hora deben ser futuras.');
          return;
        }

        // 2Ô∏è‚É£ Insertar en Supabase
        const id = await addReminder({
          message: msg,
          whenTs: target.getTime(),
          repeat
        });

        if (!id) {
          console.warn("No se pudo crear el recordatorio en la base de datos.");
          return;
        }

        // 3Ô∏è‚É£ Recuperar el recordatorio reci√©n insertado
        const list = await getMyReminders();
        const rem = list.find(r => r.id === id);

        // 4Ô∏è‚É£ Programarlo en memoria
        if (rem) {
          scheduleReminderInMemory(rem);
        } else {
          console.warn("Recordatorio no encontrado tras insertarlo:", id);
        }

        // 5Ô∏è‚É£ Actualizar interfaz
        $('reminderStatus').textContent =
          `Guardado para ${target.toLocaleString()}${repeat ? ' (cada 10 min)' : ''}.`;

        // Limpiar formulario tras breve pausa visual
        setTimeout(() => {
          try {
            showOverlay('reminderFormPopup', false);
            $('reminderStatus').textContent = '';
            $('remDate').value = '';
            $('remTime').value = '';
            $('remMsg').value = '';
            $('remRepeat').checked = false;
            toast('Recordatorio programado');
          } catch (innerErr) {
            console.error("Error al limpiar formulario de recordatorio:", innerErr);
          }
        }, 700);

        await refreshRemindersTable();

      } catch (err) {
        console.error("Excepci√≥n en scheduleReminder():", err);
        alert("Ocurri√≥ un problema al guardar el recordatorio. Intenta nuevamente.");
      }
    }

    function showReminderPopup(message, repeating) {
      $('reminderPopup').style.display = 'none'; // cerrar si estaba abierto
      $('reminderText').textContent = message;
      $('reminderPopup').style.display = 'flex';
      $('btnStopRepeat').style.display = repeating ? 'inline-block' : 'none';
    }
    async function stopRepeatForCurrent() {
      try {
        if (currentPopupReminderId == null) {
          const popup = $('reminderPopup');
          if (popup) popup.style.display = 'none';
          return;
        }

        const list = await getMyReminders();
        if (!Array.isArray(list)) {
          throw new Error("No se pudo obtener la lista de recordatorios.");
        }

        const rem = list.find(x => x.id === currentPopupReminderId);
        if (rem) {
          rem.active = false;

          // Actualizar en base de datos
          const ok = await updateReminder(rem);
          if (ok === false) {
            console.warn("No se pudo desactivar el recordatorio:", rem.id);
          }

          // Limpiar timers activos
          const e = reminderTimers.get(rem.id);
          if (e) {
            try {
              if (e.timeoutId) clearTimeout(e.timeoutId);
              if (e.intervalId) clearInterval(e.intervalId);
            } catch (timerErr) {
              console.error("Error al limpiar timers de recordatorio:", timerErr);
            }
          }
          reminderTimers.delete(rem.id);

          await refreshRemindersTable();
        } else {
          console.warn("No se encontr√≥ el recordatorio actual en la lista.");
        }

      } catch (err) {
        console.error("Excepci√≥n en stopRepeatForCurrent():", err);
        alert("Ocurri√≥ un problema al detener el recordatorio repetido.");
      } finally {
        // üîπ Asegurar cierre del popup y reinicio del estado
        try {
          const popup = $('reminderPopup');
          if (popup) popup.style.display = 'none';
        } catch (closeErr) {
          console.warn("Error al cerrar el popup de recordatorio:", closeErr);
        }
        currentPopupReminderId = null;
      }
    }


    async function requestNotificationsViaCheckbox(e) {
      if (!e.target.checked) return;
      if (!('Notification' in window)) {
        alert('Este navegador no soporta notificaciones.');
        e.target.checked = false;
        return;
      }
      if (Notification.permission === 'granted') {
        toast('Notificaciones activadas');
        return;
      }
      try {
        const perm = await Notification.requestPermission();
        if (perm === 'granted') toast('Notificaciones permitidas');
        else {
          alert('Notificaciones no permitidas.');
          e.target.checked = false;
        }
      } catch {
        e.target.checked = false;
        alert('No se pudo solicitar permiso.');
      }
    } // ‚Üê ESTA llave faltaba

    /* =========================
       Export/Import
       ========================= */
    async function exportDB() {
      try {
        if (!currentUser) {
          alert("Inicia sesi√≥n primero.");
          return;
        }

        // üîπ Obtener contactos y recordatorios en paralelo
        const [contactsRes, remindersRes] = await Promise.all([
          sb.from('contacts').select('*').eq('user_id', currentUser.id),
          sb.from('reminders').select('*').eq('user_id', currentUser.id)
        ]);

        // Verificar errores de Supabase
        if (contactsRes.error) throw contactsRes.error;
        if (remindersRes.error) throw remindersRes.error;

        const contacts = contactsRes.data || [];
        const reminders = remindersRes.data || [];

        // üîπ Crear estructura de exportaci√≥n
        const data = {
          meta: {
            app: "GuiaTelefonica",
            version: 2,
            exportedAt: new Date().toISOString(),
            user: currentUser.email
          },
          contacts,
          reminders
        };

        // üîπ Crear archivo JSON descargable
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `guia_telefonica_${currentUser.email}.json`;

        // Ejecutar descarga
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);

        toast("Exportaci√≥n completada");

      } catch (err) {
        console.error("Excepci√≥n en exportDB():", err);
        alert("No se pudo exportar la base de datos. Revisa tu conexi√≥n o vuelve a intentarlo.");
      }
    }

    async function importDBFromText(jsonText) {
      try {
        if (!currentUser) {
          alert("Inicia sesi√≥n primero.");
          return;
        }

        // 1Ô∏è‚É£ Parsear JSON
        let data;
        try {
          data = JSON.parse(jsonText);
        } catch (parseErr) {
          console.error("Error al parsear JSON:", parseErr);
          alert("El archivo JSON est√° corrupto o tiene formato inv√°lido.");
          return;
        }

        // 2Ô∏è‚É£ Extraer y validar estructuras base
        const contactsRaw = Array.isArray(data.contacts) ? data.contacts : [];
        const remindersRaw = Array.isArray(data.reminders) ? data.reminders : [];

        const contactsToInsert = [];
        const seen = new Set();

        // 3Ô∏è‚É£ Normalizar contactos
        for (const c of contactsRaw) {
          try {
            if (c.is_global === true || c.owner === "admin") continue;

            const name = (c.name ?? "").trim();
            if (!name) continue;

            const phone = (c.phone ?? "").trim();
            const email = (c.email ?? "").trim();
            const category = (c.category ?? "").trim();
            const codigo = (c.codigo ?? "").trim();

            const key = [name, phone, email, category, codigo].join("|").toLowerCase();
            if (seen.has(key)) continue;
            seen.add(key);

            contactsToInsert.push({
              user_id: currentUser.id,
              name, phone, email, category, codigo
            });
          } catch (innerErr) {
            console.warn("Error procesando contacto:", c, innerErr);
          }
        }

        // 4Ô∏è‚É£ Normalizar recordatorios
        const remindersToInsert = [];
        for (const r of remindersRaw) {
          try {
            const message = (r.message ?? "").trim();
            if (!message) continue;

            let whenIso;
            if (r.when_ts) {
              const t = new Date(r.when_ts);
              if (isNaN(t.getTime())) continue;
              whenIso = t.toISOString();
            } else if (r.whenTs) {
              const t = new Date(typeof r.whenTs === "number" ? r.whenTs : Date.parse(r.whenTs));
              if (isNaN(t.getTime())) continue;
              whenIso = t.toISOString();
            } else continue;

            remindersToInsert.push({
              user_id: currentUser.id,
              message,
              when_ts: whenIso,
              repeat: !!r.repeat,
              active: typeof r.active === "boolean" ? r.active : true
            });
          } catch (innerErr) {
            console.warn("Error procesando recordatorio:", r, innerErr);
          }
        }

        async function batchInsert(table, rows, size = 500) {
          try {
            if (!Array.isArray(rows) || rows.length === 0) {
              console.warn(`batchInsert(): no hay filas para insertar en ${table}.`);
              return;
            }

            console.info(`Iniciando inserci√≥n de ${rows.length} registros en '${table}' (tama√±o de lote: ${size})...`);

            let totalInserted = 0;

            for (let i = 0; i < rows.length; i += size) {
              const slice = rows.slice(i, i + size);

              try {
                const { error } = await sb.from(table).insert(slice);
                if (error) {
                  console.error(`Error insertando lote ${i / size + 1} en ${table}:`, error);
                  throw new Error(`${table}: ${error.message}`);
                }

                totalInserted += slice.length;
                console.info(`‚úîÔ∏è Insertado lote ${i / size + 1}: ${slice.length} registros`);
              } catch (innerErr) {
                // Si un lote falla, lo registramos y abortamos la operaci√≥n completa
                console.error(`‚ùå Fallo en lote ${i / size + 1} de '${table}':`, innerErr);
                throw innerErr;
              }
            }

            console.info(`‚úÖ Inserci√≥n completada en '${table}': ${totalInserted} registros insertados.`);

          } catch (err) {
            console.error(`Excepci√≥n en batchInsert(${table}):`, err);
            alert(`Error insertando datos en '${table}': ${err.message || err}`);
            throw err; // relanzamos para que el nivel superior (por ejemplo importDBFromText) decida si continuar
          }
        }


        // 6Ô∏è‚É£ Ejecutar inserciones si hay datos
        if (contactsToInsert.length) await batchInsert("contacts", contactsToInsert);
        if (remindersToInsert.length) await batchInsert("reminders", remindersToInsert);

        // 7Ô∏è‚É£ Refrescar UI y recordatorios
        await refreshList();
        await refreshRemindersTable();
        clearAllReminderTimers();
        await loadAndScheduleReminders();

        // 8Ô∏è‚É£ √âxito
        toast(`Importaci√≥n completada: ${contactsToInsert.length} contactos, ${remindersToInsert.length} recordatorios.`);

      } catch (err) {
        console.error("Excepci√≥n en importDBFromText():", err);
        alert("Error importando datos: " + (err?.message || err));
      }
    }


    function clearAllReminderTimers() { for (const e of reminderTimers.values()) { try { if (e.timeoutId) clearTimeout(e.timeoutId); if (e.intervalId) clearInterval(e.intervalId); } catch { } } reminderTimers.clear(); }

    /* =========================
       DOMContentLoaded
       ========================= */
    window.addEventListener('DOMContentLoaded', () => {
      // Formularios
      $('loginForm')?.addEventListener('submit', (e) => { e.preventDefault(); login(); });
      $('registerForm')?.addEventListener('submit', (e) => { e.preventDefault(); register(); });

      // Links/login
      $('linkGoRegister')?.addEventListener('click', (e) => { e.preventDefault(); showRegister(); });
      $('btnBackToLogin')?.addEventListener('click', showLogin);
      $('linkForgot')?.addEventListener('click', (e) => { e.preventDefault(); sendResetLink(); });

      // Sesi√≥n
      $('btnLogout')?.addEventListener('click', logout);

      // Recordatorios & varios
      $('btnOpenRemForm')?.addEventListener('click', async () => { showOverlay('reminderFormPopup', true); await refreshRemindersTable(); });
      $('btnCancelRemForm')?.addEventListener('click', () => showOverlay('reminderFormPopup', false));
      $('tabFormBtn')?.addEventListener('click', () => { });
      $('tabListBtn')?.addEventListener('click', async () => { await refreshRemindersTable(); });
      $('notifToggle')?.addEventListener('change', requestNotificationsViaCheckbox);
      $('btnStartWelcome')?.addEventListener('click', () => showOverlay('welcomePopup', false));
      $('btnSave')?.addEventListener('click', saveContact);
      $('btnClear')?.addEventListener('click', resetForm);

      // Filtros
      const debounce = (fn, wait = 250) => { let t; return (...a) => { clearTimeout(t); t = setTimeout(() => fn(...a), wait); }; };
      $('filterName')?.addEventListener('input', debounce(refreshList, 700));
      $('filterEmail')?.addEventListener('input', debounce(refreshList, 700));
      $('filterPhone')?.addEventListener('input', debounce(refreshList, 700));
      $('filterCategory')?.addEventListener('change', refreshList);

      $('btnScheduleRem')?.addEventListener('click', scheduleReminder);
      $('btnCloseReminder')?.addEventListener('click', () => $('reminderPopup').style.display = 'none');
      $('btnStopRepeat')?.addEventListener('click', stopRepeatForCurrent);
      $('accordionFilterBtn')?.addEventListener('click', () => {
        const btn = $('accordionFilterBtn'), c = $('accordionFilterContent'), ch = $('chevronFilter');
        const exp = btn.getAttribute('aria-expanded') === 'true';
        c.style.maxHeight = exp ? '0px' : (c.scrollHeight + 'px');
        btn.setAttribute('aria-expanded', String(!exp));
        ch.classList.toggle('up', !exp);
        ch.textContent = !exp ? '‚ñ≤' : '‚ñº';
      });

      $('btnExport')?.addEventListener('click', exportDB);
      $('btnImport')?.addEventListener('click', async () => {
        if (window.showOpenFilePicker) {
          try {
            const [handle] = await showOpenFilePicker({ multiple: false, types: [{ description: "JSON", accept: { "application/json": [".json"] } }] });
            const file = await handle.getFile(); const text = await file.text(); await importDBFromText(text); return;
          } catch (err) { if (err?.name === "AbortError") return; }
        }
        const inp = $('importFile'); if (inp) { inp.value = ""; inp.click(); }
      });
      $('importFile')?.addEventListener('change', async (e) => { const file = e.target.files?.[0]; if (!file) return; const text = await file.text(); await importDBFromText(text); });

      //rECORDATORIOS

      // Alternar entre pesta√±as del popup de recordatorios
      $('tabFormBtn')?.addEventListener('click', () => {
        try {
          // actualizar clases de pesta√±a
          $('tabFormBtn').classList.add('active');
          $('tabListBtn').classList.remove('active');

          // mostrar el contenido del formulario
          $('tabForm').classList.add('active');
          $('tabList').classList.remove('active');
        } catch (err) {
          console.error("Error al cambiar a pesta√±a 'Programar':", err);
        }
      });

      $('tabListBtn')?.addEventListener('click', async () => {
        try {
          // actualizar clases de pesta√±a
          $('tabListBtn').classList.add('active');
          $('tabFormBtn').classList.remove('active');

          // mostrar la tabla de recordatorios
          $('tabList').classList.add('active');
          $('tabForm').classList.remove('active');

          // cargar los recordatorios
          await refreshRemindersTable();
        } catch (err) {
          console.error("Error al cambiar a pesta√±a 'Mis recordatorios':", err);
          alert("No se pudieron cargar los recordatorios. Intenta nuevamente.");
        }
      });


      // Intento de sesi√≥n previa en esta pesta√±a (sessionStorage)
      (async () => {
        try {
          const { data: { session }, error } = await sb.auth.getSession();
          if (error) throw error;
          if (session?.user) {
            currentUser = session.user;
            await afterAuth();
            return;
          }
        } catch { }
        currentUser = null;
        showLogin();
        $('app').style.display = 'none';
      })();
    });
  </script>




</body>

</html>
