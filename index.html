<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8" />
  <title>Agenda de contactos</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: system-ui, sans-serif;
      max-width: 1000px;
      margin: 24px auto;
      padding: 0 12px;
    }
    
    h1 {
      margin-bottom: 8px;
    }

    fieldset {
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 12px;
      margin: 12px 0;
    }

    fieldset .contactsTbody {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 8px;
    }

    label {
      display: block;
      font-size: .9rem;
      margin: 6px 0 4px;
      font-weight: 600;
    }

    /* Inputs/selects */
    input {
      padding: 5px;
      font-size: 1rem;
      width: 200px;
    }

    select {
      padding: 5px;
      font-size: 1rem;
      width: 213px;
    }

    input,
    select {
      border: none;
      border-bottom: 2px solid #333;
      background: transparent;
      padding: 5px 0;
      font-size: 1rem;
      outline: none;
    }

    input,
    select {
      border-bottom: 1px solid #ccc;
    }

    input:focus,
    select:focus {
      border-bottom: 2px solid #007bff;
    }

    button {
      padding: 8px;
      font-size: 1rem;
      cursor: pointer;
      margin-right: 3px;
    }

    input::placeholder,
    select::placeholder {
      color: #999;
      opacity: 0.7;
    }

    #btnLogin {
      margin-top: 15px;
      background: #c3d8f1;
      border: 1px solid #00c3ff;
      padding: 9px;
      border-radius: 2px;
    }

    #btnLogout {
      background: #c3cff1;
      border: 1px solid #007bff;
      padding: 9px;
      border-radius: 2px;
    }

    #btnExport {
      background: #ebecdd;
      border: 1px solid #979779;
      padding: 9px;
      border-radius: 2px;
    }

    #btnImport {
      background: #f1dbc3;
      border: 1px solid #ffae00;
      padding: 9px;
      border-radius: 2px;
    }

    #btnOpenRemForm {
      background: #ecc3f1;
      border: 1px solid #ea00ff;
      padding: 9px;
      border-radius: 2px;
    }

    #btnSave {
      background: #c3f1d6;
      border: 1px solid #00ff15;
      padding: 9px;
      border-radius: 2px;
    }

    [id^="btn-edit-"] {
      background: #c3e2f1;
      border: 1px solid #00e1ff;
      padding: 4px;
      border-radius: 2px;
    }

    [id^="btn-delete-"] {
      background: #f1c3c3;
      border: 1px solid #f3623d;
      padding: 4px;
      border-radius: 2px;
    }

    #loginBox {
      position: absolute;
      /* lo sacamos del flujo normal */
      top: 50%;
      /* 50% desde arriba */
      left: 50%;
      /* 50% desde la izquierda */
      transform: translate(-50%, -50%);
      /* lo centra exactamente */

      width: 300px;
      height: auto;
      padding: 20px;
      border-radius: 8px;
      border: 1px solid #ddd;
      display: flex;
      flex-direction: column;
      gap: 10px;
      align-items: flex-start;
      /* mantiene alineados los elementos a la izquierda */
    }

    .actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      justify-content: flex-start;
      /* üëà alinea acciones a la izquierda */
    }

    #loginBox label {
      display: flex;
      align-items: center;
      justify-content: flex-start;
      /* üëà asegura que quede a la izquierda */
      gap: 6px;
      /* espacio entre checkbox y texto */
    }

    #loginBox input[type="checkbox"] {
      width: auto;
      height: auto;
      border: none;
      padding: 0;
      margin-right: 6px;
      /* espacio entre checkbox y texto */
    }

    #loginBox label {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-weight: normal;
    }

    #keepSession {
      margin-right: 6px;
      /* espacio entre el checkbox y el texto */
    }


    #registerBox {
      width: 300px;
      height: 280px;
      margin: 0 auto;
      margin-top: 110px;
      padding: 20px;
      border-radius: 8px;
      border: 1px solid #ddd;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    #btnRegister {
      background: #c3f1d6;
      border: 1px solid #00ff15;
      margin-top: 15px;
      padding: 9px;
      border-radius: 2px;
    }

    #btnBackToLogin {
      background: #c3cff1;
      border: 1px solid #007bff;
      margin-top: 15px;
      padding: 9px;
      border-radius: 2px;
    }

    .row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 8px;
    }

    .actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 8px;
    }

    th,
    td {
      border-bottom: 1px solid #eee;
      text-align: left;
      padding: 8px;
    }

    tr:hover {
      background: #fafafa;
    }

    .muted {
      color: #777;
      margin-top: 20px;
    }

    #linkGoRegister {
      display: block;
      width: fit-content;
      margin: 10px auto 0;
      text-align: center;
    }

    /* Overlay / Popup */
    .overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, .45);
      align-items: center;
      justify-content: center;
      z-index: 999;
    }

    .overlay .box {
      position: relative;
      background: #fff;
      color: #111;
      border-radius: 14px;
      padding: 16px;
      width: min(92vw, 720px);
      box-shadow: 0 20px 60px rgba(0, 0, 0, .35);
    }

    .modal-head {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 10px;
    }

    .modal-title {
      font-size: 1.4rem;
      font-weight: 700;
    }

    .modal-close {
      border: none;
      background: #ef4444;
      color: #fff;
      width: 28px;
      height: 28px;
      border-radius: 8px;
      display: grid;
      place-items: center;
      font-weight: 700;
      line-height: 1;
    }

    /* Tabs */
    .tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 10px;
    }

    .tabs button {
      border: 1px solid #ddd;
      background: #f5f5f5;
      border-radius: 10px;
      padding: 8px 12px;
      font-weight: 600;
    }

    .tabs button.active {
      background: #e7f0ff;
      border-color: #7aa7ff;
      color: #1f3b8f;
    }

    .tabview {
      display: none;
    }

    .tabview.active {
      display: block;
    }

    /* Form popup */
    .rem-form-grid {
      display: grid;
      grid-template-columns: repeat(3, minmax(160px, 1fr));
      gap: 16px 18px;
      align-items: end;
    }

    .rem-checks {
      margin-top: 6px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .rem-checks label {
      font-weight: 500;
      margin: 0;
    }

    .rem-footer {
      display: flex;
      justify-content: center;
      margin-top: 12px;
    }

    /* Acorde√≥n (filtros) */
    .accordion {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      user-select: none;
      padding: 8px 10px;
      border: 1px solid #ddd;
      border-radius: 8px;
      background: #fafafa;
    }

    .chevron {
      transition: transform .2s ease;
      font-size: 1.1rem;
      line-height: 1;
    }

    .chevron.up {
      transform: rotate(180deg);
    }

    .accordion-content {
      overflow: hidden;
      transition: max-height .25s ease;
      max-height: 0;
    }

    #accordionFilterContent .row {
      gap: 4px;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
    }

    #accordionFilterContent label {
      margin-top: 4px;
    }

    #accordionFilterContent {
      padding-top: 6px;
    }

    /* Campos inv√°lidos */
    .invalid {
      border-color: #dc2626 !important;
      outline-color: #dc2626 !important;
    }

    .hint {
      font-size: .8rem;
      color: #dc2626;
      display: none;
    }

    .hint.show {
      display: block;
    }

    /* Toast */
    #toast {
      position: fixed;
      left: 50%;
      bottom: 24px;
      transform: translateX(-50%);
      background: #111;
      color: #fff;
      padding: 10px 14px;
      border-radius: 8px;
      opacity: 0;
      pointer-events: none;
      transition: opacity .25s;
      z-index: 1000;
    }

    #toast.show {
      opacity: .95;
    }

    @media (max-width: 560px) {
      .rem-form-grid {
        grid-template-columns: 1fr 1fr;
      }
    }

    /* Layouts */
    .form-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 12px;
      align-items: start;
    }

    .form-grid .field {
      display: flex;
      flex-direction: column;
    }

    .form-grid input {
      width: 99%;
    }

    .form-grid select {
      width: 99%;
    }

    .auth-stack {
      display: grid;
      grid-template-columns: 1fr;
      gap: 10px;
      max-width: 360px;
    }

    .auth-stack input {
      width: 100%;
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 35px;
    }

    .header img {
      max-width: 90px;
      height: auto;
    }
  </style>
</head>

<body>
  <div class="header">
    <h1>Agenda de contactos</h1>
    <img src="https://res.cloudinary.com/dcjp6t6w9/image/upload/v1744806494/LOGO_POLIFANI_CUADRADO_qllmnj.jpg"
      alt="Logo-Polifani" />
  </div>

  <div id="content"></div>
  <div id="toast"></div>

  <!-- Popup bienvenida -->
  <div id="welcomePopup" class="overlay">
    <div class="box" style="text-align:center;">
      <h2 class="modal-title" style="margin:0 0 8px;">¬°Bienvenido!</h2>
      <p>Puedes empezar a gestionar tus contactos.</p>
      <div class="actions" style="justify-content:center; margin-top:12px;">
        <button id="btnStartWelcome">Comenzar</button>
      </div>
    </div>
  </div>

  <!-- Popup registro correcto -->
  <div id="registerPopup" class="overlay">
    <div class="box" style="text-align:center;">
      <div class="modal-head">
        <span class="modal-title">Registro completado</span>
        <button id="btnCloseRegisterPopup" class="modal-close">‚úï</button>
      </div>
      <p>Usuario creado. Ahora puedes iniciar sesi√≥n.</p>
    </div>
  </div>

  <!-- Popup recordatorio (disparo) -->
  <div id="reminderPopup" class="overlay">
    <div class="box" style="text-align:center;">
      <div class="modal-head">
        <span class="modal-title">Recordatorio</span>
        <button id="btnCloseReminder" class="modal-close">‚úï</button>
      </div>
      <p id="reminderText" style="margin-top:6px;"></p>
      <div class="actions" style="justify-content:center; margin-top:8px;">
        <button id="btnStopRepeat" style="display:none;">Detener repetici√≥n</button>
      </div>
    </div>
  </div>

  <!-- Popup formulario/lista de recordatorios -->
  <div id="reminderFormPopup" class="overlay">
    <div class="box">
      <div class="modal-head">
        <span class="modal-title">Recordatorios</span>
        <button id="btnCancelRemForm" style="margin-top:0px" class="modal-close" title="Cerrar">‚úï</button>
      </div>

      <div class="tabs">
        <button id="tabFormBtn" class="active">Programar</button>
        <button id="tabListBtn">Mis recordatorios</button>
      </div>

      <div id="tabForm" class="tabview active">
        <div class="rem-form-grid">
          <div>
            <label for="remDate">Fecha</label>
            <input type="date" id="remDate" />
          </div>
          <div>
            <label for="remTime">Hora</label>
            <input type="time" id="remTime" />
          </div>
          <div>
            <label for="remMsg">Mensaje</label>
            <input id="remMsg" placeholder="Texto del recordatorio" />
          </div>
          <div class="rem-checks" style="grid-column: 1 / -1;">
            <label><input type="checkbox" id="notifToggle" /> Permitir notificaciones</label>
            <label><input type="checkbox" id="remRepeat" /> Repetir cada 10 minutos</label>
          </div>
        </div>
        <div class="rem-footer">
          <button id="btnScheduleRem">Programar</button>
        </div>
        <p class="muted" id="reminderStatus" style="min-height:18px; text-align:center;"></p>
      </div>

      <div id="tabList" class="tabview">
        <div style="overflow:auto; max-height:45vh;">
          <table>
            <thead>
              <tr>
                <th>Fecha y hora</th>
                <th>Mensaje</th>
                <th>Repite</th>
                <th>Estado</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody id="remindersTbody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>





  <!-- Inicio de sesi√≥n -->
  <fieldset id="loginBox">
    <legend>Inicio de sesi√≥n</legend>
    <form id="loginForm" autocomplete="on" novalidate action="javascript:void(0);">

      <div class="auth-stack">
        <div class="field">
          <label for="username">Usuario</label>
          <input id="username" name="username" type="email" autocomplete="username" placeholder="Usuario" />
        </div>

        <div class="field">
          <label for="password">Contrase√±a</label>
          <input id="password" name="password" type="password" autocomplete="current-password"
            placeholder="Contrase√±a" />
        </div>

      </div>

      <div class="actions" style="margin-top:8px; align-items:center;">
        <button id="btnLogin" type="button">Iniciar sesi√≥n</button>
      </div>

      <a id="linkGoRegister" href="#" class="muted" style="margin-left:8px;">Registrarse</a>
      <br>
      <div>
        <label>
          <input id="keepSession" type="checkbox" checked />
          Mantener sesi√≥n iniciada
        </label>
      </div>
    </form>

   

    <div style="margin-top:6px;">
      <a id="linkForgot" href="#" class="muted">¬øOlvidaste tu contrase√±a?</a>
    </div>
  </fieldset>





















  <!-- Registro -->
  <fieldset id="registerBox" style="display:none;">
    <legend>Registro</legend>
    <form id="registerForm" autocomplete="on">
      <div class="auth-stack">
        <div class="field">
          <label for="regUsername">Usuario</label>
          <input id="regUsername" name="username" type="email" autocomplete="username" placeholder="Usuario" />
          <small id="userHintReg" class="hint">Ese usuario ya existe.</small>
        </div>
        <div class="field">
          <label for="regPassword">Contrase√±a</label>
          <input id="regPassword" name="new-password" type="password" autocomplete="new-password"
            placeholder="Contrase√±a" />
        </div>
      </div>
      <div class="actions" style="margin-top:8px; flex-wrap:wrap; gap:8px;">
        <button id="btnRegister" type="submit">Registrarse</button>
        <button id="btnBackToLogin" type="button">Volver</button>
      </div>
    </form>
  </fieldset>

  <!-- App -->
  <div id="app" style="display:none;">
    <p style="display:flex; align-items:center; justify-content:space-between; gap:8px;">
      <span>Bienvenido, <strong id="userName"></strong></span>
      <span>
        <button id="btnExport" title="Exportar a JSON">Exportar</button>
        <button id="btnImport" title="Importar desde JSON">Importar</button>
        <input id="importFile" type="file" accept="application/json" hidden>
        <button id="btnOpenRemForm" title="Nuevo recordatorio">Nuevo recordatorio</button>
        <button id="btnLogout" title="Cerrar sesi√≥n">Cerrar sesi√≥n</button>
      </span>
    </p>

    <fieldset>
      <legend id="formLegend">Agregar contacto</legend>
      <div class="form-grid">
        <div class="field">
          <label for="contactName">Nombre *</label>
          <input id="contactName" placeholder="Nombre" />
          <small id="nameHint" class="hint">El nombre es obligatorio.</small>
        </div>
        <div class="field">
          <label for="contactPhone">Tel√©fono</label>
          <input id="contactPhone" placeholder="Tel√©fono" />
          <small id="phoneHint" class="hint">Introduce un tel√©fono v√°lido.</small>
        </div>
        <div class="field">
          <label for="contactEmail">Email</label>
          <input id="contactEmail" placeholder="Email" />
          <small id="emailHint" class="hint">Introduce un email v√°lido.</small>
        </div>
        <div class="field">
          <label for="contactCategory">Categor√≠a *</label>
          <select id="contactCategory"></select>
          <small id="catHint" class="hint">Selecciona una categor√≠a.</small>
        </div>
        <div class="field">
          <label for="contactCodigo">C√≥digo Mediador</label>
          <input id="contactCodigo" placeholder="C√≥digo Mediador" />
        </div>
      </div>
      <div class="actions" style="margin-top:8px;">
        <button id="btnSave">Guardar</button>
        <button id="btnClear" type="button">Limpiar</button>
        <span class="muted" id="editHint" style="display:none;">Editando contacto existente‚Ä¶</span>
      </div>
    </fieldset>

    <fieldset>
      <legend>Buscar y filtrar</legend>
      <div id="accordionFilterBtn" class="accordion" aria-expanded="false">
        <span id="chevronFilter" class="chevron">‚ñº</span>
        <strong>Mostrar filtros</strong>
      </div>
      <div id="accordionFilterContent" class="accordion-content">
        <div>
          <div class="row">
            <div>
              <label for="filterName">Nombre</label>
              <input id="filterName" placeholder="Nombre" />
            </div>
            <div>
              <label for="filterPhone">Tel√©fono</label>
              <input id="filterPhone" placeholder="Tel√©fono" />
            </div>
            <div>
              <label for="filterEmail">Email</label>
              <input id="filterEmail" placeholder="Email" />
            </div>
            <div>
              <label for="filterCategory">Categor√≠a</label>
              <select id="filterCategory">
                <option value="all">Todas</option>
              </select>
            </div>
          </div>
        </div>
      </div>
    </fieldset>

    <fieldset>
      <legend>Contactos</legend>
      <table>
        <thead>
          <tr>
            <th>Nombre</th>
            <th>Tel√©fono</th>
            <th>Email</th>
            <th>Categor√≠a</th>
            <th>C√≥digo Mediador</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody id="contactsTbody"></tbody>
      </table>
    </fieldset>
  </div>

<script type="module">
  import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

  const SUPABASE_URL = "https://euejoapezqbflobpdklk.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV1ZWpvYXBlenFiZmxvYnBka2xrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc0MTU0MTMsImV4cCI6MjA3Mjk5MTQxM30.BwK_NSGHOFjjitsjdJy0cCo9TQSwd49UjL5FoEOoaB4";

  // Cliente Supabase
  const sb = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
    auth: { persistSession: true, autoRefreshToken: true }
  });
  window.supabase = sb;

  /* ---------------- Utils UI ---------------- */
  let currentUser = null;
  let currentEditId = null;
  const DEFAULT_CATEGORIES = ["Siniestros","Gr√∫as","Asistencia","Salud","Administraciones","Contactos","Otros"];
  const reminderTimers = new Map(); let currentPopupReminderId = null;

  const $ = (id) => document.getElementById(id);
  const toast = (msg, ms=1200) => { const t=$('toast'); if(!t) return; t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'), ms); };
  const showOverlay = (id, show=true) => { const el=$(id); if(el) el.style.display = show ? 'flex' : 'none'; };
  const setInvalid = (el,hint,inv)=>{ if(!el) return; el.classList.toggle('invalid',!!inv); if(hint) hint.classList.toggle('show',!!inv); };
  const isValidEmail = (v)=> !v || /^[^\s@]+@[^\s@]+\.[^\s@]{2,}$/.test(v.trim());
  const isValidPhone = (v)=> !v || /^[0-9+\s\-()]{6,20}$/.test(v.trim());
  const normalize = (s)=> (s||"").toString().toLowerCase();

  function requireUser(){ if(!currentUser) throw new Error("No hay usuario autenticado"); return currentUser; }
  function showLogin(){ $('loginBox').style.display="block"; $('registerBox').style.display="none"; }
  function showRegister(){ $('loginBox').style.display="none"; $('registerBox').style.display="block"; $('regUsername')?.classList.remove("invalid"); $('userHintReg')?.classList.remove("show"); }

  // (opcional)
  function clearPersistedSupabaseSession(){
    try{
      const keys = Object.keys(localStorage).filter(k => k.startsWith("sb-"));
      for(const k of keys){ sessionStorage.setItem(k, localStorage.getItem(k)); localStorage.removeItem(k); }
    }catch{}
  }

  /* ---------------- Auth ---------------- */
  const normUser = (u)=> (u||"").trim().toLowerCase();

  async function register(){
    const email = normUser($("regUsername").value);
    const password = $("regPassword").value;
    if(!email || !password){ alert("Completa usuario (email) y contrase√±a."); return; }
    const { error } = await sb.auth.signUp({ email, password });
    if(error){ alert("Error al registrar: " + error.message); return; }
    showOverlay('registerPopup', true);
    showLogin();
  }

  // (Opcional) RPC para comprobar usuario
  async function checkUserExists(email){
    try{
      const { data, error } = await sb.rpc('user_exists', { email_input: email });
      if(error) return null;
      return !!data;
    }catch{ return null; }
  }

 async function login() {
  console.log('login() start');
  const btn = $('btnLogin');
  try {
    const email = normUser($("username").value);
    const password = $("password").value;
    if (!email || !password) { alert("Completa usuario y contrase√±a."); return; }

    // UI: bloquea bot√≥n mientras se autentica
    if (btn) { btn.disabled = true; btn.textContent = 'Entrando‚Ä¶'; }

    console.time('supabase.signIn'); // medir cu√°nto tarda realmente
    const { data, error } = await sb.auth.signInWithPassword({ email, password });
    console.timeEnd('supabase.signIn');

    console.log('Respuesta signIn:', { data, error });

    if (error) {
      alert(`${error.status || ''} ${error.name || ''} - ${error.message}`);
      return;
    }

    console.log('signIn OK ‚Üí afterAuth');
    await afterAuth();
    console.log('login() end');
  } catch (e) {
    console.error('login() exception:', e);
    alert('Error de login: ' + (e?.message || e));
  } finally {
    if (btn) { btn.disabled = false; btn.textContent = 'Iniciar sesi√≥n'; }
  }
}


  async function sendResetLink(){
    const email = normUser($("username").value);
    if(!email){ alert("Escribe tu email en 'Usuario' y vuelve a pulsar '¬øOlvidaste tu contrase√±a?'"); return; }
    const redirectTo = `${window.location.origin}/#/recuperar`;
    const { error } = await sb.auth.resetPasswordForEmail(email, { redirectTo });
    if(error){ alert("No se pudo enviar el correo: " + error.message); return; }
    alert("Te hemos enviado un email con el enlace para restablecer tu contrase√±a.");
  }

  async function logout(){
    try{ await sb.auth.signOut(); }catch(e){ alert('No se pudo cerrar sesi√≥n: ' + (e?.message || e)); }
  }

  function clearAllReminderTimers(){
    try{
      for(const [id, t] of reminderTimers.entries()){
        if(t?.timeoutId) clearTimeout(t.timeoutId);
        if(t?.intervalId) clearInterval(t.intervalId);
        reminderTimers.delete(id);
      }
    }catch(e){ console.warn('clearAllReminderTimers error', e); }
  }

  async function afterAuth(){
    try{
      const { data:{ user } } = await sb.auth.getUser();
      currentUser = user;
      if(!currentUser){ showLogin(); return; }
      $('loginBox').style.display="none";
      $('registerBox').style.display="none";
      $('app').style.display="block";
      $('userName').textContent = user.email || "";
      resetForm();
      await ensureCategoryOptions();
      await refreshList();
      await refreshRemindersTable();
      clearAllReminderTimers();
      await loadAndScheduleReminders();
      showOverlay('welcomePopup', true);
    }catch(e){
      console.error('afterAuth error:', e);
      alert('Hubo un error al cargar la app: ' + (e?.message || e));
    }
  }

  // Escucha cambios de sesi√≥n (incluye PASSWORD_RECOVERY)
  const { data: { subscription } } = sb.auth.onAuthStateChange(async (event, session) => {
    switch(event){
      case 'SIGNED_IN':
      case 'TOKEN_REFRESHED':
      case 'USER_UPDATED':
        currentUser = session?.user ?? null;
        await afterAuth();
        break;
      case 'PASSWORD_RECOVERY': {
        const newPassword = prompt("Introduce tu nueva contrase√±a:");
        if(!newPassword) return;
        const { error } = await sb.auth.updateUser({ password: newPassword });
        if(error){ alert("No se pudo actualizar la contrase√±a: " + error.message); return; }
        alert("Contrase√±a actualizada. Ya puedes iniciar sesi√≥n.");
        break;
      }
      case 'SIGNED_OUT':
        currentUser = null;
        showLogin();
        $('app').style.display = 'none';
        break;
    }
  });

  // Limpieza del subscription (una sola vez)
  const off = () => { try { subscription?.unsubscribe(); } catch {} };
  window.addEventListener('pagehide', off, { once: true });
  document.addEventListener('visibilitychange', () => {
    if (document.visibilityState === 'hidden') off();
  }, { once: true });

  /* ---------------- Contactos & Recordatorios ---------------- */
  function resetForm(){
    currentEditId=null;
    ['contactName','contactPhone','contactEmail','contactCodigo'].forEach(id=>$(id).value='');
    $('contactCategory').selectedIndex=0;
    ['contactName','contactEmail','contactPhone','contactCategory'].forEach(id=>setInvalid($(id),null,false));
    ['nameHint','emailHint','phoneHint','catHint'].forEach(id=>$(id).classList.remove('show'));
    $("formLegend").textContent="Agregar contacto"; $("editHint").style.display="none"; $("btnSave").textContent="Guardar";
  }

  async function ensureCategoryOptions(){
    const formSel=$("contactCategory"), filterSel=$("filterCategory");
    const prevForm=formSel.value, prevFilter=filterSel.value;
    formSel.innerHTML="";
    for(const cat of ["",...DEFAULT_CATEGORIES]){ const o=document.createElement("option"); o.value=cat; o.textContent=cat?cat:"‚Äî Selecciona ‚Äî"; formSel.appendChild(o); }
    filterSel.innerHTML=""; const a=document.createElement("option"); a.value="all"; a.textContent="Todas"; filterSel.appendChild(a);
    for(const cat of DEFAULT_CATEGORIES){ const o=document.createElement("option"); o.value=cat; o.textContent=cat; filterSel.appendChild(o); }
    if([...formSel.options].some(o=>o.value===prevForm)) formSel.value=prevForm;
    if([...filterSel.options].some(o=>o.value===prevFilter)) filterSel.value=prevFilter;
  }

  function validateContactForm(){
    const n=$("contactName"), e=$("contactEmail"), t=$("contactPhone"), c=$("contactCategory"); let ok=true;
    if(!n.value.trim()){ setInvalid(n, $("nameHint"), true); ok=false; } else setInvalid(n, $("nameHint"), false);
    if(!isValidEmail(e.value)){ setInvalid(e, $("emailHint"), true); ok=false; } else setInvalid(e, $("emailHint"), false);
    if(!isValidPhone(t.value)){ setInvalid(t, $("phoneHint"), true); ok=false; } else setInvalid(t, $("phoneHint"), false);
    if(!c.value){ setInvalid(c, $("catHint"), true); ok=false; } else setInvalid(c, $("catHint"), false);
    return ok;
  }

  async function saveContact(){
    if(!validateContactForm()) return;
    const user = requireUser();
    const obj = {
      user_id: user.id,
      name: $("contactName").value.trim(),
      phone: $("contactPhone").value.trim(),
      email: $("contactEmail").value.trim(),
      category: $("contactCategory").value.trim(),
      codigo: $("contactCodigo").value.trim()
    };
    if(currentEditId==null){
      const { error } = await sb.from('contacts').insert(obj);
      if(error){ alert("No se pudo guardar: " + error.message); return; }
    }else{
      const { error } = await sb.from('contacts').update(obj).eq('id', Number(currentEditId)).eq('user_id', user.id);
      if(error){ alert("No se pudo actualizar: " + error.message); return; }
    }
    resetForm(); refreshList();
  }

  async function getContactsForList(){
    let q = sb.from('contacts').select('*');
    const fName   = normalize($("filterName").value);
    const fEmail  = normalize($("filterEmail").value);
    const fPhone  = normalize($("filterPhone").value);
    const fCatVal = $("filterCategory").value;
    if(fName)  q = q.ilike('name', `%${fName}%`);
    if(fEmail) q = q.ilike('email', `%${fEmail}%`);
    if(fPhone) q = q.ilike('phone', `%${fPhone}%`);
    if(fCatVal && fCatVal !== 'all') q = q.eq('category', fCatVal);
    const { data, error } = await q.order('name', { ascending: true });
    if(error){ alert("Error listando contactos: " + error.message); return []; }
    return (data||[]).map(c => ({ ...c, readonly: c.is_global === true }));
  }

  async function editContact(id){
    const user = requireUser();
    const { data, error } = await sb.from('contacts').select('*').eq('id', Number(id)).eq('user_id', user.id).single();
    if(error){ alert("No se pudo cargar: " + error.message); return; }
    const c=data;
    currentEditId=c.id;
    $("contactName").value=c.name||"";
    $("contactPhone").value=c.phone||"";
    $("contactEmail").value=c.email||"";
    $("contactCodigo").value=c.codigo||"";
    $("contactCategory").value=(c.category||"");
    $("formLegend").textContent="Modificar contacto"; $("editHint").style.display="inline"; $("btnSave").textContent="Guardar cambios";
  }

  async function deleteContact(id){
    const user = requireUser();
    if(!confirm("¬øBorrar el contacto seleccionado?")) return;
    const { error } = await sb.from('contacts').delete().eq('id', Number(id)).eq('user_id', user.id);
    if(error){ alert("No se pudo borrar: " + error.message); return; }
    if(currentEditId===Number(id)) resetForm();
    refreshList();
  }

  async function refreshList(){
    await ensureCategoryOptions();
    const tbody=$("contactsTbody"); tbody.innerHTML="";
    const rows=await getContactsForList();
    if(rows.length===0){
      const tr=document.createElement("tr"); const td=document.createElement("td");
      td.colSpan=6; td.className="muted"; td.textContent="No hay contactos que coincidan.";
      tr.appendChild(td); tbody.appendChild(tr); return;
    }
    for(const c of rows){
      const tr=document.createElement("tr");
      const td=(t)=>{ const x=document.createElement("td"); x.textContent=t||""; return x; };
      tr.appendChild(td(c.name)); tr.appendChild(td(c.phone)); tr.appendChild(td(c.email)); tr.appendChild(td(c.category)); tr.appendChild(td(c.codigo));
      const tdActions=document.createElement("td");
      const e=document.createElement("button"); e.id=`btn-edit-${c.id}`; e.textContent="‚úèÔ∏è"; e.onclick=()=>editContact(c.id); e.disabled=c.readonly;
      const d=document.createElement("button"); d.id=`btn-delete-${c.id}`; d.textContent="üóëÔ∏è"; d.onclick=()=>deleteContact(c.id); d.disabled=c.readonly;
      tdActions.appendChild(e); tdActions.appendChild(d); tr.appendChild(tdActions);
      tbody.appendChild(tr);
    }
  }

  // ---- Recordatorios ----
  async function sbUser(){ const { data:{ user }, error } = await sb.auth.getUser(); if(error) throw error; if(!user) throw new Error("No hay usuario autenticado."); return user; }
  async function addReminder({ message, whenTs, repeat }){ const user=await sbUser(); const whenIso=new Date(whenTs).toISOString(); const { data, error }=await sb.from("reminders").insert({ user_id:user.id, message, when_ts:whenIso, repeat:!!repeat, active:true }).select("id").single(); if(error){ alert("No se pudo guardar el recordatorio: "+error.message); throw error; } return data.id; }
  async function getMyReminders(){ const user=await sbUser(); const { data, error }=await sb.from("reminders").select("id, message, when_ts, repeat, active").eq("user_id", user.id).order("when_ts", { ascending:true }); if(error){ alert("Error cargando recordatorios: "+error.message); return []; } return data.map(r=>({ id:r.id, message:r.message, repeat:r.repeat, active:r.active, whenTs:new Date(r.when_ts).getTime() })); }
  async function updateReminder(rem){ const user=await sbUser(); const payload={ message:rem.message, when_ts:new Date(rem.whenTs).toISOString(), repeat:!!rem.repeat, active:!!rem.active }; const { error }=await sb.from("reminders").update(payload).eq("id", rem.id).eq("user_id", user.id); if(error) alert("No se pudo actualizar recordatorio: "+error.message); }
  async function deleteReminder(id){ const user=await sbUser(); const { error }=await sb.from("reminders").delete().eq("id", Number(id)).eq("user_id", user.id); if(error) alert("No se pudo borrar recordatorio: "+error.message); }
  async function refreshRemindersTable(){ const tbody=$("remindersTbody"); tbody.innerHTML=""; const list=await getMyReminders(); list.sort((a,b)=>a.whenTs-b.whenTs); if(list.length===0){ const tr=document.createElement("tr"); const td=document.createElement("td"); td.colSpan=5; td.className="muted"; td.textContent="No hay recordatorios."; tr.appendChild(td); tbody.appendChild(tr); return; } for(const r of list){ const tr=document.createElement("tr"); const when=new Date(r.whenTs); const td=(t)=>{ const x=document.createElement("td"); x.textContent=t; return x; }; tr.appendChild(td(when.toLocaleString())); tr.appendChild(td(r.message)); tr.appendChild(td(r.repeat?"Cada 10 min":"No")); const tdAct=document.createElement("td"); tdAct.innerHTML=r.active?'<span style="color:#065f46;font-weight:600">Activo</span>':'<span style="color:#7c2d12;font-weight:600">Inactivo</span>'; tr.appendChild(tdAct); const tdActions=document.createElement("td"); const tgl=document.createElement("button"); tgl.textContent=r.active?"Desactivar":"Activar"; tgl.onclick=async()=>{ await toggleReminderActive(r.id,!r.active); }; const del=document.createElement("button"); del.textContent="Borrar"; del.style.marginLeft="6px"; del.onclick=async()=>{ const e=reminderTimers.get(r.id); if(e){ if(e.timeoutId) clearTimeout(e.timeoutId); if(e.intervalId) clearInterval(e.intervalId); } reminderTimers.delete(r.id); await deleteReminder(r.id); await refreshRemindersTable(); }; tdActions.appendChild(tgl); tdActions.appendChild(del); tr.appendChild(tdActions); tbody.appendChild(tr); } }
  function sendSystemNotification(message){ try{ if('Notification'in window && Notification.permission==='granted'){ const n=new Notification('Recordatorio',{body:message}); n.onclick=()=>{ window.focus(); $('reminderPopup').style.display='none'; }; } }catch{} }
  function scheduleReminderInMemory(rem){ const ex=reminderTimers.get(rem.id); if(ex){ if(ex.timeoutId) clearTimeout(ex.timeoutId); if(ex.intervalId) clearInterval(ex.intervalId); } reminderTimers.delete(rem.id); if(!rem.active) return; const entry={timeoutId:null,intervalId:null}; const trigger=()=>{ currentPopupReminderId=rem.id; sendSystemNotification(rem.message); showReminderPopup(rem.message, rem.repeat); if(rem.repeat && rem.active){ entry.intervalId=setInterval(()=>{ currentPopupReminderId=rem.id; sendSystemNotification(rem.message); showReminderPopup(rem.message,true); }, 10*60*1000); reminderTimers.set(rem.id, entry); } }; const diff=rem.whenTs-Date.now(); if(diff<=0) trigger(); else { entry.timeoutId=setTimeout(trigger,diff); reminderTimers.set(rem.id, entry); } }
  async function loadAndScheduleReminders(){ const list=await getMyReminders(); for(const r of list) scheduleReminderInMemory(r); }
  async function toggleReminderActive(id, makeActive){ const e=reminderTimers.get(id); if(e){ if(e.timeoutId) clearTimeout(e.timeoutId); if(e.intervalId) clearInterval(e.intervalId); } reminderTimers.delete(id); const list=await getMyReminders(); const rem=list.find(x=>x.id===id); if(!rem) return; rem.active=makeActive; await updateReminder(rem); if(makeActive) scheduleReminderInMemory(rem); await refreshRemindersTable(); }
  async function scheduleReminder(){ const date=$('remDate').value, time=$('remTime').value, msg=$('remMsg').value.trim(), repeat=$('remRepeat').checked; if(!date||!time||!msg){ alert('Completa fecha, hora y mensaje.'); return; } const target=new Date(`${date}T${time}`); if(isNaN(target.getTime())) return alert('Fecha u hora no v√°lidas.'); if(target.getTime()<=Date.now()) return alert('La fecha y hora deben ser futuras.'); const id=await addReminder({message:msg, whenTs:target.getTime(), repeat}); const list=await getMyReminders(); const rem=list.find(r=>r.id===id); if(rem) scheduleReminderInMemory(rem); $('reminderStatus').textContent=`Guardado para ${target.toLocaleString()}${repeat?' (cada 10 min)':''}.`; setTimeout(()=>{ showOverlay('reminderFormPopup', false); $('reminderStatus').textContent=''; $('remDate').value=''; $('remTime').value=''; $('remMsg').value=''; $('remRepeat').checked=false; toast('Recordatorio programado'); }, 700); await refreshRemindersTable(); }
  function showReminderPopup(message,repeating){ $('reminderText').textContent=message; $('reminderPopup').style.display='flex'; $('btnStopRepeat').style.display=repeating?'inline-block':'none'; }
  async function stopRepeatForCurrent(){ if(currentPopupReminderId==null){ $('reminderPopup').style.display='none'; return; } const list=await getMyReminders(); const rem=list.find(r=>r.id===currentPopupReminderId); if(rem){ rem.active=false; await updateReminder(rem); const e=reminderTimers.get(rem.id); if(e){ if(e.timeoutId) clearTimeout(e.timeoutId); if(e.intervalId) clearInterval(e.intervalId); } reminderTimers.delete(rem.id); await refreshRemindersTable(); } $('reminderPopup').style.display='none'; currentPopupReminderId=null; }
    async function requestNotificationsViaCheckbox(e){
    if(!e.target.checked) return;
    if(!('Notification' in window)){
      alert('Este navegador no soporta notificaciones.');
      e.target.checked=false;
      return;
    }
    if(Notification.permission==='granted'){
      toast('Notificaciones activadas');
      return;
    }
    try{
      const perm=await Notification.requestPermission();
      if(perm==='granted') {
        toast('Notificaciones permitidas');
      } else {
        alert('Notificaciones no permitidas.');
        e.target.checked=false;
      }
    } catch{
      e.target.checked=false;
      alert('No se pudo solicitar permiso.');
    }
  } // üëà ESTA llave faltaba







/* ---------------- Export / Import (Supabase) ---------------- */

// Helper: descargar JSON
function downloadJSON(filename, obj){
  const blob = new Blob([JSON.stringify(obj, null, 2)], { type: "application/json" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = filename; a.click();
  URL.revokeObjectURL(url);
  toast("Exportaci√≥n lista");
}

// EXPORTA contactos + recordatorios del usuario actual
async function exportDB(){
  try{
    const user = requireUser();

    const [cRes, rRes] = await Promise.all([
      sb.from("contacts")
        .select("id,name,phone,email,category,codigo,created_at,updated_at")
        .eq("user_id", user.id)
        .order("name", { ascending: true }),
      sb.from("reminders")
        .select("id,message,when_ts,repeat,active,created_at,updated_at")
        .eq("user_id", user.id)
        .order("when_ts", { ascending: true })
    ]);
    if (cRes.error) throw cRes.error;
    if (rRes.error) throw rRes.error;

    const payload = {
      exportedAt: new Date().toISOString(),
      schema: "v1",               // por si cambias estructura en el futuro
      userEmail: user.email || "",
      contacts: cRes.data ?? [],
      reminders: rRes.data ?? []
    };
    downloadJSON("agenda-backup.json", payload);
  } catch (e){
    alert("No se pudo exportar: " + (e?.message || e));
  }
}

// IMPORTA un JSON y lo guarda en Supabase para el usuario actual
async function importDBFromText(text){
  try{
    const user = requireUser();
    let json;
    try { json = JSON.parse(text); }
    catch { alert("Archivo JSON inv√°lido."); return; }

    // Acepta formato nuevo {contacts, reminders} o arrays legados
    const contacts = Array.isArray(json) ? json : (Array.isArray(json.contacts) ? json.contacts : []);
    const reminders = Array.isArray(json.reminders) ? json.reminders : [];

    // Normaliza/valida
    const cleanContacts = contacts.map(c => ({
      user_id: user.id,
      name: (c.name||"").toString().trim(),
      phone: (c.phone||"").toString().trim(),
      email: (c.email||"").toString().trim(),
      category: (c.category||"").toString().trim(),
      codigo: (c.codigo||"").toString().trim()
    })).filter(c => c.name);

    const cleanReminders = reminders.map(r => ({
      user_id: user.id,
      message: (r.message||"").toString().trim(),
      when_ts: r.when_ts ? new Date(r.when_ts).toISOString() : new Date().toISOString(),
      repeat: !!r.repeat,
      active: r.active !== false
    })).filter(r => r.message);

    // Opci√≥n A (simple): INSERTS por lotes
    const chunk = async (arr, size, insertFn) => {
      for (let i=0; i<arr.length; i+=size){
        const part = arr.slice(i, i+size);
        const { error } = await insertFn(part);
        if (error) throw error;
      }
    };
    if (cleanContacts.length){
      // Opci√≥n A: conflicto por columnas
      await sb.from("contacts")
        .upsert(cleanContacts, { onConflict: "user_id,name,email,phone" });

      // Opci√≥n B: conflicto por nombre de la constraint √∫nica
      // await sb.from("contacts").upsert(cleanContacts, { onConflict: "contacts_unq" });
    }

    if (cleanReminders.length){
      await chunk(cleanReminders, 500, batch => sb.from("reminders").insert(batch));
    }

    // Opci√≥n B (evitar duplicados): usa upsert con unique constraint (ver notas abajo)
    // await sb.from("contacts").upsert(cleanContacts, { onConflict: "user_id,name,email,phone" });

    toast("Importaci√≥n completada");
    await refreshList();
    await refreshRemindersTable();
    await loadAndScheduleReminders();
  } catch (e){
    alert("No se pudo importar: " + (e?.message || e));
  }
}










  /* ---------------- Arranque: listeners ---------------- */
  window.addEventListener('DOMContentLoaded', () => {
    const btn = $('btnLogin');
    const lf  = $('loginForm');

    if (lf) lf.addEventListener('submit', (e) => { e.preventDefault(); e.stopPropagation(); });
    if (btn) btn.addEventListener('click', (e) => { e.preventDefault(); login(); });

    console.log('DOM listo, listeners login:', { hasForm: !!lf, hasBtn: !!btn });

    $('registerForm')?.addEventListener('submit', (e)=>{ e.preventDefault(); register(); });

    $('linkGoRegister')?.addEventListener('click', (e)=>{ e.preventDefault(); showRegister(); });
    $('btnBackToLogin')?.addEventListener('click', showLogin);
    $('linkForgot')?.addEventListener('click', (e)=>{ e.preventDefault(); sendResetLink(); });

    $('btnLogout')?.addEventListener('click', logout);

    $('btnOpenRemForm')?.addEventListener('click', async ()=>{ showOverlay('reminderFormPopup', true); await refreshRemindersTable(); });
    $('btnCancelRemForm')?.addEventListener('click', ()=> showOverlay('reminderFormPopup', false));
    $('tabFormBtn')?.addEventListener('click', ()=>{});
    $('tabListBtn')?.addEventListener('click', async ()=>{ await refreshRemindersTable(); });
    $('notifToggle')?.addEventListener('change', requestNotificationsViaCheckbox);
    $('btnStartWelcome')?.addEventListener('click', ()=> showOverlay('welcomePopup', false));
    $('btnSave')?.addEventListener('click', saveContact);
    $('btnClear')?.addEventListener('click', resetForm);

    const debounce=(fn,wait=250)=>{ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), wait); }; };
    $('filterName')?.addEventListener('input', debounce(refreshList,200));
    $('filterEmail')?.addEventListener('input', debounce(refreshList,200));
    $('filterPhone')?.addEventListener('input', debounce(refreshList,200));
    $('filterCategory')?.addEventListener('change', refreshList);

    $('btnScheduleRem')?.addEventListener('click', scheduleReminder);
    $('btnCloseReminder')?.addEventListener('click', ()=> $('reminderPopup').style.display='none');
    $('btnStopRepeat')?.addEventListener('click', stopRepeatForCurrent);
    $('accordionFilterBtn')?.addEventListener('click', ()=> {
      const btn=$('accordionFilterBtn'), c=$('accordionFilterContent'), ch=$('chevronFilter');
      const exp=btn.getAttribute('aria-expanded')==='true';
      c.style.maxHeight = exp ? '0px' : (c.scrollHeight+'px');
      btn.setAttribute('aria-expanded', String(!exp));
      ch.classList.toggle('up', !exp);
      ch.textContent = !exp ? '‚ñ≤' : '‚ñº';
    });

    $('btnExport')?.addEventListener('click', exportDB);
    $('btnImport')?.addEventListener('click', async ()=> {
      if (window.showOpenFilePicker) {
        try {
          const [handle] = await showOpenFilePicker({ multiple:false, types:[{ description:"JSON", accept:{ "application/json": [".json"] } }] });
          const file = await handle.getFile(); const text = await file.text(); await importDBFromText(text); return;
        } catch (err) { if (err?.name === "AbortError") return; }
      }
      const inp = $('importFile'); if (inp){ inp.value=""; inp.click(); }
    });
    $('importFile')?.addEventListener('change', async (e)=>{ const file=e.target.files?.[0]; if(!file) return; const text=await file.text(); await importDBFromText(text); });

    (async ()=>{
      const { data:{ session } } = await sb.auth.getSession();
      if(session?.user){ currentUser=session.user; await afterAuth(); }
      else { currentUser=null; showLogin(); $('app').style.display='none'; }
    })();
  }); // 
</script>



</body>

</html>
