<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Agenda de contactos</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: system-ui, sans-serif; max-width: 1000px; margin: 24px auto; padding: 0 12px; }
    h1 { margin-bottom: 8px; }
    fieldset { border: 1px solid #ddd; border-radius: 8px; padding: 12px; margin: 12px 0; }
    fieldset .contactsTbody{ display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 8px; }
    label { display:block; font-size: .9rem; margin: 6px 0 4px; font-weight: 600; }

    /* Inputs/selects */
    input{ padding: 5px; font-size: 1rem; width: 200px; }
    select { padding: 5px; font-size: 1rem; width: 213px; }
    input, select { border: none; border-bottom: 2px solid #333; background: transparent; padding: 5px 0; font-size: 1rem; outline: none; }
    input, select { border-bottom: 1px solid #ccc; }
    input:focus, select:focus { border-bottom: 2px solid #007bff; }

    button { padding: 8px; font-size: 1rem; cursor: pointer; margin-right: 3px;}

    input::placeholder, select::placeholder { color: #999; opacity: 0.7; }
    #btnLogin{ margin-top: 15px; background: #c3d8f1; border: 1px solid #00c3ff; padding: 9px; border-radius: 2px;}
    #btnLogout{ background: #c3cff1; border: 1px solid #007bff; padding: 9px; border-radius: 2px; }
    #btnExport{ background: #ebecdd; border: 1px solid #979779; padding: 9px; border-radius: 2px; }
    #btnImport { background: #f1dbc3; border: 1px solid #ffae00; padding: 9px; border-radius: 2px; }
    #btnOpenRemForm  { background: #ecc3f1; border: 1px solid #ea00ff; padding: 9px; border-radius: 2px; }
    #btnSave { background: #c3f1d6; border: 1px solid #00ff15; padding: 9px; border-radius: 2px; }
    [id^="btn-edit-"] { background: #c3e2f1; border: 1px solid #00e1ff; padding: 9px; border-radius: 2px; }
    [id^="btn-delete-"] { background: #f1c3c3; border: 1px solid #f3623d; padding: 9px; border-radius: 2px; }

    #loginBox, #registerBox { width: 300px; height: 280px; margin: 0 auto; margin-top: 110px; padding: 20px; border-radius: 8px; border: 1px solid #ddd; display: flex; flex-direction: column; gap: 10px; }
    #btnRegister { background: #c3f1d6; border: 1px solid #00ff15; margin-top: 15px; padding: 9px; border-radius: 2px; }
    #btnBackToLogin { background: #c3cff1; border: 1px solid #007bff; margin-top: 15px; padding: 9px; border-radius: 2px; }

    .row { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 8px; }
    .actions { display:flex; gap:8px; flex-wrap: wrap; }
    table { width: 100%; border-collapse: collapse; margin-top: 8px; }
    th, td { border-bottom: 1px solid #eee; text-align: left; padding: 8px; }
    tr:hover { background: #fafafa; }
    .muted { color:#777; margin-top: 20px; }
    #linkGoRegister { display: block; width: fit-content; margin: 10px auto 0; text-align: center; }

    /* Overlay / Popup */
    .overlay { display:none; position:fixed; inset:0; background:rgba(0,0,0,.45); align-items:center; justify-content:center; z-index:999; }
    .overlay .box { position: relative; background:#fff; color:#111; border-radius:14px; padding:16px; width: min(92vw, 720px); box-shadow:0 20px 60px rgba(0,0,0,.35); }
    .modal-head { display:flex; align-items:center; justify-content:space-between; margin-bottom: 10px; }
    .modal-title { font-size: 1.4rem; font-weight: 700; }
    .modal-close { border:none; background:#ef4444; color:#fff; width:28px; height:28px; border-radius:8px; display:grid; place-items:center; font-weight:700; line-height:1; }

    /* Tabs */
    .tabs { display:flex; gap:8px; margin-bottom:10px; }
    .tabs button { border:1px solid #ddd; background:#f5f5f5; border-radius:10px; padding:8px 12px; font-weight:600; }
    .tabs button.active { background:#e7f0ff; border-color:#7aa7ff; color:#1f3b8f; }
    .tabview { display:none; } .tabview.active { display:block; }

    /* Form popup */
    .rem-form-grid { display:grid; grid-template-columns: repeat(3, minmax(160px, 1fr)); gap: 16px 18px; align-items: end; }
    .rem-checks { margin-top: 6px; display:flex; flex-direction:column; gap:8px; }
    .rem-checks label { font-weight: 500; margin: 0; }
    .rem-footer { display:flex; justify-content:center; margin-top: 12px; }

    /* Acordeón (filtros) */
    .accordion { display:flex; align-items:center; gap:8px; cursor:pointer; user-select:none; padding:8px 10px; border:1px solid #ddd; border-radius:8px; background:#fafafa; }
    .chevron { transition: transform .2s ease; font-size: 1.1rem; line-height: 1; }
    .chevron.up { transform: rotate(180deg); }
    .accordion-content { overflow:hidden; transition:max-height .25s ease; max-height:0; }

    #accordionFilterContent .row { gap: 4px; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); }
    #accordionFilterContent label { margin-top: 4px; }
    #accordionFilterContent { padding-top: 6px; }

    /* Campos inválidos */
    .invalid { border-color:#dc2626 !important; outline-color:#dc2626 !important; }
    .hint { font-size:.8rem; color:#dc2626; display:none; }
    .hint.show { display:block; }

    /* Toast */
    #toast { position: fixed; left: 50%; bottom: 24px; transform: translateX(-50%); background: #111; color:#fff; padding:10px 14px; border-radius:8px; opacity:0; pointer-events:none; transition: opacity .25s; z-index: 1000; }
    #toast.show { opacity: .95; }

    @media (max-width: 560px) { .rem-form-grid { grid-template-columns: 1fr 1fr; } }

    /* Layouts */
    .form-grid { display: grid; grid-template-columns: 1fr; gap: 12px; align-items: start; }
    .form-grid .field { display: flex; flex-direction: column; }
    .form-grid input{ width: 99%; }
    .form-grid select { width: 99%; }

    .auth-stack { display: grid; grid-template-columns: 1fr; gap: 10px; max-width: 360px; }
    .auth-stack input { width: 100%; }

    .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 35px; }
    .header img { max-width: 90px; height: auto; }
  </style>
</head>
<body>
  <div class="header">
    <h1>Agenda de contactos</h1>
    <img src="https://res.cloudinary.com/dcjp6t6w9/image/upload/v1744806494/LOGO_POLIFANI_CUADRADO_qllmnj.jpg" alt="Logo-Polifani" />
  </div>

  <div id="content"></div>
  <div id="toast"></div>

  <!-- Popup bienvenida -->
  <div id="welcomePopup" class="overlay">
    <div class="box" style="text-align:center;">
      <h2 class="modal-title" style="margin:0 0 8px;">¡Bienvenido!</h2>
      <p>Puedes empezar a gestionar tus contactos.</p>
      <div class="actions" style="justify-content:center; margin-top:12px;">
        <button id="btnStartWelcome">Comenzar</button>
      </div>
    </div>
  </div>

  <!-- Popup registro correcto -->
  <div id="registerPopup" class="overlay">
    <div class="box" style="text-align:center;">
      <div class="modal-head">
        <span class="modal-title">Registro completado</span>
        <button id="btnCloseRegisterPopup" class="modal-close">✕</button>
      </div>
      <p>Usuario creado. Ahora puedes iniciar sesión.</p>
    </div>
  </div>

  <!-- Popup recordatorio (disparo) -->
  <div id="reminderPopup" class="overlay">
    <div class="box" style="text-align:center;">
      <div class="modal-head">
        <span class="modal-title">Recordatorio</span>
        <button id="btnCloseReminder" class="modal-close">✕</button>
      </div>
      <p id="reminderText" style="margin-top:6px;"></p>
      <div class="actions" style="justify-content:center; margin-top:8px;">
        <button id="btnStopRepeat" style="display:none;">Detener repetición</button>
      </div>
    </div>
  </div>

  <!-- Popup formulario/lista de recordatorios -->
  <div id="reminderFormPopup" class="overlay">
    <div class="box">
      <div class="modal-head">
        <span class="modal-title">Recordatorios</span>
        <button id="btnCancelRemForm" style="margin-top:0px" class="modal-close" title="Cerrar">✕</button>
      </div>

      <div class="tabs">
        <button id="tabFormBtn" class="active">Programar</button>
        <button id="tabListBtn">Mis recordatorios</button>
      </div>

      <div id="tabForm" class="tabview active">
        <div class="rem-form-grid">
          <div>
            <label for="remDate">Fecha</label>
            <input type="date" id="remDate" />
          </div>
          <div>
            <label for="remTime">Hora</label>
            <input type="time" id="remTime" />
          </div>
          <div>
            <label for="remMsg">Mensaje</label>
            <input id="remMsg" placeholder="Texto del recordatorio" />
          </div>
          <div class="rem-checks" style="grid-column: 1 / -1;">
            <label><input type="checkbox" id="notifToggle" /> Permitir notificaciones</label>
            <label><input type="checkbox" id="remRepeat" /> Repetir cada 10 minutos</label>
          </div>
        </div>
        <div class="rem-footer">
          <button id="btnScheduleRem">Programar</button>
        </div>
        <p class="muted" id="reminderStatus" style="min-height:18px; text-align:center;"></p>
      </div>

      <div id="tabList" class="tabview">
        <div style="overflow:auto; max-height:45vh;">
          <table>
            <thead>
              <tr>
                <th>Fecha y hora</th>
                <th>Mensaje</th>
                <th>Repite</th>
                <th>Estado</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody id="remindersTbody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Inicio de sesión -->
<fieldset id="loginBox">
  <legend>Inicio de sesión</legend>
  <form id="loginForm" autocomplete="on">
    <div class="auth-stack">
      <div class="field">
        <label for="username">Usuario</label>
        <input id="username" name="username" type="email" autocomplete="username" placeholder="Usuario" />
      </div>
      <div class="field">
        <label for="password">Contraseña</label>
        <input id="password" name="password" type="password" autocomplete="current-password" placeholder="Contraseña" />
      </div>
    </div>
    <div class="actions" style="margin-top:8px; align-items:center;">
      <button id="btnLogin" type="submit">Iniciar sesión</button>
    </div>
  </form>
  <a id="linkGoRegister" href="#" class="muted" style="margin-left:8px;">Registrarse</a>
</fieldset>

<!-- Registro -->
<fieldset id="registerBox" style="display:none;">
  <legend>Registro</legend>
  <form id="registerForm" autocomplete="on">
    <div class="auth-stack">
      <div class="field">
        <label for="regUsername">Usuario</label>
        <input id="regUsername" name="username" type="email" autocomplete="username" placeholder="Usuario" />
        <small id="userHintReg" class="hint">Ese usuario ya existe.</small>
      </div>
      <div class="field">
        <label for="regPassword">Contraseña</label>
        <input id="regPassword" name="new-password" type="password" autocomplete="new-password" placeholder="Contraseña" />
      </div>
    </div>
    <div class="actions" style="margin-top:8px; flex-wrap:wrap; gap:8px;">
      <button id="btnRegister" type="submit">Registrarse</button>
      <button id="btnBackToLogin" type="button">Volver</button>
    </div>
  </form>
</fieldset>

  <!-- App -->
  <div id="app" style="display:none;">
    <p style="display:flex; align-items:center; justify-content:space-between; gap:8px;">
      <span>Bienvenido, <strong id="userName"></strong></span>
      <span>
        <button id="btnExport" title="Exportar a JSON">Exportar</button>
        <button id="btnImport" title="Importar desde JSON">Importar</button>
        <input id="importFile" type="file" accept="application/json" hidden>
        <button id="btnOpenRemForm" title="Nuevo recordatorio">Nuevo recordatorio</button>
        <button id="btnLogout" title="Cerrar sesión">Cerrar sesión</button>
      </span>
    </p>

    <fieldset>
      <legend id="formLegend">Agregar contacto</legend>
      <div class="form-grid">
        <div class="field">
          <label for="contactName">Nombre *</label>
          <input id="contactName" placeholder="Nombre" />
          <small id="nameHint" class="hint">El nombre es obligatorio.</small>
        </div>
        <div class="field">
          <label for="contactPhone">Teléfono</label>
          <input id="contactPhone" placeholder="Teléfono" />
          <small id="phoneHint" class="hint">Introduce un teléfono válido.</small>
        </div>
        <div class="field">
          <label for="contactEmail">Email</label>
          <input id="contactEmail" placeholder="Email" />
          <small id="emailHint" class="hint">Introduce un email válido.</small>
        </div>
        <div class="field">
          <label for="contactCategory">Categoría *</label>
          <select id="contactCategory"></select>
          <small id="catHint" class="hint">Selecciona una categoría.</small>
        </div>
        <div class="field">
          <label for="contactCodigo">Código Mediador</label>
          <input id="contactCodigo" placeholder="Código Mediador" />
        </div>
      </div>
      <div class="actions" style="margin-top:8px;">
        <button id="btnSave">Guardar</button>
        <button id="btnClear" type="button">Limpiar</button>
        <span class="muted" id="editHint" style="display:none;">Editando contacto existente…</span>
      </div>
    </fieldset>

    <fieldset>
      <legend>Buscar y filtrar</legend>
      <div id="accordionFilterBtn" class="accordion" aria-expanded="false">
        <span id="chevronFilter" class="chevron">▼</span>
        <strong>Mostrar filtros</strong>
      </div>
      <div id="accordionFilterContent" class="accordion-content">
        <div>
          <div class="row">
            <div>
              <label for="filterName">Nombre</label>
              <input id="filterName" placeholder="Nombre" />
            </div>
            <div>
              <label for="filterPhone">Teléfono</label>
              <input id="filterPhone" placeholder="Teléfono" />
            </div>
            <div>
              <label for="filterEmail">Email</label>
              <input id="filterEmail" placeholder="Email" />
            </div>
            <div>
              <label for="filterCategory">Categoría</label>
              <select id="filterCategory">
                <option value="all">Todas</option>
              </select>
            </div>
          </div>
        </div>
      </div>
    </fieldset>

    <fieldset>
      <legend>Contactos</legend>
      <table>
        <thead>
          <tr>
            <th>Nombre</th>
            <th>Teléfono</th>
            <th>Email</th>
            <th>Categoría</th>
            <th>Código Mediador</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody id="contactsTbody"></tbody>
      </table>
    </fieldset>
  </div>

  <!-- Supabase client (cárgalo ANTES del script principal) -->
  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    const SUPABASE_URL = "https://euejoapezqbflobpdklk.supabase.co"; // <-- tu URL
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV1ZWpvYXBlenFiZmxvYnBka2xrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc0MTU0MTMsImV4cCI6MjA3Mjk5MTQxM30.BwK_NSGHOFjjitsjdJy0cCo9TQSwd49UjL5FoEOoaB4"; // <-- tu anon key

    window.supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  </script>

  <!-- Script principal -->
  <script>

    document.getElementById("linkGoRegister")
  .addEventListener("click", (e) => {
    e.preventDefault();   // evita que navegue a "#"
    showRegister();
  });


    document.getElementById('loginForm').addEventListener('submit', (e) => {
  e.preventDefault();
  login();      // tu función existente
});

document.getElementById('registerForm').addEventListener('submit', (e) => {
  e.preventDefault();
  register();   // tu función existente
});

    /* ---------- Estado / Utilidades ---------- */
    let currentUser = null; // Supabase user
    let currentEditId = null;
    const DEFAULT_CATEGORIES = ["Siniestros","Grúas","Asistencia","Salud","Administraciones","Contactos","Otros"];
    const reminderTimers = new Map(); let currentPopupReminderId = null;

    function showOverlay(id, show=true){ document.getElementById(id).style.display = show ? 'flex' : 'none'; }
    function toast(msg, ms=1200){ const t=document.getElementById('toast'); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'), ms); }
    function setInvalid(el,hint,inv){ if(!el)return; el.classList.toggle('invalid',!!inv); if(hint) hint.classList.toggle('show',!!inv); }
    function isValidEmail(v){ if(!v) return true; return /^[^\s@]+@[^\s@]+\.[^\s@]{2,}$/.test(v.trim()); }
    function isValidPhone(v){ if(!v) return true; return /^[0-9+\s\-()]{6,20}$/.test(v.trim()); }
    function toggleAccordion(btnId,contentId,chevId){ const btn=document.getElementById(btnId), c=document.getElementById(contentId), ch=document.getElementById(chevId); const exp=btn.getAttribute('aria-expanded')==='true'; c.style.maxHeight = exp ? '0px' : (c.scrollHeight+'px'); btn.setAttribute('aria-expanded', String(!exp)); ch.classList.toggle('up', !exp); ch.textContent = !exp ? '▲' : '▼'; }
    function switchRemTab(which='form'){ const fb=document.getElementById('tabFormBtn'), lb=document.getElementById('tabListBtn'), f=document.getElementById('tabForm'), l=document.getElementById('tabList'); const toForm = which==='form'; fb.classList.toggle('active', toForm); lb.classList.toggle('active', !toForm); f.classList.toggle('active', toForm); l.classList.toggle('active', !toForm); }
    function normalize(s){ return (s||"").toString().toLowerCase(); }

    const sb = window.supabase;

    function requireUser(){ if(!currentUser){ throw new Error('No hay usuario autenticado'); } return currentUser; }

    /* ---------- Auth (Supabase) ---------- */
    function normUser(u){ return (u || "").trim().toLowerCase(); }

    async function register(){
      const email = normUser(document.getElementById("regUsername").value);
      const password = document.getElementById("regPassword").value;
      if(!email || !password){ alert("Completa usuario (email) y contraseña."); return; }
      const { error } = await sb.auth.signUp({ email, password });
      if(error){ alert("Error al registrar: " + error.message); return; }
      showOverlay('registerPopup', true);
      showLogin();
    }

    async function login(){
      const email = normUser(document.getElementById("username").value);
      const password = document.getElementById("password").value;
      if(!email || !password){ alert("Completa usuario y contraseña."); return; }
      const { error } = await sb.auth.signInWithPassword({ email, password });
      if(error){ alert("Login incorrecto: " + error.message); return; }
      await afterAuth();
    }

    async function afterAuth(){
      const { data: { user } } = await sb.auth.getUser();
      currentUser = user;
      if(!currentUser){ showLogin(); return; }
      document.getElementById("loginBox").style.display = "none";
      document.getElementById("registerBox").style.display = "none";
      document.getElementById("app").style.display = "block";
      document.getElementById("userName").textContent = user.email || "";
      resetForm();
      await ensureCategoryOptions();
      await refreshList();
      await refreshRemindersTable();
      clearAllReminderTimers();
      await loadAndScheduleReminders();
      showOverlay('welcomePopup', true);
    }

    async function logout(){
      await sb.auth.signOut();
      // Limpiar UI
      ['welcomePopup','registerPopup','reminderFormPopup'].forEach(id => showOverlay(id,false));
      document.getElementById('reminderPopup').style.display='none';
      clearAllReminderTimers();
      currentPopupReminderId = null;
      document.getElementById('contactsTbody').innerHTML = '';
      document.getElementById('remindersTbody').innerHTML = '';
      document.getElementById('reminderStatus').textContent = '';
      currentUser = null; currentEditId = null;
      document.getElementById('userName').textContent = '';
      document.getElementById('username').value = '';
      document.getElementById('password').value = '';
      document.getElementById('app').style.display = 'none';
      showLogin();
    }

    function showLogin(){
      document.getElementById("loginBox").style.display = "block";
      document.getElementById("registerBox").style.display = "none";
    }
    function showRegister(){
      document.getElementById("loginBox").style.display = "none";
      document.getElementById("registerBox").style.display = "block";
      const u = document.getElementById("regUsername"); const hint = document.getElementById("userHintReg");
      if (u) u.classList.remove("invalid"); if (hint) hint.classList.remove("show");
    }

    // Mantener sesión al recargar
    (async ()=>{
      const { data: { user } } = await sb.auth.getUser();
      if(user){ currentUser = user; await afterAuth(); }
      else { showLogin(); }
    })();

    // Reacciones a cambios de sesión
    sb.auth.onAuthStateChange((_event, session) => {
      if(!session){ logout(); }
    });

    /* ---------- Contactos (Supabase) ---------- */
    function resetForm(){
      currentEditId=null;
      ['contactName','contactPhone','contactEmail','contactCodigo'].forEach(id=>document.getElementById(id).value='');
      document.getElementById('contactCategory').selectedIndex=0;
      ['contactName','contactEmail','contactPhone','contactCategory'].forEach(id=>setInvalid(document.getElementById(id),null,false));
      ['nameHint','emailHint','phoneHint','catHint'].forEach(id=>document.getElementById(id).classList.remove('show'));
      document.getElementById("formLegend").textContent="Agregar contacto"; document.getElementById("editHint").style.display="none"; document.getElementById("btnSave").textContent="Guardar";
    }

    function validateContactForm(){
      const n=document.getElementById("contactName"), e=document.getElementById("contactEmail"), t=document.getElementById("contactPhone"), c=document.getElementById("contactCategory");
      let ok=true;
      if(!n.value.trim()){ setInvalid(n, document.getElementById('nameHint'), true); ok=false; } else setInvalid(n, document.getElementById('nameHint'), false);
      if(!isValidEmail(e.value)){ setInvalid(e, document.getElementById('emailHint'), true); ok=false; } else setInvalid(e, document.getElementById('emailHint'), false);
      if(!isValidPhone(t.value)){ setInvalid(t, document.getElementById('phoneHint'), true); ok=false; } else setInvalid(t, document.getElementById('phoneHint'), false);
      if(!c.value){ setInvalid(c, document.getElementById('catHint'), true); ok=false; } else setInvalid(c, document.getElementById('catHint'), false);
      return ok;
    }

    async function saveContact(){
      if(!validateContactForm()) return;
      const user = requireUser();
      const obj = {
        user_id: user.id,
        name: document.getElementById("contactName").value.trim(),
        phone: document.getElementById("contactPhone").value.trim(),
        email: document.getElementById("contactEmail").value.trim(),
        category: document.getElementById("contactCategory").value.trim(),
        codigo: document.getElementById("contactCodigo").value.trim()
      };

      if(currentEditId == null){
        const { error } = await sb.from('contacts').insert(obj);
        if(error){ alert("No se pudo guardar: " + error.message); return; }
      } else {
        const { error } = await sb.from('contacts')
          .update(obj)
          .eq('id', Number(currentEditId))
          .eq('user_id', user.id);
        if(error){ alert("No se pudo actualizar: " + error.message); return; }
      }

      resetForm();
      refreshList();
    }

    async function getContactsForList(){
      // Trae MIS contactos + globales (RLS lo permite). No forzamos eq(user_id)
      let q = sb.from('contacts').select('*');

      const fName   = normalize(document.getElementById("filterName").value);
      const fEmail  = normalize(document.getElementById("filterEmail").value);
      const fPhone  = normalize(document.getElementById("filterPhone").value);
      const fCatVal = document.getElementById("filterCategory").value;

      if(fName)  q = q.ilike('name', `%${fName}%`);
      if(fEmail) q = q.ilike('email', `%${fEmail}%`);
      if(fPhone) q = q.ilike('phone', `%${fPhone}%`);
      if(fCatVal && fCatVal !== 'all') q = q.eq('category', fCatVal);

      const { data, error } = await q.order('name', { ascending: true });
      if(error){ alert("Error listando contactos: " + error.message); return []; }

      // Marcar globales como solo lectura
      return data.map(c => ({ ...c, readonly: c.is_global === true }));
    }

    async function editContact(id){
      const user = requireUser();
      const { data, error } = await sb.from('contacts').select('*')
        .eq('id', Number(id))
        .eq('user_id', user.id)
        .single();
      if(error){ alert("No se pudo cargar: " + error.message); return; }
      const c = data;

      currentEditId = c.id;
      document.getElementById("contactName").value = c.name || "";
      document.getElementById("contactPhone").value = c.phone || "";
      document.getElementById("contactEmail").value = c.email || "";
      document.getElementById("contactCodigo").value = c.codigo || "";
      document.getElementById("contactCategory").value = (c.category || "");

      document.getElementById("formLegend").textContent = "Modificar contacto";
      document.getElementById("editHint").style.display = "inline";
      document.getElementById("btnSave").textContent = "Guardar cambios";
    }

    async function deleteContact(id){
      const user = requireUser();
      if(!confirm(`¿Borrar el contacto seleccionado?`)) return;
      const { error } = await sb.from('contacts').delete().eq('id', Number(id)).eq('user_id', user.id);
      if(error){ alert("No se pudo borrar: " + error.message); return; }
      if(currentEditId === Number(id)) resetForm();
      refreshList();
    }

    async function ensureCategoryOptions(){
      const formSel=document.getElementById("contactCategory"), filterSel=document.getElementById("filterCategory");
      const prevForm=formSel.value, prevFilter=filterSel.value;
      formSel.innerHTML=""; for(const cat of ["",...DEFAULT_CATEGORIES]){ const o=document.createElement("option"); o.value=cat; o.textContent=cat?cat:"— Selecciona —"; formSel.appendChild(o); }
      filterSel.innerHTML=""; const a=document.createElement("option"); a.value="all"; a.textContent="Todas"; filterSel.appendChild(a);
      for(const cat of DEFAULT_CATEGORIES){ const o=document.createElement("option"); o.value=cat; o.textContent=cat; filterSel.appendChild(o); }
      if([...formSel.options].some(o=>o.value===prevForm)) formSel.value=prevForm;
      if([...filterSel.options].some(o=>o.value===prevFilter)) filterSel.value=prevFilter;
    }

    async function refreshList(){
      await ensureCategoryOptions();
      const tbody=document.getElementById("contactsTbody"); tbody.innerHTML="";
      const rows=await getContactsForList();
      if(rows.length===0){ const tr=document.createElement("tr"); const td=document.createElement("td"); td.colSpan = 6; td.className="muted"; td.textContent="No hay contactos que coincidan."; tr.appendChild(td); tbody.appendChild(tr); return; }
      for(const c of rows){
        const tr=document.createElement("tr");
        const td=(t)=>{ const x=document.createElement("td"); x.textContent=t||""; return x; };
        tr.appendChild(td(c.name));
        tr.appendChild(td(c.phone));
        tr.appendChild(td(c.email));
        tr.appendChild(td(c.category));
        tr.appendChild(td(c.codigo));
        const tdActions=document.createElement("td");
        const e=document.createElement("button"); e.textContent="Modificar"; e.id = `btn-edit-${c.id}`; e.onclick=()=>editContact(c.id); e.disabled=c.readonly;
        const d=document.createElement("button"); d.textContent="Borrar"; d.id = `btn-delete-${c.id}`; d.onclick=()=>deleteContact(c.id); d.disabled=c.readonly;
        tdActions.appendChild(e); tdActions.appendChild(d); tr.appendChild(tdActions);
        tbody.appendChild(tr);
      }
    }

    /* ---------- Recordatorios (Supabase) ---------- */
    async function sbUser(){ const { data: { user }, error } = await sb.auth.getUser(); if (error) throw error; if (!user) throw new Error("No hay usuario autenticado."); return user; }

    async function addReminder({ message, whenTs, repeat }) {
      const user = await sbUser();
      const whenIso = new Date(whenTs).toISOString();
      const { data, error } = await sb.from("reminders").insert({ user_id: user.id, message, when_ts: whenIso, repeat: !!repeat, active: true }).select("id").single();
      if (error) { alert("No se pudo guardar el recordatorio: " + error.message); throw error; }
      return data.id;
    }

    async function getMyReminders() {
      const user = await sbUser();
      const { data, error } = await sb.from("reminders").select("id, message, when_ts, repeat, active").eq("user_id", user.id).order("when_ts", { ascending: true });
      if (error) { alert("Error cargando recordatorios: " + error.message); return []; }
      return data.map(r => ({ id: r.id, message: r.message, repeat: r.repeat, active: r.active, whenTs: new Date(r.when_ts).getTime() }));
    }

    async function updateReminder(rem) {
      const user = await sbUser();
      const payload = { message: rem.message, when_ts: new Date(rem.whenTs).toISOString(), repeat: !!rem.repeat, active: !!rem.active };
      const { error } = await sb.from("reminders").update(payload).eq("id", rem.id).eq("user_id", user.id);
      if (error) alert("No se pudo actualizar recordatorio: " + error.message);
    }

    async function deleteReminder(id) {
      const user = await sbUser();
      const { error } = await sb.from("reminders").delete().eq("id", Number(id)).eq("user_id", user.id);
      if (error) alert("No se pudo borrar recordatorio: " + error.message);
    }

    async function refreshRemindersTable(){
      const tbody=document.getElementById("remindersTbody"); tbody.innerHTML="";
      const list=await getMyReminders(); list.sort((a,b)=>a.whenTs-b.whenTs);
      if(list.length===0){ const tr=document.createElement("tr"); const td=document.createElement("td"); td.colSpan=5; td.className="muted"; td.textContent="No hay recordatorios."; tr.appendChild(td); tbody.appendChild(tr); return; }
      for(const r of list){
        const tr=document.createElement("tr"); const when=new Date(r.whenTs);
        const td=(t)=>{ const x=document.createElement("td"); x.textContent=t; return x; };
        tr.appendChild(td(when.toLocaleString())); tr.appendChild(td(r.message)); tr.appendChild(td(r.repeat?"Cada 10 min":"No"));
        const tdAct=document.createElement("td"); tdAct.innerHTML = r.active ? '<span style="color:#065f46;font-weight:600">Activo</span>' : '<span style="color:#7c2d12;font-weight:600">Inactivo</span>'; tr.appendChild(tdAct);
        const tdActions=document.createElement("td"); const tgl=document.createElement("button"); tgl.textContent=r.active?"Desactivar":"Activar"; tgl.onclick=async()=>{ await toggleReminderActive(r.id,!r.active); }; const del=document.createElement("button"); del.textContent="Borrar"; del.style.marginLeft="6px"; del.onclick=async()=>{ const e=reminderTimers.get(r.id); if(e){ if(e.timeoutId) clearTimeout(e.timeoutId); if(e.intervalId) clearInterval(e.intervalId); } reminderTimers.delete(r.id); await deleteReminder(r.id); await refreshRemindersTable(); }; tdActions.appendChild(tgl); tdActions.appendChild(del); tr.appendChild(tdActions);
        tbody.appendChild(tr);
      }
    }

    function sendSystemNotification(message) {
  try {
    if ('Notification' in window && Notification.permission === 'granted') {
      const n = new Notification('Recordatorio', { body: message });
      n.onclick = () => {
        window.focus();
        document.getElementById('reminderPopup').style.display = 'none';
      };
    }
  } catch (e) {
    // opcional: console.warn('Notif error', e);
  }
}

    function scheduleReminderInMemory(rem){
      const ex=reminderTimers.get(rem.id); if(ex){ if(ex.timeoutId) clearTimeout(ex.timeoutId); if(ex.intervalId) clearInterval(ex.intervalId); } reminderTimers.delete(rem.id);
      if(!rem.active) return;
      const entry={timeoutId:null,intervalId:null};
      const trigger=()=>{ currentPopupReminderId=rem.id; sendSystemNotification(rem.message); showReminderPopup(rem.message, rem.repeat);
        if(rem.repeat && rem.active){ entry.intervalId=setInterval(()=>{ currentPopupReminderId=rem.id; sendSystemNotification(rem.message); showReminderPopup(rem.message,true); }, 10*60*1000); reminderTimers.set(rem.id, entry); } };
      const diff=rem.whenTs-Date.now(); if(diff<=0) trigger(); else { entry.timeoutId=setTimeout(trigger,diff); reminderTimers.set(rem.id, entry); }
    }

    async function loadAndScheduleReminders(){ const list=await getMyReminders(); for(const r of list) scheduleReminderInMemory(r); }

    async function toggleReminderActive(id, makeActive){
      const e=reminderTimers.get(id); if(e){ if(e.timeoutId) clearTimeout(e.timeoutId); if(e.intervalId) clearInterval(e.intervalId); } reminderTimers.delete(id);
      const list=await getMyReminders(); const rem=list.find(x=>x.id===id); if(!rem) return; rem.active=makeActive; await updateReminder(rem); if(makeActive) scheduleReminderInMemory(rem); await refreshRemindersTable();
    }

    async function scheduleReminder(){
      const date=document.getElementById('remDate').value, time=document.getElementById('remTime').value, msg=document.getElementById('remMsg').value.trim(), repeat=document.getElementById('remRepeat').checked;
      if(!date || !time || !msg){ alert('Completa fecha, hora y mensaje.'); return; }
      const target=new Date(`${date}T${time}`); if(isNaN(target.getTime())) return alert('Fecha u hora no válidas.'); if(target.getTime()<=Date.now()) return alert('La fecha y hora deben ser futuras.');
      const id=await addReminder({message:msg, whenTs:target.getTime(), repeat}); const list=await getMyReminders(); const rem=list.find(r=>r.id===id); if(rem) scheduleReminderInMemory(rem);
      document.getElementById('reminderStatus').textContent=`Guardado para ${target.toLocaleString()}${repeat?' (cada 10 min)':''}.`;
      setTimeout(()=>{ showOverlay('reminderFormPopup', false); document.getElementById('reminderStatus').textContent=''; document.getElementById('remDate').value=''; document.getElementById('remTime').value=''; document.getElementById('remMsg').value=''; document.getElementById('remRepeat').checked=false; toast('Recordatorio programado'); }, 700);
      await refreshRemindersTable();
    }

    function showReminderPopup(message,repeating){ document.getElementById('reminderText').textContent=message; document.getElementById('reminderPopup').style.display='flex'; document.getElementById('btnStopRepeat').style.display=repeating?'inline-block':'none'; }
    async function stopRepeatForCurrent(){ if(currentPopupReminderId==null){ document.getElementById('reminderPopup').style.display='none'; return; } const list=await getMyReminders(); const rem=list.find(r=>r.id===currentPopupReminderId); if(rem){ rem.active=false; await updateReminder(rem); const e=reminderTimers.get(rem.id); if(e){ if(e.timeoutId) clearTimeout(e.timeoutId); if(e.intervalId) clearInterval(e.intervalId); } reminderTimers.delete(rem.id); await refreshRemindersTable(); } document.getElementById('reminderPopup').style.display='none'; currentPopupReminderId=null; }

    /* ---------- Notification API ---------- */
    async function requestNotificationsViaCheckbox(e){
      if(!e.target.checked) return;
      if(!('Notification' in window)){ alert('Este navegador no soporta notificaciones.'); e.target.checked=false; return; }
      if(Notification.permission==='granted'){ toast('Notificaciones activadas'); return; }
      try{ const perm=await Notification.requestPermission(); if(perm==='granted') toast('Notificaciones permitidas'); else { alert('Notificaciones no permitidas.'); e.target.checked=false; } }
      catch{ e.target.checked=false; alert('No se pudo solicitar permiso.'); }
    }

    /* ---------- Exportar/Importar (Supabase) ---------- */
    async function exportDB(){
      if(!currentUser){ alert("Inicia sesión primero."); return; }
      const [contactsRes, remindersRes] = await Promise.all([
        sb.from('contacts').select('*').eq('user_id', currentUser.id),
        sb.from('reminders').select('*').eq('user_id', currentUser.id)
      ]);
      const contacts = contactsRes.data || []; const reminders = remindersRes.data || [];
      const data = { meta: { app: "GuiaTelefonica", version: 2, exportedAt: new Date().toISOString(), user: currentUser.email }, contacts, reminders };
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
      const url = URL.createObjectURL(blob); const a = document.createElement("a"); a.href = url; a.download = `guia_telefonica_${currentUser.email}.json`; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
    }

    async function importDBFromText(jsonText){
      try{
        if(!currentUser){ alert("Inicia sesión primero."); return; }
        let data; try { data = JSON.parse(jsonText); } catch { alert("JSON inválido."); return; }
        let contactsRaw = Array.isArray(data.contacts) ? data.contacts : []; let remindersRaw = Array.isArray(data.reminders) ? data.reminders : [];

        const contactsToInsert = []; const seen = new Set();
        for (const c of contactsRaw){
          if (c.is_global === true || c.owner === "admin") continue; // saltar globales antiguos
          const name = (c.name ?? "").trim(); const phone = (c.phone ?? "").trim(); const email = (c.email ?? "").trim(); const category = (c.category ?? "").trim(); const codigo = (c.codigo ?? "").trim();
          if (!name) continue;
          const key = [name, phone, email, category, codigo].join("|").toLowerCase(); if (seen.has(key)) continue; seen.add(key);
          contactsToInsert.push({ user_id: currentUser.id, name, phone, email, category, codigo });
        }

        const remindersToInsert = [];
        for (const r of remindersRaw){
          const message = (r.message ?? "").trim(); if (!message) continue;
          let whenIso; if (r.when_ts) { const t = new Date(r.when_ts); if (isNaN(t.getTime())) continue; whenIso = t.toISOString(); }
          else if (r.whenTs){ const t = new Date(typeof r.whenTs === "number" ? r.whenTs : Date.parse(r.whenTs)); if (isNaN(t.getTime())) continue; whenIso = t.toISOString(); }
          else { continue; }
          remindersToInsert.push({ user_id: currentUser.id, message, when_ts: whenIso, repeat: !!r.repeat, active: typeof r.active === "boolean" ? r.active : true });
        }

        async function batchInsert(table, rows, size=500){ for (let i=0; i<rows.length; i+=size){ const slice = rows.slice(i, i+size); const { error } = await sb.from(table).insert(slice); if (error) throw new Error(`${table}: ${error.message}`); } }

        if (contactsToInsert.length) await batchInsert("contacts", contactsToInsert);
        if (remindersToInsert.length) await batchInsert("reminders", remindersToInsert);

        await refreshList(); await refreshRemindersTable(); clearAllReminderTimers(); await loadAndScheduleReminders();
        toast(`Importación completada: ${contactsToInsert.length} contactos, ${remindersToInsert.length} recordatorios.`);
      } catch(err){ console.error(err); alert("Error importando: " + (err?.message || err)); }
    }

    /* ---------- Eventos ---------- */
   // document.getElementById("btnLogin").addEventListener("click", login);
    //document.getElementById("btnRegister").addEventListener("click", register);
    document.getElementById("btnLogout").addEventListener("click", logout);

    document.getElementById("btnBackToLogin").addEventListener("click", showLogin);
    document.getElementById("btnCloseRegisterPopup").addEventListener("click", ()=> { showOverlay('registerPopup', false); showLogin(); });

    function debounce(fn,wait=250){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), wait); }; }

    document.getElementById("btnOpenRemForm").addEventListener("click", async ()=>{ showOverlay('reminderFormPopup', true); switchRemTab('form'); await refreshRemindersTable(); });
    document.getElementById("btnCancelRemForm").addEventListener("click", ()=> showOverlay('reminderFormPopup', false));
    document.getElementById("tabFormBtn").addEventListener("click", ()=> switchRemTab('form'));
    document.getElementById("tabListBtn").addEventListener("click", async ()=>{ switchRemTab('list'); await refreshRemindersTable(); });
    document.getElementById("notifToggle").addEventListener("change", requestNotificationsViaCheckbox);
    document.getElementById("btnStartWelcome").addEventListener("click", ()=> showOverlay('welcomePopup', false));

    document.getElementById("btnSave").addEventListener("click", saveContact);
    document.getElementById("btnClear").addEventListener("click", resetForm);

    document.getElementById("filterName").addEventListener("input", debounce(refreshList, 200));
    document.getElementById("filterEmail").addEventListener("input", debounce(refreshList, 200));
    document.getElementById("filterPhone").addEventListener("input", debounce(refreshList, 200));
    document.getElementById("filterCategory").addEventListener("change", refreshList);

    document.getElementById("btnScheduleRem").addEventListener("click", scheduleReminder);
    document.getElementById("btnCloseReminder").addEventListener("click", ()=> document.getElementById("reminderPopup").style.display='none');
    document.getElementById("btnStopRepeat").addEventListener("click", stopRepeatForCurrent);

    document.getElementById("accordionFilterBtn").addEventListener("click", ()=> toggleAccordion('accordionFilterBtn','accordionFilterContent','chevronFilter'));

    document.getElementById("btnExport").addEventListener("click", exportDB);
    document.getElementById("btnImport").addEventListener("click", async ()=>{
      if (window.showOpenFilePicker) {
        try {
          const [handle] = await showOpenFilePicker({ multiple: false, types: [{ description: "JSON", accept: { "application/json": [".json"] } }] });
          const file = await handle.getFile(); const text = await file.text(); await importDBFromText(text); return;
        } catch (err) { if (err?.name === "AbortError") return; }
      }
      const inp = document.getElementById("importFile"); inp.value = ""; inp.click();
    });

    document.getElementById("importFile").addEventListener("change", async (e) => {
      const file = e.target.files?.[0]; if (!file) return; const text = await file.text(); await importDBFromText(text);
    });
  </script>
</body>
</html>
