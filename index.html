<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8" />
  <title>Agenda de contactos</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: system-ui, sans-serif;
      max-width: 1000px;
      margin: 24px auto;
      padding: 0 12px;
    }

    h1 {
      margin-bottom: 8px;
    }

    fieldset {
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 12px;
      margin: 12px 0;
    }

    fieldset .contactsTbody {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 8px;
    }

    label {
      display: block;
      font-size: .9rem;
      margin: 6px 0 4px;
      font-weight: 600;
    }

    /* Inputs/selects */
    input {
      padding: 5px;
      font-size: 1rem;
      width: 200px;
    }

    select {
      padding: 5px;
      font-size: 1rem;
      width: 213px;
    }

    input,
    select {
      border: none;
      border-bottom: 2px solid #333;
      background: transparent;
      padding: 5px 0;
      font-size: 1rem;
      outline: none;
    }

    input,
    select {
      border-bottom: 1px solid #ccc;
    }

    input:focus,
    select:focus {
      border-bottom: 2px solid #007bff;
    }

    button {
      padding: 8px;
      font-size: 1rem;
      cursor: pointer;
      margin-right: 3px;
    }

    input::placeholder,
    select::placeholder {
      color: #999;
      opacity: 0.7;
    }

    #btnLogin {
      margin-top: 15px;
      background: #c3d8f1;
      border: 1px solid #00c3ff;
      padding: 9px;
      border-radius: 2px;
    }

    #btnLogout {
      background: #c3cff1;
      border: 1px solid #007bff;
      padding: 9px;
      border-radius: 2px;
    }

    #btnExport {
      background: #ebecdd;
      border: 1px solid #979779;
      padding: 9px;
      border-radius: 2px;
    }

    #btnImport {
      background: #f1dbc3;
      border: 1px solid #ffae00;
      padding: 9px;
      border-radius: 2px;
    }

    #btnOpenRemForm {
      background: #ecc3f1;
      border: 1px solid #ea00ff;
      padding: 9px;
      border-radius: 2px;
    }

    #btnSave {
      background: #c3f1d6;
      border: 1px solid #00ff15;
      padding: 9px;
      border-radius: 2px;
    }

    [id^="btn-edit-"] {
      background: #c3e2f1;
      border: 1px solid #00e1ff;
      padding: 9px;
      border-radius: 2px;
    }

    [id^="btn-delete-"] {
      background: #f1c3c3;
      border: 1px solid #f3623d;
      padding: 9px;
      border-radius: 2px;
    }

    #loginBox {
      position: absolute;
      /* lo sacamos del flujo normal */
      top: 50%;
      /* 50% desde arriba */
      left: 50%;
      /* 50% desde la izquierda */
      transform: translate(-50%, -50%);
      /* lo centra exactamente */

      width: 300px;
      height: auto;
      padding: 20px;
      border-radius: 8px;
      border: 1px solid #ddd;
      display: flex;
      flex-direction: column;
      gap: 10px;
      align-items: flex-start;
      /* mantiene alineados los elementos a la izquierda */
    }

    .actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      justify-content: flex-start;
      /* 👈 alinea acciones a la izquierda */
    }

    #loginBox label {
      display: flex;
      align-items: center;
      justify-content: flex-start;
      /* 👈 asegura que quede a la izquierda */
      gap: 6px;
      /* espacio entre checkbox y texto */
    }

    #loginBox input[type="checkbox"] {
      width: auto;
      height: auto;
      border: none;
      padding: 0;
      margin-right: 6px;
      /* espacio entre checkbox y texto */
    }

    #loginBox label {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-weight: normal;
    }

    #keepSession {
      margin-right: 6px;
      /* espacio entre el checkbox y el texto */
    }


    #registerBox {
      width: 300px;
      height: 280px;
      margin: 0 auto;
      margin-top: 110px;
      padding: 20px;
      border-radius: 8px;
      border: 1px solid #ddd;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    #btnRegister {
      background: #c3f1d6;
      border: 1px solid #00ff15;
      margin-top: 15px;
      padding: 9px;
      border-radius: 2px;
    }

    #btnBackToLogin {
      background: #c3cff1;
      border: 1px solid #007bff;
      margin-top: 15px;
      padding: 9px;
      border-radius: 2px;
    }

    .row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 8px;
    }

    .actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 8px;
    }

    th,
    td {
      border-bottom: 1px solid #eee;
      text-align: left;
      padding: 8px;
    }

    tr:hover {
      background: #fafafa;
    }

    .muted {
      color: #777;
      margin-top: 20px;
    }

    #linkGoRegister {
      display: block;
      width: fit-content;
      margin: 10px auto 0;
      text-align: center;
    }

    /* Overlay / Popup */
    .overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, .45);
      align-items: center;
      justify-content: center;
      z-index: 999;
    }

    .overlay .box {
      position: relative;
      background: #fff;
      color: #111;
      border-radius: 14px;
      padding: 16px;
      width: min(92vw, 720px);
      box-shadow: 0 20px 60px rgba(0, 0, 0, .35);
    }

    .modal-head {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 10px;
    }

    .modal-title {
      font-size: 1.4rem;
      font-weight: 700;
    }

    .modal-close {
      border: none;
      background: #ef4444;
      color: #fff;
      width: 28px;
      height: 28px;
      border-radius: 8px;
      display: grid;
      place-items: center;
      font-weight: 700;
      line-height: 1;
    }

    /* Tabs */
    .tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 10px;
    }

    .tabs button {
      border: 1px solid #ddd;
      background: #f5f5f5;
      border-radius: 10px;
      padding: 8px 12px;
      font-weight: 600;
    }

    .tabs button.active {
      background: #e7f0ff;
      border-color: #7aa7ff;
      color: #1f3b8f;
    }

    .tabview {
      display: none;
    }

    .tabview.active {
      display: block;
    }

    /* Form popup */
    .rem-form-grid {
      display: grid;
      grid-template-columns: repeat(3, minmax(160px, 1fr));
      gap: 16px 18px;
      align-items: end;
    }

    .rem-checks {
      margin-top: 6px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .rem-checks label {
      font-weight: 500;
      margin: 0;
    }

    .rem-footer {
      display: flex;
      justify-content: center;
      margin-top: 12px;
    }

    /* Acordeón (filtros) */
    .accordion {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      user-select: none;
      padding: 8px 10px;
      border: 1px solid #ddd;
      border-radius: 8px;
      background: #fafafa;
    }

    .chevron {
      transition: transform .2s ease;
      font-size: 1.1rem;
      line-height: 1;
    }

    .chevron.up {
      transform: rotate(180deg);
    }

    .accordion-content {
      overflow: hidden;
      transition: max-height .25s ease;
      max-height: 0;
    }

    #accordionFilterContent .row {
      gap: 4px;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
    }

    #accordionFilterContent label {
      margin-top: 4px;
    }

    #accordionFilterContent {
      padding-top: 6px;
    }

    /* Campos inválidos */
    .invalid {
      border-color: #dc2626 !important;
      outline-color: #dc2626 !important;
    }

    .hint {
      font-size: .8rem;
      color: #dc2626;
      display: none;
    }

    .hint.show {
      display: block;
    }

    /* Toast */
    #toast {
      position: fixed;
      left: 50%;
      bottom: 24px;
      transform: translateX(-50%);
      background: #111;
      color: #fff;
      padding: 10px 14px;
      border-radius: 8px;
      opacity: 0;
      pointer-events: none;
      transition: opacity .25s;
      z-index: 1000;
    }

    #toast.show {
      opacity: .95;
    }

    @media (max-width: 560px) {
      .rem-form-grid {
        grid-template-columns: 1fr 1fr;
      }
    }

    /* Layouts */
    .form-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 12px;
      align-items: start;
    }

    .form-grid .field {
      display: flex;
      flex-direction: column;
    }

    .form-grid input {
      width: 99%;
    }

    .form-grid select {
      width: 99%;
    }

    .auth-stack {
      display: grid;
      grid-template-columns: 1fr;
      gap: 10px;
      max-width: 360px;
    }

    .auth-stack input {
      width: 100%;
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 35px;
    }

    .header img {
      max-width: 90px;
      height: auto;
    }

    .contact-card {
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 12px;
      overflow: hidden;
      margin-bottom: 16px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    .contact-main {
      padding: 12px;
    }

    .contact-title {
      font-size: 1.2rem;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .contact-line {
      font-size: 0.9rem;
      margin-bottom: 4px;
    }

    .contact-line a {
      color: #007bff;
      text-decoration: none;
    }

    .contact-line a:hover {
      text-decoration: underline;
    }

    .contact-meta {
      margin-top: 8px;
      font-size: 0.85rem;
      color: #555;
    }

    .contact-actions {
      display: flex;
      gap: 8px;
      padding: 8px 12px;
      background: #f9f9f9;
      border-top: 1px solid #ddd;
    }

    .icon-btn {
      background: transparent;
      border: none;
      cursor: pointer;
      padding: 0;
      font-size: 1.2rem;
      color: #007bff;
      transition: color 0.2s;
    }

    .icon-btn:hover {
      color: #0056b3;
    }
    card.dataset.readonly = String(!!c.readonly);

    /* oculta acciones cuando la tarjeta es de solo lectura */
    .contact-card[data-readonly="true"] .contact-actions { display: none !important;  }

    .contact-card[data-readonly="true"] .icon-btn { display: none !important; }

    .focus-flash {
  box-shadow: 0 0 0 3px rgba(0,123,255,.25);
  transition: box-shadow .2s ease;
}


  </style>
</head>

<body>
  <div class="header">
    <h1>Agenda de contactos</h1>
    <img src="https://res.cloudinary.com/dcjp6t6w9/image/upload/v1744806494/LOGO_POLIFANI_CUADRADO_qllmnj.jpg"
      alt="Logo-Polifani" />
  </div>

  <div id="content"></div>
  <div id="toast"></div>

  <!-- Popup bienvenida -->
  <div id="welcomePopup" class="overlay">
    <div class="box" style="text-align:center;">
      <h2 class="modal-title" style="margin:0 0 8px;">¡Bienvenido!</h2>
      <p>Puedes empezar a gestionar tus contactos.</p>
      <div class="actions" style="justify-content:center; margin-top:12px;">
        <button id="btnStartWelcome">Comenzar</button>
      </div>
    </div>
  </div>

  <!-- Popup registro correcto -->
  <div id="registerPopup" class="overlay">
    <div class="box" style="text-align:center;">
      <div class="modal-head">
        <span class="modal-title">Registro completado</span>
        <button id="btnCloseRegisterPopup" class="modal-close">✕</button>
      </div>
      <p>Usuario creado. Ahora puedes iniciar sesión.</p>
    </div>
  </div>

  <!-- Popup recordatorio (disparo) -->
  <div id="reminderPopup" class="overlay">
    <div class="box" style="text-align:center;">
      <div class="modal-head">
        <span class="modal-title">Recordatorio</span>
        <button id="btnCloseReminder" class="modal-close">✕</button>
      </div>
      <p id="reminderText" style="margin-top:6px;"></p>
      <div class="actions" style="justify-content:center; margin-top:8px;">
        <button id="btnStopRepeat" style="display:none;">Detener repetición</button>
      </div>
    </div>
  </div>

  <!-- Popup formulario/lista de recordatorios -->
  <div id="reminderFormPopup" class="overlay">
    <div class="box">
      <div class="modal-head">
        <span class="modal-title">Recordatorios</span>
        <button id="btnCancelRemForm" style="margin-top:0px" class="modal-close" title="Cerrar">✕</button>
      </div>

      <div class="tabs">
        <button id="tabFormBtn" class="active">Programar</button>
        <button id="tabListBtn">Mis recordatorios</button>
      </div>

      <div id="tabForm" class="tabview active">
        <div class="rem-form-grid">
          <div>
            <label for="remDate">Fecha</label>
            <input type="date" id="remDate" />
          </div>
          <div>
            <label for="remTime">Hora</label>
            <input type="time" id="remTime" />
          </div>
          <div>
            <label for="remMsg">Mensaje</label>
            <input id="remMsg" placeholder="Texto del recordatorio" />
          </div>
          <div class="rem-checks" style="grid-column: 1 / -1;">
            <label><input type="checkbox" id="notifToggle" /> Permitir notificaciones</label>
            <label><input type="checkbox" id="remRepeat" /> Repetir cada 10 minutos</label>
          </div>
        </div>
        <div class="rem-footer">
          <button id="btnScheduleRem">Programar</button>
        </div>
        <p class="muted" id="reminderStatus" style="min-height:18px; text-align:center;"></p>
      </div>

      <div id="tabList" class="tabview">
        <div style="overflow:auto; max-height:45vh;">
          <table>
            <thead>
              <tr>
                <th>Fecha y hora</th>
                <th>Mensaje</th>
                <th>Repite</th>
                <th>Estado</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody id="remindersTbody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>


























  <!-- Inicio de sesión -->
  <fieldset id="loginBox">
    <legend>Inicio de sesión</legend>
    <form id="loginForm" autocomplete="on">


      <div class="auth-stack">
        <div class="field">
          <label for="username">Usuario</label>
          <input id="username" name="username" type="email" autocomplete="username" placeholder="Usuario" />
        </div>

        <div class="field">
          <label for="password">Contraseña</label>
          <input id="password" name="password" type="password" autocomplete="current-password"
            placeholder="Contraseña" />
        </div>

      </div>

      <div class="actions" style="margin-top:8px; align-items:center;">
        <button id="btnLogin" type="submit">Iniciar sesión</button>
      </div>

      <a id="linkGoRegister" href="#" class="muted" style="margin-left:8px;">Registrarse</a>
      <br>

    </form>

    <div style="margin-top:6px;">
      <a id="linkForgot" href="#" class="muted">¿Olvidaste tu contraseña?</a>
    </div>
  </fieldset>

  <!-- Registro -->
  <fieldset id="registerBox" style="display:none;">
    <legend>Registro</legend>
    <form id="registerForm" autocomplete="on">
      <div class="auth-stack">
        <div class="field">
          <label for="regUsername">Usuario</label>
          <input id="regUsername" name="username" type="email" autocomplete="username" placeholder="Usuario" />
          <small id="userHintReg" class="hint">Ese usuario ya existe.</small>
        </div>
        <div class="field">
          <label for="regPassword">Contraseña</label>
          <input id="regPassword" name="new-password" type="password" autocomplete="new-password"
            placeholder="Contraseña" />
        </div>
      </div>
      <div class="actions" style="margin-top:8px; flex-wrap:wrap; gap:8px;">
        <button id="btnRegister" type="submit">Registrarse</button>
        <button id="btnBackToLogin" type="button">Volver</button>
      </div>
    </form>
  </fieldset>

  <!-- App -->
  <div id="app" style="display:none;">
    <p style="display:flex; align-items:center; justify-content:space-between; gap:8px;">
      <span>Bienvenido, <strong id="userName"></strong></span>
      <span>
        <button id="btnExport" title="Exportar a JSON">Exportar</button>
        <button id="btnImport" title="Importar desde JSON">Importar</button>
        <input id="importFile" type="file" accept="application/json" hidden>
        <button id="btnOpenRemForm" title="Nuevo recordatorio">Nuevo recordatorio</button>
        <button id="btnLogout" title="Cerrar sesión">Cerrar sesión</button>
      </span>
    </p>

    <fieldset>
      <legend id="formLegend">Agregar contacto</legend>
      <div class="form-grid">
        <div class="field">
          <label for="contactName">Nombre *</label>
          <input id="contactName" placeholder="Nombre" />
          <small id="nameHint" class="hint">El nombre es obligatorio.</small>
        </div>
        <div class="field">
          <label for="contactPhone">Teléfono</label>
          <input id="contactPhone" placeholder="Teléfono" />
          <small id="phoneHint" class="hint">Introduce un teléfono válido.</small>
        </div>
        <div class="field">
          <label for="contactEmail">Email</label>
          <input id="contactEmail" placeholder="Email" />
          <small id="emailHint" class="hint">Introduce un email válido.</small>
        </div>
        <div class="field">
          <label for="contactCategory">Categoría *</label>
          <select id="contactCategory"></select>
          <small id="catHint" class="hint">Selecciona una categoría.</small>
        </div>
        <div class="field">
          <label for="contactCodigo">Código Mediador</label>
          <input id="contactCodigo" placeholder="Código Mediador" />
        </div>
      </div>
      <div class="actions" style="margin-top:8px;">
        <button id="btnSave">Guardar</button>
        <button id="btnClear" type="button">Limpiar</button>
        <span class="muted" id="editHint" style="display:none;">Editando contacto existente…</span>
      </div>
    </fieldset>

    <fieldset>
      <legend>Buscar y filtrar</legend>
      <div id="accordionFilterBtn" class="accordion" aria-expanded="false">
        <span id="chevronFilter" class="chevron">▼</span>
        <strong>Mostrar filtros</strong>
      </div>
      <div id="accordionFilterContent" class="accordion-content">
        <div>
          <div class="row">
            <div>
              <label for="filterName">Nombre</label>
              <input id="filterName" placeholder="Nombre" />
            </div>
            <div>
              <label for="filterPhone">Teléfono</label>
              <input id="filterPhone" placeholder="Teléfono" />
            </div>
            <div>
              <label for="filterEmail">Email</label>
              <input id="filterEmail" placeholder="Email" />
            </div>
            <div>
              <label for="filterCategory">Categoría</label>
              <select id="filterCategory">
                <option value="all">Todas</option>
              </select>
            </div>
          </div>
        </div>
      </div>
    </fieldset>

    <fieldset>
      <legend>Contactos</legend>
      <div id="contactsCards" aria-live="polite"></div>
    </fieldset>
  </div>
  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    const SUPABASE_URL = "https://euejoapezqbflobpdklk.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV1ZWpvYXBlenFiZmxvYnBka2xrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc0MTU0MTMsImV4cCI6MjA3Mjk5MTQxM30.BwK_NSGHOFjjitsjdJy0cCo9TQSwd49UjL5FoEOoaB4";

    /* =========================
       Supabase: Singleton (solo sessionStorage)
       ========================= */
    const SB_NS = "guia-tel";
    const SS_KEY = `${SB_NS}:ss`; // storageKey fijo para sessionStorage

    function makeClient() {
      return createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
        auth: {
          persistSession: true,
          autoRefreshToken: true,
          storage: sessionStorage,
          storageKey: SS_KEY
        }
      });
    }

    // Única instancia global
    let sb = window.__SB_SINGLETON__ || makeClient();
    window.__SB_SINGLETON__ = sb;
    window.supabase = sb;

    /* =========================
       Utils UI / Estado
       ========================= */
    let currentUser = null;
    let currentEditId = null;
    const DEFAULT_CATEGORIES = ["Siniestros", "Grúas", "Asistencia", "Salud", "Administraciones", "Contactos", "Otros"];
    const reminderTimers = new Map(); let currentPopupReminderId = null;

    const $ = (id) => document.getElementById(id);
    const toast = (msg, ms = 1200) => { const t = $('toast'); if (!t) return; t.textContent = msg; t.classList.add('show'); setTimeout(() => t.classList.remove('show'), ms); };
    const showOverlay = (id, show = true) => { const el = $(id); if (el) el.style.display = show ? 'flex' : 'none'; };
    const setInvalid = (el, hint, inv) => { if (!el) return; el.classList.toggle('invalid', !!inv); if (hint) hint.classList.toggle('show', !!inv); };
    const isValidEmail = (v) => !v || /^[^\s@]+@[^\s@]+\.[^\s@]{2,}$/.test(v.trim());
    const isValidPhone = (v) => !v || /^[0-9+\s\-()]{6,20}$/.test(v.trim());
    const normalize = (s) => (s || "").toString().toLowerCase();

    function requireUser() { if (!currentUser) throw new Error("No hay usuario autenticado"); return currentUser; }
    function showLogin() { $('loginBox').style.display = "block"; $('registerBox').style.display = "none"; }
    function showRegister() { $('loginBox').style.display = "none"; $('registerBox').style.display = "block"; $('regUsername')?.classList.remove("invalid"); $('userHintReg')?.classList.remove("show"); }

    /* =========================
       Auth
       ========================= */
    const normUser = (u) => (u || "").trim().toLowerCase();

    async function register() {
      const email = normUser($("regUsername").value);
      const password = $("regPassword").value;
      if (!email || !password) { alert("Completa usuario (email) y contraseña."); return; }
      const { error } = await sb.auth.signUp({ email, password });
      if (error) { alert("Error al registrar: " + error.message); return; }
      showOverlay('registerPopup', true);
      showLogin();
    }

    // (Opcional) Si tienes una RPC user_exists(email_input text); si no existe no pasa nada
    async function checkUserExists(email) {
      try {
        const { data, error } = await sb.rpc('user_exists', { email_input: email });
        if (error) return null;
        return !!data;
      } catch { return null; }
    }

    // Suscripción al estado de auth (recreable)
    let authSubscription = null;
    function bindAuthListener() {
      try { authSubscription?.unsubscribe(); } catch { }
      const { data: { subscription } } = sb.auth.onAuthStateChange(async (event, session) => {
        switch (event) {
          case 'SIGNED_IN':
          case 'TOKEN_REFRESHED':
          case 'USER_UPDATED':
            currentUser = session?.user ?? null;
            await afterAuth();
            break;
          case 'PASSWORD_RECOVERY': {
            const newPassword = prompt("Introduce tu nueva contraseña:");
            if (!newPassword) return;
            const { error } = await sb.auth.updateUser({ password: newPassword });
            if (error) { alert("No se pudo actualizar la contraseña: " + error.message); return; }
            alert("Contraseña actualizada. Ya puedes iniciar sesión.");
            break;
          }
          case 'SIGNED_OUT':
            currentUser = null;
            clearAllReminderTimers(); // <- aquí
            showLogin();
            $('app').style.display = 'none';
            break;

        }
      authSubscription = subscription;
    });
    }
    bindAuthListener();

    async function login() {
      const email = normUser(document.getElementById("username").value);
      const password = document.getElementById("password").value;

      if (!email || !password) { alert("Completa usuario y contraseña."); return; }

      // (opcional) comprobar existencia vía RPC sin bloquear
      try {
        const exists = await checkUserExists(email);
        if (exists === false) { alert("El usuario no existe. Por favor, regístrate."); return; }
      } catch { }

      const { data, error } = await sb.auth.signInWithPassword({ email, password });
      if (error) {
        alert(error.message?.toLowerCase().includes("invalid")
          ? "El usuario no existe o la contraseña es incorrecta."
          : ("No se pudo iniciar sesión: " + error.message));
        return;
      }
      await afterAuth();
    }

    async function sendResetLink() {
      const email = normUser($("username").value);
      if (!email) { alert("Escribe tu email en 'Usuario' y vuelve a pulsar '¿Olvidaste tu contraseña?'"); return; }
      const redirectTo = `${window.location.origin}/#/recuperar`;
      const { error } = await sb.auth.resetPasswordForEmail(email, { redirectTo });
      if (error) { alert("No se pudo enviar el correo: " + error.message); return; }
      alert("Te hemos enviado un email con el enlace para restablecer tu contraseña.");
    }

    async function logout() {
      try {
        clearAllReminderTimers(); // <- limpiar recordatorios en memoria
        await sb.auth.signOut();
      } catch (e) {
        alert('No se pudo cerrar sesión: ' + (e?.message || e));
      }
    }


    async function afterAuth() {
      const { data: { user } } = await sb.auth.getUser();
      currentUser = user;
      if (!currentUser) { showLogin(); return; }
      $('loginBox').style.display = "none";
      $('registerBox').style.display = "none";
      $('app').style.display = "block";
      $('userName').textContent = user.email || "";
      resetForm();
      await ensureCategoryOptions();
      await refreshList();
      await refreshRemindersTable();
      clearAllReminderTimers();
      await loadAndScheduleReminders();
      showOverlay('welcomePopup', true);
    }

    window.addEventListener('beforeunload', () => { try { authSubscription?.unsubscribe(); } catch { } });

    /* =========================
       Contactos
       ========================= */
    function resetForm() {
      currentEditId = null;
      ['contactName', 'contactPhone', 'contactEmail', 'contactCodigo'].forEach(id => $(id).value = '');
      $('contactCategory').selectedIndex = 0;
      ['contactName', 'contactEmail', 'contactPhone', 'contactCategory'].forEach(id => setInvalid($(id), null, false));
      ['nameHint', 'emailHint', 'phoneHint', 'catHint'].forEach(id => $(id).classList.remove('show'));
      $("formLegend").textContent = "Agregar contacto"; $("editHint").style.display = "none"; $("btnSave").textContent = "Guardar";
    }

    async function ensureCategoryOptions() {
      const formSel = $("contactCategory"), filterSel = $("filterCategory");
      const prevForm = formSel.value, prevFilter = filterSel.value;
      formSel.innerHTML = "";
      for (const cat of ["", ...DEFAULT_CATEGORIES]) { const o = document.createElement("option"); o.value = cat; o.textContent = cat ? cat : "— Selecciona —"; formSel.appendChild(o); }
      filterSel.innerHTML = ""; const a = document.createElement("option"); a.value = "all"; a.textContent = "Todas"; filterSel.appendChild(a);
      for (const cat of DEFAULT_CATEGORIES) { const o = document.createElement("option"); o.value = cat; o.textContent = cat; filterSel.appendChild(o); }
      if ([...formSel.options].some(o => o.value === prevForm)) formSel.value = prevForm;
      if ([...filterSel.options].some(o => o.value === prevFilter)) filterSel.value = prevFilter;
    }

    function validateContactForm() {
      const n = $("contactName"), e = $("contactEmail"), t = $("contactPhone"), c = $("contactCategory"); let ok = true;
      if (!n.value.trim()) { setInvalid(n, $("nameHint"), true); ok = false; } else setInvalid(n, $("nameHint"), false);
      if (!isValidEmail(e.value)) { setInvalid(e, $("emailHint"), true); ok = false; } else setInvalid(e, $("emailHint"), false);
      if (!isValidPhone(t.value)) { setInvalid(t, $("phoneHint"), true); ok = false; } else setInvalid(t, $("phoneHint"), false);
      if (!c.value) { setInvalid(c, $("catHint"), true); ok = false; } else setInvalid(c, $("catHint"), false);
      return ok;
    }

    async function saveContact() {
      if (!validateContactForm()) return;
      const user = requireUser();
      const obj = {
        user_id: user.id,
        name: $("contactName").value.trim(),
        phone: $("contactPhone").value.trim(),
        email: $("contactEmail").value.trim(),
        category: $("contactCategory").value.trim(),
        codigo: $("contactCodigo").value.trim()
      };
      if (currentEditId == null) {
        const { error } = await sb.from('contacts').insert(obj);
        if (error) { alert("No se pudo guardar: " + error.message); return; }
      } else {
        const { error } = await sb.from('contacts').update(obj).eq('id', Number(currentEditId)).eq('user_id', user.id);
        if (error) { alert("No se pudo actualizar: " + error.message); return; }
      }
      resetForm(); refreshList();
    }

    async function getContactsForList() {
      let q = sb.from('contacts').select('*');
      const fName = normalize($("filterName").value);
      const fEmail = normalize($("filterEmail").value);
      const fPhone = normalize($("filterPhone").value);
      const fCatVal = $("filterCategory").value;
      if (fName) q = q.ilike('name', `%${fName}%`);
      if (fEmail) q = q.ilike('email', `%${fEmail}%`);
      if (fPhone) q = q.ilike('phone', `%${fPhone}%`);
      if (fCatVal && fCatVal !== 'all') q = q.eq('category', fCatVal);
      const { data, error } = await q.order('name', { ascending: true });
      if (error) { alert("Error listando contactos: " + error.message); return []; }
      return (data || []).map(c => ({ ...c, readonly: c.is_global === true }));
    }

  async function editContact(id) {
  const user = requireUser();
  const { data, error } = await sb.from('contacts')
    .select('*')
    .eq('id', Number(id))
    .eq('user_id', user.id)
    .single();

  if (error) { alert("No se pudo cargar: " + error.message); return; }

  const c = data;
  currentEditId = c.id;

  $("contactName").value   = c.name || "";
  $("contactPhone").value  = c.phone || "";
  $("contactEmail").value  = c.email || "";
  $("contactCodigo").value = c.codigo || "";
  $("contactCategory").value = (c.category || "");

  $("formLegend").textContent = "Modificar contacto";
  $("editHint").style.display = "inline";
  $("btnSave").textContent = "Guardar cambios";

  // 👇 Scroll arriba + foco en el nombre
  try {
    // Desplaza suavemente al inicio
    window.scrollTo({ top: 0, behavior: 'smooth' });

    const nameInput = $("contactName");
    if (nameInput) {
      // Foco inmediato (por si el navegador bloquea durante la animación)
      nameInput.focus();
      nameInput.select?.();

      // Refuerzo del foco tras la animación de scroll
      setTimeout(() => {
        nameInput.focus();
        nameInput.select?.();
      }, 350);

      // (Opcional) pequeño “flash” de realce
      nameInput.classList.add("focus-flash");
      setTimeout(() => nameInput.classList.remove("focus-flash"), 600);
    }
  } catch {}
}


    async function deleteContact(id) {
      const user = requireUser();
      if (!confirm("¿Borrar el contacto seleccionado?")) return;
      const { error } = await sb.from('contacts').delete().eq('id', Number(id)).eq('user_id', user.id);
      if (error) { alert("No se pudo borrar: " + error.message); return; }
      if (currentEditId === Number(id)) resetForm();
      refreshList();
    }

    async function refreshList() {
      await ensureCategoryOptions();
      const container = document.getElementById("contactsCards");
      container.innerHTML = "";
      const rows = await getContactsForList();
      if (rows.length === 0) {
        const p = document.createElement("p");
        p.className = "muted";
        p.textContent = "No hay contactos que coincidan.";
        container.appendChild(p);
        return;
      }
      for (const c of rows) {
        const card = document.createElement("article");
        card.className = "contact-card";
        card.dataset.readonly = String(!!c.is_global);
        

        const main = document.createElement("div");
        main.className = "contact-main";

        const title = document.createElement("div");
        title.className = "contact-title";
        title.textContent = c.name || "—";
        title.title = c.name || "";
        main.appendChild(title);

        const phoneLine = document.createElement("div");
        phoneLine.className = "contact-line";
        if (c.phone) {
          const a = document.createElement("a");
          a.href = "tel:" + (c.phone || "").replace(/[^0-9+]/g, "");
          a.textContent = c.phone;
          a.title = c.phone;
          phoneLine.appendChild(a);
        } else {
          phoneLine.textContent = "Teléfono";
          phoneLine.classList.add("muted");
        }
        main.appendChild(phoneLine);

        const emailLine = document.createElement("div");
        emailLine.className = "contact-line";
        if (c.email) {
          const a = document.createElement("a");
          a.href = `mailto:${c.email}`;
          a.textContent = c.email;
          a.title = c.email;
          emailLine.appendChild(a);
        } else {
          emailLine.textContent = "Email";
          emailLine.classList.add("muted");
        }
        main.appendChild(emailLine);

        const meta = document.createElement("div");
        meta.className = "contact-meta";
        const cat = document.createElement("small");
        cat.textContent = c.category || "";
        meta.appendChild(cat);
        const codigo = (c.codigo || "").trim();
        if (codigo) {
          const cod = document.createElement("small");
          cod.textContent = `Código de mediador: ${codigo}`;
          meta.appendChild(cod);
        }
        main.appendChild(meta);

        const actions = document.createElement("div");
        actions.className = "contact-actions";
        const btnEdit = document.createElement("button");
        btnEdit.id = `btn-edit-${c.id}`;
        btnEdit.className = "icon-btn";
        btnEdit.innerHTML = '<span aria-hidden="true">✏️</span>';
        btnEdit.title = "Modificar";
        btnEdit.disabled = c.readonly;
        btnEdit.onclick = () => editContact(c.id);

        const btnDelete = document.createElement("button");
        btnDelete.id = `btn-delete-${c.id}`;
        btnDelete.className = "icon-btn";
        btnDelete.innerHTML = '<span aria-hidden="true">🗑️</span>';
        btnDelete.title = "Borrar";
        btnDelete.disabled = c.readonly;
        btnDelete.onclick = () => deleteContact(c.id);

        actions.appendChild(btnEdit);
        actions.appendChild(btnDelete);

        card.appendChild(main);
        card.appendChild(actions);
        container.appendChild(card);
      }
    }

    /* =========================
       Recordatorios
       ========================= */
    async function sbUser() { const { data: { user }, error } = await sb.auth.getUser(); if (error) throw error; if (!user) throw new Error("No hay usuario autenticado."); return user; }
    async function addReminder({ message, whenTs, repeat }) { const user = await sbUser(); const whenIso = new Date(whenTs).toISOString(); const { data, error } = await sb.from("reminders").insert({ user_id: user.id, message, when_ts: whenIso, repeat: !!repeat, active: true }).select("id").single(); if (error) { alert("No se pudo guardar el recordatorio: " + error.message); throw error; } return data.id; }
    async function getMyReminders() { const user = await sbUser(); const { data, error } = await sb.from("reminders").select("id, message, when_ts, repeat, active").eq("user_id", user.id).order("when_ts", { ascending: true }); if (error) { alert("Error cargando recordatorios: " + error.message); return []; } return data.map(r => ({ id: r.id, message: r.message, repeat: r.repeat, active: r.active, whenTs: new Date(r.when_ts).getTime() })); }
    async function updateReminder(rem) { const user = await sbUser(); const payload = { message: rem.message, when_ts: new Date(rem.whenTs).toISOString(), repeat: !!rem.repeat, active: !!rem.active }; const { error } = await sb.from("reminders").update(payload).eq("id", rem.id).eq("user_id", user.id); if (error) alert("No se pudo actualizar recordatorio: " + error.message); }
    async function deleteReminder(id) { const user = await sbUser(); const { error } = await sb.from("reminders").delete().eq("id", Number(id)).eq("user_id", user.id); if (error) alert("No se pudo borrar recordatorio: " + error.message); }
    async function refreshRemindersTable() { const tbody = $("remindersTbody"); tbody.innerHTML = ""; const list = await getMyReminders(); list.sort((a, b) => a.whenTs - b.whenTs); if (list.length === 0) { const tr = document.createElement("tr"); const td = document.createElement("td"); td.colSpan = 5; td.className = "muted"; td.textContent = "No hay recordatorios."; tr.appendChild(td); tbody.appendChild(tr); return; } for (const r of list) { const tr = document.createElement("tr"); const when = new Date(r.whenTs); const td = (t) => { const x = document.createElement("td"); x.textContent = t; return x; }; tr.appendChild(td(when.toLocaleString())); tr.appendChild(td(r.message)); tr.appendChild(td(r.repeat ? "Cada 10 min" : "No")); const tdAct = document.createElement("td"); tdAct.innerHTML = r.active ? '<span style="color:#065f46;font-weight:600">Activo</span>' : '<span style="color:#7c2d12;font-weight:600">Inactivo</span>'; tr.appendChild(tdAct); const tdActions = document.createElement("td"); const tgl = document.createElement("button"); tgl.textContent = r.active ? "Desactivar" : "Activar"; tgl.onclick = async () => { await toggleReminderActive(r.id, !r.active); }; const del = document.createElement("button"); del.textContent = "Borrar"; del.style.marginLeft = "6px"; del.onclick = async () => { const e = reminderTimers.get(r.id); if (e) { if (e.timeoutId) clearTimeout(e.timeoutId); if (e.intervalId) clearInterval(e.intervalId); } reminderTimers.delete(r.id); await deleteReminder(r.id); await refreshRemindersTable(); }; tdActions.appendChild(tgl); tdActions.appendChild(del); tr.appendChild(tdActions); tbody.appendChild(tr); } }
    function sendSystemNotification(message) { try { if ('Notification' in window && Notification.permission === 'granted') { const n = new Notification('Recordatorio', { body: message }); n.onclick = () => { window.focus(); $('reminderPopup').style.display = 'none'; }; } } catch { } }
    function scheduleReminderInMemory(rem) { const ex = reminderTimers.get(rem.id); if (ex) { if (ex.timeoutId) clearTimeout(ex.timeoutId); if (ex.intervalId) clearInterval(ex.intervalId); } reminderTimers.delete(rem.id); if (!rem.active) return; const entry = { timeoutId: null, intervalId: null }; const trigger = () => { currentPopupReminderId = rem.id; sendSystemNotification(rem.message); showReminderPopup(rem.message, rem.repeat); if (rem.repeat && rem.active) { entry.intervalId = setInterval(() => { currentPopupReminderId = rem.id; sendSystemNotification(rem.message); showReminderPopup(rem.message, true); }, 10 * 60 * 1000); reminderTimers.set(rem.id, entry); } }; const diff = rem.whenTs - Date.now(); if (diff <= 0) trigger(); else { entry.timeoutId = setTimeout(trigger, diff); reminderTimers.set(rem.id, entry); } }
    async function loadAndScheduleReminders() { const list = await getMyReminders(); for (const r of list) scheduleReminderInMemory(r); }
    async function toggleReminderActive(id, makeActive) { const e = reminderTimers.get(id); if (e) { if (e.timeoutId) clearTimeout(e.timeoutId); if (e.intervalId) clearInterval(e.intervalId); } reminderTimers.delete(id); const list = await getMyReminders(); const rem = list.find(x => x.id === id); if (!rem) return; rem.active = makeActive; await updateReminder(rem); if (makeActive) scheduleReminderInMemory(rem); await refreshRemindersTable(); }
    async function scheduleReminder() { const date = $('remDate').value, time = $('remTime').value, msg = $('remMsg').value.trim(), repeat = $('remRepeat').checked; if (!date || !time || !msg) { alert('Completa fecha, hora y mensaje.'); return; } const target = new Date(`${date}T${time}`); if (isNaN(target.getTime())) return alert('Fecha u hora no válidas.'); if (target.getTime() <= Date.now()) return alert('La fecha y hora deben ser futuras.'); const id = await addReminder({ message: msg, whenTs: target.getTime(), repeat }); const list = await getMyReminders(); const rem = list.find(r => r.id === id); if (rem) scheduleReminderInMemory(rem); $('reminderStatus').textContent = `Guardado para ${target.toLocaleString()}${repeat ? ' (cada 10 min)' : ''}.`; setTimeout(() => { showOverlay('reminderFormPopup', false); $('reminderStatus').textContent = ''; $('remDate').value = ''; $('remTime').value = ''; $('remMsg').value = ''; $('remRepeat').checked = false; toast('Recordatorio programado'); }, 700); await refreshRemindersTable(); }
    function showReminderPopup(message, repeating) { $('reminderText').textContent = message; $('reminderPopup').style.display = 'flex'; $('btnStopRepeat').style.display = repeating ? 'inline-block' : 'none'; }
    async function stopRepeatForCurrent() { if (currentPopupReminderId == null) { $('reminderPopup').style.display = 'none'; return; } const list = await getMyReminders(); const rem = list.find(x => x.id === currentPopupReminderId); if (rem) { rem.active = false; await updateReminder(rem); const e = reminderTimers.get(rem.id); if (e) { if (e.timeoutId) clearTimeout(e.timeoutId); if (e.intervalId) clearInterval(e.intervalId); } reminderTimers.delete(rem.id); await refreshRemindersTable(); } $('reminderPopup').style.display = 'none'; currentPopupReminderId = null; }

    async function requestNotificationsViaCheckbox(e) {
      if (!e.target.checked) return;
      if (!('Notification' in window)) {
        alert('Este navegador no soporta notificaciones.');
        e.target.checked = false;
        return;
      }
      if (Notification.permission === 'granted') {
        toast('Notificaciones activadas');
        return;
      }
      try {
        const perm = await Notification.requestPermission();
        if (perm === 'granted') toast('Notificaciones permitidas');
        else {
          alert('Notificaciones no permitidas.');
          e.target.checked = false;
        }
      } catch {
        e.target.checked = false;
        alert('No se pudo solicitar permiso.');
      }
    } // ← ESTA llave faltaba

    /* =========================
       Export/Import
       ========================= */
    async function exportDB() { if (!currentUser) { alert("Inicia sesión primero."); return; } const [contactsRes, remindersRes] = await Promise.all([sb.from('contacts').select('*').eq('user_id', currentUser.id), sb.from('reminders').select('*').eq('user_id', currentUser.id)]); const contacts = contactsRes.data || []; const reminders = remindersRes.data || []; const data = { meta: { app: "GuiaTelefonica", version: 2, exportedAt: new Date().toISOString(), user: currentUser.email }, contacts, reminders }; const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" }); const url = URL.createObjectURL(blob); const a = document.createElement("a"); a.href = url; a.download = `guia_telefonica_${currentUser.email}.json`; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url); }
    async function importDBFromText(jsonText) { try { if (!currentUser) { alert("Inicia sesión primero."); return; } let data; try { data = JSON.parse(jsonText); } catch { alert("JSON inválido."); return; } let contactsRaw = Array.isArray(data.contacts) ? data.contacts : []; let remindersRaw = Array.isArray(data.reminders) ? data.reminders : []; const contactsToInsert = []; const seen = new Set(); for (const c of contactsRaw) { if (c.is_global === true || c.owner === "admin") continue; const name = (c.name ?? "").trim(); const phone = (c.phone ?? "").trim(); const email = (c.email ?? "").trim(); const category = (c.category ?? "").trim(); const codigo = (c.codigo ?? "").trim(); if (!name) continue; const key = [name, phone, email, category, codigo].join("|").toLowerCase(); if (seen.has(key)) continue; seen.add(key); contactsToInsert.push({ user_id: currentUser.id, name, phone, email, category, codigo }); } const remindersToInsert = []; for (const r of remindersRaw) { const message = (r.message ?? "").trim(); if (!message) continue; let whenIso; if (r.when_ts) { const t = new Date(r.when_ts); if (isNaN(t.getTime())) continue; whenIso = t.toISOString(); } else if (r.whenTs) { const t = new Date(typeof r.whenTs === "number" ? r.whenTs : Date.parse(r.whenTs)); if (isNaN(t.getTime())) continue; whenIso = t.toISOString(); } else continue; remindersToInsert.push({ user_id: currentUser.id, message, when_ts: whenIso, repeat: !!r.repeat, active: typeof r.active === "boolean" ? r.active : true }); } async function batchInsert(table, rows, size = 500) { for (let i = 0; i < rows.length; i += size) { const slice = rows.slice(i, i + size); const { error } = await sb.from(table).insert(slice); if (error) throw new Error(`${table}: ${error.message}`); } } if (contactsToInsert.length) await batchInsert("contacts", contactsToInsert); if (remindersToInsert.length) await batchInsert("reminders", remindersToInsert); await refreshList(); await refreshRemindersTable(); clearAllReminderTimers(); await loadAndScheduleReminders(); toast(`Importación completada: ${contactsToInsert.length} contactos, ${remindersToInsert.length} recordatorios.`); } catch (err) { console.error(err); alert("Error importando: " + (err?.message || err)); } }

    function clearAllReminderTimers() { for (const e of reminderTimers.values()) { try { if (e.timeoutId) clearTimeout(e.timeoutId); if (e.intervalId) clearInterval(e.intervalId); } catch { } } reminderTimers.clear(); }

    /* =========================
       DOMContentLoaded
       ========================= */
    window.addEventListener('DOMContentLoaded', () => {
      // Formularios
      $('loginForm')?.addEventListener('submit', (e) => { e.preventDefault(); login(); });
      $('registerForm')?.addEventListener('submit', (e) => { e.preventDefault(); register(); });

      // Links/login
      $('linkGoRegister')?.addEventListener('click', (e) => { e.preventDefault(); showRegister(); });
      $('btnBackToLogin')?.addEventListener('click', showLogin);
      $('linkForgot')?.addEventListener('click', (e) => { e.preventDefault(); sendResetLink(); });

      // Sesión
      $('btnLogout')?.addEventListener('click', logout);

      // Recordatorios & varios
      $('btnOpenRemForm')?.addEventListener('click', async () => { showOverlay('reminderFormPopup', true); await refreshRemindersTable(); });
      $('btnCancelRemForm')?.addEventListener('click', () => showOverlay('reminderFormPopup', false));
      $('tabFormBtn')?.addEventListener('click', () => { });
      $('tabListBtn')?.addEventListener('click', async () => { await refreshRemindersTable(); });
      $('notifToggle')?.addEventListener('change', requestNotificationsViaCheckbox);
      $('btnStartWelcome')?.addEventListener('click', () => showOverlay('welcomePopup', false));
      $('btnSave')?.addEventListener('click', saveContact);
      $('btnClear')?.addEventListener('click', resetForm);

      // Filtros
      const debounce = (fn, wait = 250) => { let t; return (...a) => { clearTimeout(t); t = setTimeout(() => fn(...a), wait); }; };
      $('filterName')?.addEventListener('input', debounce(refreshList, 200));
      $('filterEmail')?.addEventListener('input', debounce(refreshList, 200));
      $('filterPhone')?.addEventListener('input', debounce(refreshList, 200));
      $('filterCategory')?.addEventListener('change', refreshList);

      $('btnScheduleRem')?.addEventListener('click', scheduleReminder);
      $('btnCloseReminder')?.addEventListener('click', () => $('reminderPopup').style.display = 'none');
      $('btnStopRepeat')?.addEventListener('click', stopRepeatForCurrent);
      $('accordionFilterBtn')?.addEventListener('click', () => {
        const btn = $('accordionFilterBtn'), c = $('accordionFilterContent'), ch = $('chevronFilter');
        const exp = btn.getAttribute('aria-expanded') === 'true';
        c.style.maxHeight = exp ? '0px' : (c.scrollHeight + 'px');
        btn.setAttribute('aria-expanded', String(!exp));
        ch.classList.toggle('up', !exp);
        ch.textContent = !exp ? '▲' : '▼';
      });

      $('btnExport')?.addEventListener('click', exportDB);
      $('btnImport')?.addEventListener('click', async () => {
        if (window.showOpenFilePicker) {
          try {
            const [handle] = await showOpenFilePicker({ multiple: false, types: [{ description: "JSON", accept: { "application/json": [".json"] } }] });
            const file = await handle.getFile(); const text = await file.text(); await importDBFromText(text); return;
          } catch (err) { if (err?.name === "AbortError") return; }
        }
        const inp = $('importFile'); if (inp) { inp.value = ""; inp.click(); }
      });
      $('importFile')?.addEventListener('change', async (e) => { const file = e.target.files?.[0]; if (!file) return; const text = await file.text(); await importDBFromText(text); });

      // Intento de sesión previa en esta pestaña (sessionStorage)
      (async () => {
        try {
          const { data: { session }, error } = await sb.auth.getSession();
          if (error) throw error;
          if (session?.user) {
            currentUser = session.user;
            await afterAuth();
            return;
          }
        } catch { }
        currentUser = null;
        showLogin();
        $('app').style.display = 'none';
      })();
    });
  </script>




</body>

</html>






