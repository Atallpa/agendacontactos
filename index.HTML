<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Agenda de contactos</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: system-ui, sans-serif; max-width: 1000px; margin: 24px auto; padding: 0 12px; }
    h1 { margin-bottom: 8px; }
    fieldset { border: 1px solid #ddd; border-radius: 8px; padding: 12px; margin: 12px 0; }
    fieldset .contactsTbody{ display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 8px;  }
    label { display:block; font-size: .9rem; margin: 6px 0 4px; font-weight: 600; }

    /* Inputs/selects: 150px ancho + padding 5 */
    input{ padding: 5px; font-size: 1rem; width: 200px; }
    select { padding: 5px; font-size: 1rem; width: 213px; }
    input, select {
      border: none;                 /* quita todos los bordes */
      border-bottom: 2px solid #333; /* solo línea inferior */
      background: transparent;      /* quita fondo gris en algunos navegadores */
      padding: 5px 0;                /* ajusta padding para que se vea limpio */
      font-size: 1rem;
      outline: none;                 /* quita borde azul al enfocar */
    }
    input, select {
      border-bottom: 1px solid #ccc;
    }
      input:focus, select:focus {
      border-bottom: 2px solid #007bff;
    }

    button { padding: 8px; font-size: 1rem; cursor: pointer; margin-right: 3px;}

    input::placeholder,
    select::placeholder {
      color: #999;      /* gris suave */
      opacity: 0.7;     /* un poco translúcido */
       /* opcional, para que se distinga del texto */
    }
    #btnLogin{ margin-top: 15px; background: #c3d8f1; border: 1px solid #00c3ff; padding: 9px; border-radius: 2px;}


    #btnLogout{
       background: #c3cff1; border: 1px solid #007bff; padding: 9px; border-radius: 2px;
    }
    #btnExport{background: #ebecdd; border: 1px solid #979779; padding: 9px; border-radius: 2px;}
    #btnImport {background: #f1dbc3; border: 1px solid #ffae00; padding: 9px; border-radius: 2px;}
    #btnOpenRemForm  {background: #ecc3f1; border: 1px solid #ea00ff; padding: 9px; border-radius: 2px;}
    #btnSave {background: #c3f1d6; border: 1px solid #00ff15; padding: 9px; border-radius: 2px;}
    /* Botón de editar */
    [id^="btn-edit-"] {background: #c3e2f1; border: 1px solid #00e1ff; padding: 9px; border-radius: 2px;}

    /* Botón de borrar */
    [id^="btn-delete-"] {background: #f1c3c3; border: 1px solid #f3623d; padding: 9px; border-radius: 2px;}

    #loginBox, #registerBox {width: 300px; height: 280px; margin: 0 auto; margin-top: 110px; padding: 20px; border-radius: 8px; border: 1px solid #ddd; display: flex; flex-direction: column; gap: 10px;}
    #btnRegister {background: #c3f1d6; border: 1px solid #00ff15; margin-top: 15px; padding: 9px; border-radius: 2px;}
    #btnBackToLogin {background: #c3cff1; border: 1px solid #007bff; margin-top: 15px; padding: 9px; border-radius: 2px;}

    .row { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 8px; }
    .actions { display:flex; gap:8px; flex-wrap: wrap; }
    table { width: 100%; border-collapse: collapse; margin-top: 8px; }
    th, td { border-bottom: 1px solid #eee; text-align: left; padding: 8px; }
    tr:hover { background: #fafafa; }
    .muted { color:#777; margin-top: 20px; }
    #linkGoRegister { display: block; width: fit-content;  margin: 10px auto 0; text-align: center; }
   

    /* ---------- Overlay / Popup base ---------- */
    .overlay { display:none; position:fixed; inset:0; background:rgba(0,0,0,.45); align-items:center; justify-content:center; z-index:999; }
    .overlay .box { position: relative; background:#fff; color:#111; border-radius:14px; padding:16px; width: min(92vw, 720px); box-shadow:0 20px 60px rgba(0,0,0,.35); }
    .modal-head { display:flex; align-items:center; justify-content:space-between; margin-bottom: 10px; }
    .modal-title { font-size: 1.4rem; font-weight: 700; }
    .modal-close { border:none; background:#ef4444; color:#fff; width:28px; height:28px; border-radius:8px; display:grid; place-items:center; font-weight:700; line-height:1; }

    
    /* Tabs estilo pill */
    .tabs { display:flex; gap:8px; margin-bottom:10px; }
    .tabs button { border:1px solid #ddd; background:#f5f5f5; border-radius:10px; padding:8px 12px; font-weight:600; }
    .tabs button.active { background:#e7f0ff; border-color:#7aa7ff; color:#1f3b8f; }
    .tabview { display:none; } .tabview.active { display:block; }

    /* Form popup */
    .rem-form-grid { display:grid; grid-template-columns: repeat(3, minmax(160px, 1fr)); gap: 16px 18px; align-items: end; }
    .rem-checks { margin-top: 6px; display:flex; flex-direction:column; gap:8px; }
    .rem-checks label { font-weight: 500; margin: 0; }
    .rem-footer { display:flex; justify-content:center; margin-top: 12px; }

    /* Acordeón (filtros) */
    .accordion { display:flex; align-items:center; gap:8px; cursor:pointer; user-select:none; padding:8px 10px; border:1px solid #ddd; border-radius:8px; background:#fafafa; }
    .chevron { transition: transform .2s ease; font-size: 1.1rem; line-height: 1; }
    .chevron.up { transform: rotate(180deg); }
    .accordion-content { overflow:hidden; transition:max-height .25s ease; max-height:0; }

    /* Filtros más juntos */
    #accordionFilterContent .row { gap: 4px; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); }
    #accordionFilterContent label { margin-top: 4px; }
    #accordionFilterContent { padding-top: 6px; }

    /* Campos inválidos */
    .invalid { border-color:#dc2626 !important; outline-color:#dc2626 !important; }
    .hint { font-size:.8rem; color:#dc2626; display:none; }
    .hint.show { display:block; }

    /* Toast */
    #toast { position: fixed; left: 50%; bottom: 24px; transform: translateX(-50%); background: #111; color:#fff; padding:10px 14px; border-radius:8px; opacity:0; pointer-events:none; transition: opacity .25s; z-index: 1000; }
    #toast.show { opacity: .95; }

    @media (max-width: 560px) { .rem-form-grid { grid-template-columns: 1fr 1fr; } }


    /* === NUEVOS LAYOUTS DE FORMULARIO (sin .row) === */
    .form-grid {                /* para el formulario de contacto */
     display: grid;
      grid-template-columns: 1fr; /* una sola columna */
      gap: 12px;
      align-items: start;
    }
    .form-grid .field { display: flex; flex-direction: column; }

    .form-grid input{ width: 99%; }
    .form-grid select { width: 99%; }

    .auth-stack {               /* para login y registro */
      display: grid;
      grid-template-columns: 1fr;
      gap: 10px;
      max-width: 360px;
    }
    .auth-stack input { width: 100%; }  /* que no se queden a 150px en auth */


    .header {
    display: flex;
    justify-content: space-between; /* Título a la izquierda, imagen a la derecha */
    align-items: center;
    margin-bottom: 35px;
    }

    .header img {
      max-width: 90px;
      height: auto;
    }


  

    /* Mantén .row solo si la usas en otras vistas. Si no, puedes eliminarla. */


  </style>
</head>
<body>
 <div class="header">
    <h1>Agenda de contactos</h1>
    <img src="https://res.cloudinary.com/dcjp6t6w9/image/upload/v1744806494/LOGO_POLIFANI_CUADRADO_qllmnj.jpg"
      alt="Logo-Polifani">
  </div>


  <!-- Contenido principal -->
  <div id="content">
    <!-- Aquí se cargará el contenido dinámico -->
  </div>

<!-- Toast -->
<div id="toast"></div>

<!-- Popup bienvenida (nuevo diseño con botón central "Comenzar") -->
<div id="welcomePopup" class="overlay">
  <div class="box" style="text-align:center;">
    <h2 class="modal-title" style="margin:0 0 8px;">¡Bienvenido!</h2>
    <p>Puedes empezar a gestionar tus contactos.</p>
    <div class="actions" style="justify-content:center; margin-top:12px;">
      <button id="btnStartWelcome">Comenzar</button>
    </div>
  </div>
</div>

<!-- Popup registro correcto -->
<div id="registerPopup" class="overlay">
  <div class="box" style="text-align:center;">
    <div class="modal-head">
      <span class="modal-title">Registro completado</span>
      <button id="btnCloseRegisterPopup" class="modal-close">✕</button>
    </div>
    <p>Usuario creado. Ahora puedes iniciar sesión.</p>
  </div>
</div>

<!-- Popup recordatorio (disparo) -->
<div id="reminderPopup" class="overlay">
  <div class="box" style="text-align:center;">
    <div class="modal-head">
      <span class="modal-title">Recordatorio</span>
      <button id="btnCloseReminder" class="modal-close">✕</button>
    </div>
    <p id="reminderText" style="margin-top:6px;"></p>
    <div class="actions" style="justify-content:center; margin-top:8px;">
      <button id="btnStopRepeat" style="display:none;">Detener repetición</button>
    </div>
  </div>
</div>

<!-- Popup formulario/lista de recordatorios -->
<div id="reminderFormPopup" class="overlay">
  <div class="box">
    <div class="modal-head">
      <span class="modal-title">Recordatorios</span>
      <button id="btnCancelRemForm" style="margin-top:0px" class="modal-close" title="Cerrar">✕</button>
    </div>

    <div class="tabs">
      <button id="tabFormBtn" class="active">Programar</button>
      <button id="tabListBtn">Mis recordatorios</button>
    </div>

    <!-- Página Programar -->
    <div id="tabForm" class="tabview active">
      <div class="rem-form-grid">
        <div>
          <label for="remDate">Fecha</label>
          <input type="date" id="remDate" />
        </div>
        <div>
          <label for="remTime">Hora</label>
          <input type="time" id="remTime" />
        </div>
        <div>
          <label for="remMsg">Mensaje</label>
          <input id="remMsg" placeholder="Texto del recordatorio" />
        </div>
        <div class="rem-checks" style="grid-column: 1 / -1;">
          <label><input type="checkbox" id="notifToggle" /> Permitir notificaciones</label>
          <label><input type="checkbox" id="remRepeat" /> Repetir cada 10 minutos</label>
        </div>
      </div>
      <div class="rem-footer">
        <button id="btnScheduleRem">Programar</button>
      </div>
      <p class="muted" id="reminderStatus" style="min-height:18px; text-align:center;"></p>
    </div>

    <!-- Página Mis recordatorios -->
    <div id="tabList" class="tabview">
      <div style="overflow:auto; max-height:45vh;">
        <table>
          <thead>
            <tr>
              <th>Fecha y hora</th>
              <th>Mensaje</th>
              <th>Repite</th>
              <th>Estado</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody id="remindersTbody"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Inicio de sesión -->
<fieldset id="loginBox">
  <legend>Inicio de sesión</legend>
  <div class="auth-stack">
    <div class="field">
      <label for="username">Usuario</label>
      <input id="username" placeholder="Usuario" />
    </div>
    <div class="field">
      <label for="password">Contraseña</label>
      <input id="password" type="password" placeholder="Contraseña" />
    </div>
  </div>
  <div class="actions" style="margin-top:8px; align-items:center;">
    <button id="btnLogin">Iniciar sesión</button>
  </div>
  <a id="linkGoRegister" href="javascript:void(0)" class="muted" style="margin-left:8px;">Registrarse</a>
</fieldset>

<!-- Registro -->
<fieldset id="registerBox" style="display:none;">
  <legend>Registro</legend>
  <div class="auth-stack">
    <div class="field">
      <label for="regUsername">Usuario</label>
      <input id="regUsername" placeholder="Usuario" />
      <small id="userHintReg" class="hint">Ese usuario ya existe.</small>
    </div>
    <div class="field">
      <label for="regPassword">Contraseña</label>
      <input id="regPassword" type="password" placeholder="Contraseña" />
    </div>
  </div>
  <div class="actions" style="margin-top:8px; flex-wrap:wrap; gap:8px;">
    <button id="btnRegister">Registrarse</button>
    <button id="btnBackToLogin" type="button">Volver</button>
  </div>
</fieldset>



<!-- App -->
<div id="app" style="display:none;">
  <p style="display:flex; align-items:center; justify-content:space-between; gap:8px;">
    <span>Bienvenido, <strong id="userName"></strong></span>
    <span>
      <button id="btnExport" title="Exportar a JSON">Exportar</button>
      <button id="btnImport" title="Importar desde JSON">Importar</button>
      <input id="importFile" type="file" accept="application/json" hidden>
      <button id="btnOpenRemForm" title="Nuevo recordatorio">Nuevo recordatorio</button>
      <button id="btnLogout" title="Cerrar sesión">Cerrar sesión</button>
    </span>
  </p>

  <!-- Formulario de contacto -->
  <fieldset>
  <legend id="formLegend">Agregar contacto</legend>
  <div class="form-grid">
    <div class="field">
      <label for="contactName">Nombre *</label>
      <input id="contactName" placeholder="Nombre" />
      <small id="nameHint" class="hint">El nombre es obligatorio.</small>
    </div>
    <div class="field">
      <label for="contactPhone">Teléfono</label>
      <input id="contactPhone" placeholder="Teléfono" />
      <small id="phoneHint" class="hint">Introduce un teléfono válido.</small>
    </div>
    <div class="field">
      <label for="contactEmail">Email</label>
      <input id="contactEmail" placeholder="Email" />
      <small id="emailHint" class="hint">Introduce un email válido.</small>
    </div>
    <div class="field">
      <label for="contactCategory">Categoría *</label>
      <select id="contactCategory"></select>
      <small id="catHint" class="hint">Selecciona una categoría.</small>
    </div>
    <div class="field">
      <label for="contactCodigo">Código Mediador</label>
      <input id="contactCodigo" placeholder="Código Mediador" />
    </div>
  </div>
  <div class="actions" style="margin-top:8px;">
    <button id="btnSave">Guardar</button>
    <button id="btnClear" type="button">Limpiar</button>
    <span class="muted" id="editHint" style="display:none;">Editando contacto existente…</span>
  </div>
</fieldset>


  <!-- Acordeón Filtros (más juntos, sin “ordenar por”) -->
  <fieldset>
    <legend>Buscar y filtrar</legend>
    <div id="accordionFilterBtn" class="accordion" aria-expanded="false">
      <span id="chevronFilter" class="chevron">▼</span>
      <strong>Mostrar filtros</strong>
      
    </div>
    <div id="accordionFilterContent" class="accordion-content">
      <div>
        <div class="row">
          <div>
            <label for="filterName">Nombre</label>
            <input id="filterName" placeholder="Nombre" />
          </div>
          <div>
            <label for="filterPhone">Teléfono</label>
            <input id="filterPhone" placeholder="Teléfono" />
          </div>
          <div>
            <label for="filterEmail">Email</label>
            <input id="filterEmail" placeholder="Email" />
          </div>
          <div>
            <label for="filterCategory">Categoría</label>
            <select id="filterCategory">
              <option value="all">Todas</option>
            </select>
          </div>
        </div>
      </div>
    </div>
  </fieldset>

  <!-- Lista de contactos (sin columna propietario) -->
  <fieldset>
    <legend>Contactos</legend>
    <table>
      <thead>
        <tr>
          <th>Nombre</th>
          <th>Teléfono</th>
          <th>Email</th>
          <th>Categoría</th>
          <th>Código Mediador</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody id="contactsTbody"></tbody>
    </table>
  </fieldset>
</div>
<!-- Script nuevo SOLO para crear el cliente Supabase -->
<script type="module">
  import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

  const SUPABASE_URL = "https://euejoapezqbflobpdklk.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV1ZWpvYXBlenFiZmxvYnBka2xrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc0MTU0MTMsImV4cCI6MjA3Mjk5MTQxM30.BwK_NSGHOFjjitsjdJy0cCo9TQSwd49UjL5FoEOoaB4"; 

  // Lo guardamos en window para que el resto de scripts puedan usarlo
  window.supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
</script>
<script>
/* ---------- Estado / Utilidades ---------- */
let db; let currentUser = null; let currentEditId = null;
const DEFAULT_CATEGORIES = ["Siniestros","Grúas","Asistencia","Salud","Administraciones","Contactos","Otros"];
const reminderTimers = new Map(); let currentPopupReminderId = null;

function promisifyRequest(req){ return new Promise((res,rej)=>{ req.onsuccess=()=>res(req.result); req.onerror=()=>rej(req.error || new Error('IndexedDB request failed')); }); }
function showOverlay(id, show=true){ document.getElementById(id).style.display = show ? 'flex' : 'none'; }
function toast(msg, ms=1200){ const t=document.getElementById('toast'); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'), ms); }
function setInvalid(el,hint,inv){ if(!el)return; el.classList.toggle('invalid',!!inv); if(hint) hint.classList.toggle('show',!!inv); }
function isValidEmail(v){ if(!v) return true; return /^[^\s@]+@[^\s@]+\.[^\s@]{2,}$/.test(v.trim()); }
function isValidPhone(v){ if(!v) return true; return /^[0-9+\s\-()]{6,20}$/.test(v.trim()); }
function toggleAccordion(btnId,contentId,chevId){ const btn=document.getElementById(btnId), c=document.getElementById(contentId), ch=document.getElementById(chevId); const exp=btn.getAttribute('aria-expanded')==='true'; c.style.maxHeight = exp ? '0px' : (c.scrollHeight+'px'); btn.setAttribute('aria-expanded', String(!exp)); ch.classList.toggle('up', !exp); ch.textContent = !exp ? '▲' : '▼'; }
function switchRemTab(which='form'){ const fb=document.getElementById('tabFormBtn'), lb=document.getElementById('tabListBtn'), f=document.getElementById('tabForm'), l=document.getElementById('tabList'); const toForm = which==='form'; fb.classList.toggle('active', toForm); lb.classList.toggle('active', !toForm); f.classList.toggle('active', toForm); l.classList.toggle('active', !toForm); }


/* ---------- IndexedDB ---------- */
const dbReady = new Promise((resolve, reject) => {
  const request = indexedDB.open("GuiaTelefonica", 4);
  request.onupgradeneeded = (e) => {
    db = e.target.result;
    if(!db.objectStoreNames.contains("users")) db.createObjectStore("users",{keyPath:"username"});
    let store;
    if(!db.objectStoreNames.contains("contacts")){
      store = db.createObjectStore("contacts",{keyPath:"id",autoIncrement:true});
      store.createIndex("owner","owner",{unique:false});
      store.createIndex("name","name",{unique:false});
      store.createIndex("email","email",{unique:false});
      store.createIndex("phone","phone",{unique:false});
      store.createIndex("category","category",{unique:false});
      store.createIndex("codigo","codigo",{unique:false});
      const contacts = e.target.transaction.objectStore("contacts");
      
    } else {
      store = e.target.transaction.objectStore("contacts");
      for (const field of ["phone","email","category","codigo","name","owner"]) {
        if (!store.indexNames.contains(field)) store.createIndex(field, field, { unique:false });
      }
    }
    if(!db.objectStoreNames.contains("reminders")){
      const r = db.createObjectStore("reminders",{keyPath:"id",autoIncrement:true});
      r.createIndex("owner","owner",{unique:false});
      r.createIndex("whenTs","whenTs",{unique:false});
      r.createIndex("active","active",{unique:false});
    }
  };
  /*request.onsuccess = (e) => { db = e.target.result; resolve(); };
  request.onerror = (e) => reject(e);
  request.onblocked = () => console.warn("DB bloqueada por otra pestaña");*/
  request.onsuccess = (e) => { db = e.target.result; resolve(db); };
  request.onerror   = ()  => { reject(request.error || new Error("Failed to open DB")); };
  request.onblocked = ()  => { reject(new Error("DB open blocked by another tab/window")); };
});


/* ---------- Auth ---------- */
function normUser(u){ return (u || "").trim().toLowerCase(); }

async function userExists(u){
  await dbReady;
  const tx = db.transaction("users","readonly");
  const st = tx.objectStore("users");
  return !!(await promisifyRequest(st.get(normUser(u))));
}

async function register(){
  await dbReady;
  const uEl = document.getElementById("regUsername");
  const pEl = document.getElementById("regPassword");
  const hint = document.getElementById("userHintReg");

  const u = normUser(uEl?.value);
  const p = pEl?.value || "";

  setInvalid(uEl, hint, false);

  if(!u || !p){ alert("Completa usuario y contraseña."); return; }
  if(await userExists(u)){ setInvalid(uEl, hint, true); return; }

  try{
    await promisifyRequest(
      db.transaction("users","readwrite").objectStore("users")
        .add({ username: u, password: p })
    );
    showOverlay('registerPopup', true);
    showLogin();
  } catch(e){ alert("Error al registrar."); }
}

async function login() {
  try {
    await dbReady;

    const u = normUser(document.getElementById("username").value);
    const p = document.getElementById("password").value;

    if (!u || !p) { alert("Completa usuario y contraseña."); return; }

    const tx = db.transaction("users", "readonly");
    const store = tx.objectStore("users");
    const user = await promisifyRequest(store.get(u));

    if (!user) { alert("El usuario no existe. Regístrate primero."); return; }
    if (user.password !== p) { alert("Contraseña incorrecta."); return; }

    // === OK: login ===
    currentUser = u;
    document.getElementById("loginBox").style.display = "none";
    document.getElementById("registerBox").style.display = "none";
    document.getElementById("app").style.display = "block";
    document.getElementById("userName").textContent = u;

    resetForm();
    await refreshList();
    await refreshRemindersTable();
    await loadAndScheduleReminders();
    showOverlay('welcomePopup', true);

  } catch (err) {
    console.error('Login/DB error:', err);
    alert('No se pudo acceder a la base de datos. Revisa permisos del navegador y vuelve a intentarlo.');
  }
}


function clearAllReminderTimers(){ for (const [,e] of reminderTimers) { if(e.timeoutId) clearTimeout(e.timeoutId); if(e.intervalId) clearInterval(e.intervalId); } reminderTimers.clear(); }
function logout(){
  // Ocultar cualquier popup
  ['welcomePopup','registerPopup','reminderFormPopup'].forEach(id => showOverlay(id,false));
  document.getElementById('reminderPopup').style.display='none';

  // Cancelar timers
  clearAllReminderTimers();
  currentPopupReminderId = null;

  // Limpiar listas
  document.getElementById('contactsTbody').innerHTML = '';
  document.getElementById('remindersTbody').innerHTML = '';
  document.getElementById('reminderStatus').textContent = '';

  // Reset estado
  currentUser = null;
  currentEditId = null;
  document.getElementById('userName').textContent = '';

  // Mostrar login y ocultar registro
  document.getElementById('loginBox').style.display = 'block';
  document.getElementById('registerBox').style.display = 'none';

  // Limpiar campos de login
  document.getElementById('username').value = '';
  document.getElementById('password').value = '';

  // Ocultar la app
  document.getElementById('app').style.display = 'none';
}


function showLogin() {
  document.getElementById("loginBox").style.display = "block";
  document.getElementById("registerBox").style.display = "none";
}

function showRegister() {
  document.getElementById("loginBox").style.display = "none";
  document.getElementById("registerBox").style.display = "block";
  // limpiar estados de error del registro
  const u = document.getElementById("regUsername");
  const hint = document.getElementById("userHintReg");
  if (u) u.classList.remove("invalid");
  if (hint) hint.classList.remove("show");
}


/* ---------- Contactos ---------- */
function resetForm(){
  currentEditId=null;
  ['contactName','contactPhone','contactEmail','contactCodigo'].forEach(id=>document.getElementById(id).value='');
  document.getElementById('contactCategory').selectedIndex=0;
  ['contactName','contactEmail','contactPhone','contactCategory'].forEach(id=>setInvalid(document.getElementById(id),null,false));
  ['nameHint','emailHint','phoneHint','catHint'].forEach(id=>document.getElementById(id).classList.remove('show'));
  document.getElementById("formLegend").textContent="Agregar contacto"; document.getElementById("editHint").style.display="none"; document.getElementById("btnSave").textContent="Guardar";
}
function validateContactForm(){
  const n=document.getElementById("contactName"), e=document.getElementById("contactEmail"), t=document.getElementById("contactPhone"), c=document.getElementById("contactCategory");
  let ok=true;
  if(!n.value.trim()){ setInvalid(n, document.getElementById('nameHint'), true); ok=false; } else setInvalid(n, document.getElementById('nameHint'), false);
  if(!isValidEmail(e.value)){ setInvalid(e, document.getElementById('emailHint'), true); ok=false; } else setInvalid(e, document.getElementById('emailHint'), false);
  if(!isValidPhone(t.value)){ setInvalid(t, document.getElementById('phoneHint'), true); ok=false; } else setInvalid(t, document.getElementById('phoneHint'), false);
  if(!c.value){ setInvalid(c, document.getElementById('catHint'), true); ok=false; } else setInvalid(c, document.getElementById('catHint'), false);
  return ok;
}
async function saveContact(){
  if(!validateContactForm()) return;
  const obj={ owner: currentUser,
    name:document.getElementById("contactName").value.trim(),
    phone:document.getElementById("contactPhone").value.trim(),
    email:document.getElementById("contactEmail").value.trim(),
    category:document.getElementById("contactCategory").value.trim(),
    codigo:document.getElementById("contactCodigo").value.trim()
  };
  const st=db.transaction("contacts","readwrite").objectStore("contacts");
  if(currentEditId==null) await promisifyRequest(st.add(obj));
  else { const ex=await promisifyRequest(st.get(Number(currentEditId))); if(!ex || ex.owner!==currentUser) return alert("No puedes modificar este contacto."); Object.assign(ex,obj); await promisifyRequest(st.put(ex)); }
  resetForm(); refreshList();
}
async function editContact(id){
  const c=await promisifyRequest(db.transaction("contacts","readonly").objectStore("contacts").get(Number(id)));
  if(!c) return; if(c.owner!==currentUser) return alert("Los contactos del admin son de solo lectura.");
  currentEditId=c.id; document.getElementById("contactName").value=c.name||""; document.getElementById("contactPhone").value=c.phone||""; document.getElementById("contactEmail").value=c.email||""; document.getElementById("contactCodigo").value=c.codigo||""; document.getElementById("contactCategory").value=(c.category||"");
  document.getElementById("formLegend").textContent="Modificar contacto"; document.getElementById("editHint").style.display="inline"; document.getElementById("btnSave").textContent="Guardar cambios";
}
async function deleteContact(id){
  const c=await promisifyRequest(db.transaction("contacts","readwrite").objectStore("contacts").get(Number(id))); if(!c) return;
  if(c.owner!==currentUser) return alert("No puedes borrar contactos del admin.");
  if(!confirm(`¿Borrar "${c.name || c.phone || c.email}"?`)) return;
  await promisifyRequest(db.transaction("contacts","readwrite").objectStore("contacts").delete(c.id));
  if(currentEditId===c.id) resetForm(); refreshList();
}

/* ---------- Categorías / Filtros ---------- */
async function ensureCategoryOptions(){
  const formSel=document.getElementById("contactCategory"), filterSel=document.getElementById("filterCategory");
  const prevForm=formSel.value, prevFilter=filterSel.value;
  formSel.innerHTML=""; for(const cat of ["",...DEFAULT_CATEGORIES]){ const o=document.createElement("option"); o.value=cat; o.textContent=cat?cat:"— Selecciona —"; formSel.appendChild(o); }
  filterSel.innerHTML=""; const a=document.createElement("option"); a.value="all"; a.textContent="Todas"; filterSel.appendChild(a);
  for(const cat of DEFAULT_CATEGORIES){ const o=document.createElement("option"); o.value=cat; o.textContent=cat; filterSel.appendChild(o); }
  if([...formSel.options].some(o=>o.value===prevForm)) formSel.value=prevForm;
  if([...filterSel.options].some(o=>o.value===prevFilter)) filterSel.value=prevFilter;
}
function normalize(s){ return (s||"").toString().toLowerCase(); }
async function getAllContacts(){
  const idx=db.transaction("contacts","readonly").objectStore("contacts").index("owner");
  const mine=await promisifyRequest(idx.getAll(currentUser)); const admin=await promisifyRequest(idx.getAll("admin"));
  return [...admin.map(c=>({...c,readonly:true})), ...mine.map(c=>({...c,readonly:false}))];
}
async function getContactsForList(){
  const all=await getAllContacts();
  const fName=normalize(document.getElementById("filterName").value),
        fEmail=normalize(document.getElementById("filterEmail").value),
        fPhone=normalize(document.getElementById("filterPhone").value),
        fCategory=document.getElementById("filterCategory").value;

  let filtered=all;
  if(fName)   filtered=filtered.filter(c=>normalize(c.name).includes(fName));
  if(fEmail)  filtered=filtered.filter(c=>normalize(c.email).includes(fEmail));
  if(fPhone)  filtered=filtered.filter(c=>normalize(c.phone).includes(fPhone));
  if(fCategory && fCategory!=='all') filtered=filtered.filter(c=>(c.category||"")===fCategory);

  // Orden fijo por nombre (se elimina selector “Ordenar por”)
  filtered.sort((a,b)=>normalize(a.name).localeCompare(normalize(b.name)));
  return filtered;
}
async function refreshList(){
  await ensureCategoryOptions();
  const tbody=document.getElementById("contactsTbody"); tbody.innerHTML="";
  const rows=await getContactsForList();
  if(rows.length===0){
    const tr=document.createElement("tr"); const td=document.createElement("td");
    td.colSpan = 6; td.className="muted"; td.textContent="No hay contactos que coincidan.";
    tr.appendChild(td); tbody.appendChild(tr); return;
  }
  for(const c of rows){
    const tr=document.createElement("tr");
    const td=(t)=>{ const x=document.createElement("td"); x.textContent=t||""; return x; };
    tr.appendChild(td(c.name));
    tr.appendChild(td(c.phone));
    tr.appendChild(td(c.email));
    tr.appendChild(td(c.category));
    tr.appendChild(td(c.codigo));
    const tdActions=document.createElement("td");
    const e=document.createElement("button"); e.textContent="Modificar"; e.id = `btn-edit-${c.id}`; e.onclick=()=>editContact(c.id); e.disabled=c.readonly;
    const d=document.createElement("button"); d.textContent="Borrar"; d.id = `btn-delete-${c.id}`; d.onclick=()=>deleteContact(c.id); d.disabled=c.readonly;
    tdActions.appendChild(e); tdActions.appendChild(d); tr.appendChild(tdActions);
    tbody.appendChild(tr);
  }
}

/* ---------- Recordatorios ---------- */
async function addReminder({message,whenTs,repeat}){ return await promisifyRequest(db.transaction("reminders","readwrite").objectStore("reminders").add({owner:currentUser,message,whenTs,repeat:!!repeat,active:true})); }
async function getMyReminders(){ const all=await promisifyRequest(db.transaction("reminders","readonly").objectStore("reminders").getAll()); return all.filter(r=>r.owner===currentUser); }
async function updateReminder(rem){ await promisifyRequest(db.transaction("reminders","readwrite").objectStore("reminders").put(rem)); }
async function deleteReminder(id){ await promisifyRequest(db.transaction("reminders","readwrite").objectStore("reminders").delete(Number(id))); }
async function refreshRemindersTable(){
  const tbody=document.getElementById("remindersTbody"); tbody.innerHTML="";
  const list=await getMyReminders(); list.sort((a,b)=>a.whenTs-b.whenTs);
  if(list.length===0){ const tr=document.createElement("tr"); const td=document.createElement("td"); td.colSpan=5; td.className="muted"; td.textContent="No hay recordatorios."; tr.appendChild(td); tbody.appendChild(tr); return; }
  for(const r of list){
    const tr=document.createElement("tr"); const when=new Date(r.whenTs);
    const td=(t)=>{ const x=document.createElement("td"); x.textContent=t; return x; };
    tr.appendChild(td(when.toLocaleString())); tr.appendChild(td(r.message)); tr.appendChild(td(r.repeat?"Cada 10 min":"No"));
    const tdAct=document.createElement("td"); tdAct.innerHTML = r.active ? '<span style="color:#065f46;font-weight:600">Activo</span>' : '<span style="color:#7c2d12;font-weight:600">Inactivo</span>'; tr.appendChild(tdAct);
    const tdActions=document.createElement("td"); const tgl=document.createElement("button"); tgl.textContent=r.active?"Desactivar":"Activar"; tgl.onclick=async()=>{ await toggleReminderActive(r.id,!r.active); }; const del=document.createElement("button"); del.textContent="Borrar"; del.style.marginLeft="6px"; del.onclick=async()=>{ const e=reminderTimers.get(r.id); if(e){ if(e.timeoutId) clearTimeout(e.timeoutId); if(e.intervalId) clearInterval(e.intervalId); } reminderTimers.delete(r.id); await deleteReminder(r.id); await refreshRemindersTable(); }; tdActions.appendChild(tgl); tdActions.appendChild(del); tr.appendChild(tdActions);
    tbody.appendChild(tr);
  }
}
function sendSystemNotification(message){ try{ if('Notification'in window && Notification.permission==='granted'){ const n=new Notification('Recordatorio',{body:message}); n.onclick=()=>{ window.focus(); document.getElementById('reminderPopup').style.display='none'; }; } }catch{} }
function scheduleReminderInMemory(rem){
  const ex=reminderTimers.get(rem.id); if(ex){ if(ex.timeoutId) clearTimeout(ex.timeoutId); if(ex.intervalId) clearInterval(ex.intervalId); } reminderTimers.delete(rem.id);
  if(!rem.active) return;
  const entry={timeoutId:null,intervalId:null};
  const trigger=()=>{ currentPopupReminderId=rem.id; sendSystemNotification(rem.message); showReminderPopup(rem.message, rem.repeat);
    if(rem.repeat && rem.active){ entry.intervalId=setInterval(()=>{ currentPopupReminderId=rem.id; sendSystemNotification(rem.message); showReminderPopup(rem.message,true); }, 10*60*1000); reminderTimers.set(rem.id, entry); } };
  const diff=rem.whenTs-Date.now(); if(diff<=0) trigger(); else { entry.timeoutId=setTimeout(trigger,diff); reminderTimers.set(rem.id, entry); }
}
async function loadAndScheduleReminders(){ const list=await getMyReminders(); for(const r of list) scheduleReminderInMemory(r); }
async function toggleReminderActive(id, makeActive){
  const e=reminderTimers.get(id); if(e){ if(e.timeoutId) clearTimeout(e.timeoutId); if(e.intervalId) clearInterval(e.intervalId); } reminderTimers.delete(id);
  const list=await getMyReminders(); const rem=list.find(x=>x.id===id); if(!rem) return; rem.active=makeActive; await updateReminder(rem); if(makeActive) scheduleReminderInMemory(rem); await refreshRemindersTable();
}
async function scheduleReminder(){
  const date=document.getElementById('remDate').value, time=document.getElementById('remTime').value, msg=document.getElementById('remMsg').value.trim(), repeat=document.getElementById('remRepeat').checked;
  if(!date || !time || !msg){ alert('Completa fecha, hora y mensaje.'); return; }
  const target=new Date(`${date}T${time}`); if(isNaN(target.getTime())) return alert('Fecha u hora no válidas.'); if(target.getTime()<=Date.now()) return alert('La fecha y hora deben ser futuras.');
  const id=await addReminder({message:msg, whenTs:target.getTime(), repeat}); const list=await getMyReminders(); const rem=list.find(r=>r.id===id); if(rem) scheduleReminderInMemory(rem);
  document.getElementById('reminderStatus').textContent=`Guardado para ${target.toLocaleString()}${repeat?' (cada 10 min)':''}.`;
  setTimeout(()=>{ showOverlay('reminderFormPopup', false); document.getElementById('reminderStatus').textContent=''; document.getElementById('remDate').value=''; document.getElementById('remTime').value=''; document.getElementById('remMsg').value=''; document.getElementById('remRepeat').checked=false; toast('Recordatorio programado'); }, 700);
  await refreshRemindersTable();
}
function showReminderPopup(message,repeating){ document.getElementById('reminderText').textContent=message; document.getElementById('reminderPopup').style.display='flex'; document.getElementById('btnStopRepeat').style.display=repeating?'inline-block':'none'; }
async function stopRepeatForCurrent(){ if(currentPopupReminderId==null){ document.getElementById('reminderPopup').style.display='none'; return; } const list=await getMyReminders(); const rem=list.find(r=>r.id===currentPopupReminderId); if(rem){ rem.active=false; await updateReminder(rem); const e=reminderTimers.get(rem.id); if(e){ if(e.timeoutId) clearTimeout(e.timeoutId); if(e.intervalId) clearInterval(e.intervalId); } reminderTimers.delete(rem.id); await refreshRemindersTable(); } document.getElementById('reminderPopup').style.display='none'; currentPopupReminderId=null; }

/* ---------- Notification API ---------- */
async function requestNotificationsViaCheckbox(e){
  if(!e.target.checked) return;
  if(!('Notification' in window)){ alert('Este navegador no soporta notificaciones.'); e.target.checked=false; return; }
  if(Notification.permission==='granted'){ toast('Notificaciones activadas'); return; }
  try{ const perm=await Notification.requestPermission(); if(perm==='granted') toast('Notificaciones permitidas'); else { alert('Notificaciones no permitidas.'); e.target.checked=false; } }
  catch{ e.target.checked=false; alert('No se pudo solicitar permiso.'); }
}

/* ---------- Eventos ---------- */

// Login / Registro
document.getElementById("btnLogin").addEventListener("click", login);
document.getElementById("btnRegister").addEventListener("click", register);

const btnLogin = document.getElementById("btnLogin");
const btnRegister = document.getElementById("btnRegister");
btnLogin.disabled = true; btnRegister.disabled = true;
dbReady.finally(() => { btnLogin.disabled = false; btnRegister.disabled = false; });



document.getElementById("linkGoRegister").addEventListener("click", showRegister);

// Cuando se cierra el popup de registro, volvemos por si acaso al login
document.getElementById("btnCloseRegisterPopup").addEventListener("click", ()=> {
  showOverlay('registerPopup', false);
  showLogin();
});



function debounce(fn,wait=250){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), wait); }; }
//document.getElementById("btnRegister").addEventListener("click", register);
//document.getElementById("btnLogin").addEventListener("click", login);
document.getElementById("btnLogout").addEventListener("click", logout);

document.getElementById("btnOpenRemForm").addEventListener("click", async ()=>{ showOverlay('reminderFormPopup', true); switchRemTab('form'); await refreshRemindersTable(); });
document.getElementById("btnCancelRemForm").addEventListener("click", ()=> showOverlay('reminderFormPopup', false));
document.getElementById("tabFormBtn").addEventListener("click", ()=> switchRemTab('form'));
document.getElementById("tabListBtn").addEventListener("click", async ()=>{ switchRemTab('list'); await refreshRemindersTable(); });
document.getElementById("notifToggle").addEventListener("change", requestNotificationsViaCheckbox);

/* Nuevo: botón central para cerrar el WELCOME */
document.getElementById("btnStartWelcome").addEventListener("click", ()=> showOverlay('welcomePopup', false));

document.getElementById("btnSave").addEventListener("click", saveContact);
document.getElementById("btnClear").addEventListener("click", resetForm);
document.getElementById("btnCloseRegisterPopup").addEventListener("click", ()=> showOverlay('registerPopup', false));

document.getElementById("filterName").addEventListener("input", debounce(refreshList, 200));
document.getElementById("filterEmail").addEventListener("input", debounce(refreshList, 200));
document.getElementById("filterPhone").addEventListener("input", debounce(refreshList, 200));
document.getElementById("filterCategory").addEventListener("change", refreshList);
/* Eliminado: selector sortBy y su listener */

document.getElementById("btnScheduleRem").addEventListener("click", scheduleReminder);
document.getElementById("btnCloseReminder").addEventListener("click", ()=> document.getElementById("reminderPopup").style.display='none');
document.getElementById("btnStopRepeat").addEventListener("click", stopRepeatForCurrent);

document.getElementById("accordionFilterBtn").addEventListener("click", ()=> toggleAccordion('accordionFilterBtn','accordionFilterContent','chevronFilter'));

document.getElementById("btnBackToLogin").addEventListener("click", showLogin);


/*-EXPORTAR DATABASE-*/
async function exportDB() {
  const exportData = {};

  const storeNames = ["users", "contacts", "reminders"];
  for (const storeName of storeNames) {
    const tx = db.transaction(storeName, "readonly");
    const store = tx.objectStore(storeName);
    exportData[storeName] = await promisifyRequest(store.getAll());
  }

  // Generar el JSON como texto
  const jsonStr = JSON.stringify(exportData, null, 2);

  // Descargar como archivo
  const blob = new Blob([jsonStr], { type: "application/json" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "guia_telefonica.json";
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

/*-IMPORTAR DATABASE-*/

async function importDB(jsonData) {
  const importObj = JSON.parse(jsonData);
  const storeNames = Object.keys(importObj);

  for (const storeName of storeNames) {
    if (!db.objectStoreNames.contains(storeName)) continue;

    const tx = db.transaction(storeName, "readwrite");
    const store = tx.objectStore(storeName);

    for (const record of importObj[storeName]) {
      // Si quieres reemplazar los datos, puedes usar put en vez de add
      await promisifyRequest(store.put(record));
    }
  }
}

/* ---------- Export / Import con diálogos nativos cuando sea posible ---------- */
async function exportDB() {
  if (!currentUser) { alert("Inicia sesión primero."); return; }

  const allContacts = await getAllContacts();
  const myContacts = allContacts.filter(c => !c.readonly && c.owner === currentUser);
  const myReminders = await getMyReminders();

  const data = {
    meta: { app: "GuiaTelefonica", version: 1, exportedAt: new Date().toISOString(), user: currentUser },
    contacts: myContacts.map(({id, readonly, ...rest}) => rest),
    reminders: myReminders.map(({id, ...rest}) => rest),
  };
  const jsonStr = JSON.stringify(data, null, 2);
  const blob = new Blob([jsonStr], { type: "application/json" });

  // Intentar “Guardar como…” nativo
  if (window.showSaveFilePicker) {
    try {
      const handle = await showSaveFilePicker({
        suggestedName: `guia_telefonica_${currentUser}.json`,
        types: [{ description: "JSON", accept: { "application/json": [".json"] } }],
      });
      const writable = await handle.createWritable();
      await writable.write(blob);
      await writable.close();
      toast("Exportado correctamente");
      return;
    } catch (err) {
      if (err?.name !== "AbortError") console.warn("Fallo showSaveFilePicker, usando fallback:", err);
      // si es cancelación, simplemente salimos
      if (err?.name === "AbortError") return;
    }
  }

  // Fallback: descarga normal
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = `guia_telefonica_${currentUser}.json`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

async function importDBFromText(jsonText) {
  if (!currentUser) { alert("Inicia sesión primero."); return; }
  let data;
  try { data = JSON.parse(jsonText); } catch { alert("JSON inválido."); return; }

  const contacts = Array.isArray(data.contacts) ? data.contacts : [];
  const reminders = Array.isArray(data.reminders) ? data.reminders : [];

  const stC = db.transaction("contacts", "readwrite").objectStore("contacts");
  for (const c of contacts) {
    const rec = { ...c, owner: currentUser }; delete rec.id;
    await promisifyRequest(stC.add(rec));
  }

  const stR = db.transaction("reminders", "readwrite").objectStore("reminders");
  for (const r of reminders) {
    const rec = { ...r, owner: currentUser }; delete rec.id;
    if (typeof rec.whenTs !== "number") {
      const t = new Date(rec.whenTs).getTime();
      if (!isNaN(t)) rec.whenTs = t;
    }
    if (typeof rec.active !== "boolean") rec.active = true;
    await promisifyRequest(stR.add(rec));
  }

  await refreshList();
  await refreshRemindersTable();
  clearAllReminderTimers();
  await loadAndScheduleReminders();
  toast("Importación completada");
}

async function openImportDialog() {
  // Preferir diálogo nativo
  if (window.showOpenFilePicker) {
    try {
      const [handle] = await showOpenFilePicker({
        multiple: false,
        types: [{ description: "JSON", accept: { "application/json": [".json"] } }],
      });
      const file = await handle.getFile();
      const text = await file.text();
      await importDBFromText(text);
      return;
    } catch (err) {
      if (err?.name !== "AbortError") console.warn("Fallo showOpenFilePicker, usando fallback:", err);
      if (err?.name === "AbortError") return;
    }
  }
  // Fallback: input file oculto
  const inp = document.getElementById("importFile");
  inp.value = "";
  inp.click();
}

// Exportar con “Guardar como…” o fallback
document.getElementById("btnExport").addEventListener("click", exportDB);

// Importar con diálogo nativo o fallback input
document.getElementById("btnImport").addEventListener("click", openImportDialog);

// Fallback input file
document.getElementById("importFile").addEventListener("change", async (e) => {
  const file = e.target.files?.[0];
  if (!file) return;
  const text = await file.text();
  await importDBFromText(text);
});





</script>
</body>
</html>

